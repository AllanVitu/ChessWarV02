import{d as ke,i as _,c as i,F as U,r as Q,A as ze,u as E,R as W,x as X,w as J,K as Fe,o,b as t,t as r,I as b,h as c,_ as ye,J as j,j as _e,C as je,k as De,D as Ue,a as D,l as u,B as Ee,p as Je,v as Ve,L as qe,m as Ge,g as K,f as He,N as be}from"./index-Bh88Vxd1.js";import{l as Ke,_ as Qe}from"./brand-icon-CM8iIody.js";import{c as We}from"./auth-DB9CY__F.js";const Xe={class:"bottom-nav","aria-label":"Navigation mobile"},Ye={viewBox:"0 0 24 24","aria-hidden":"true"},Ze=["d"],et=ke({__name:"BottomNav",setup(l){const n=Fe(),h=[{label:"Dashboard",to:"/dashboard",matches:["/dashboard","/tableau-de-bord"],icon:"M4 11.5L12 5l8 6.5V20a1 1 0 0 1-1 1h-4v-6H9v6H5a1 1 0 0 1-1-1z"},{label:"Jouer",to:"/play",matches:["/play","/jeu"],icon:"M7 5h10a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2zm3 3h4v4h-4z"},{label:"Classement",to:"/leaderboard",matches:["/leaderboard","/classement"],icon:"M6 6h4v12H6zM14 3h4v15h-4zM10 10h4v8h-4z"},{label:"Profil",to:"/profile",matches:["/profile","/profil","/profil/analyse","/joueur"],icon:"M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm-7 9a7 7 0 0 1 14 0"},{label:"Parametres",to:"/settings",matches:["/settings","/parametres"],icon:"M12 7a5 5 0 1 0 5 5 5 5 0 0 0-5-5zm9 5h-2.2a7.2 7.2 0 0 0-.7-1.8l1.6-1.6-1.4-1.4-1.6 1.6a7.2 7.2 0 0 0-1.8-.7V3h-2v2.2a7.2 7.2 0 0 0-1.8.7L8.5 4.3 7.1 5.7l1.6 1.6a7.2 7.2 0 0 0-.7 1.8H5v2h2.2a7.2 7.2 0 0 0 .7 1.8l-1.6 1.6 1.4 1.4 1.6-1.6a7.2 7.2 0 0 0 1.8.7V21h2v-2.2a7.2 7.2 0 0 0 1.8-.7l1.6 1.6 1.4-1.4-1.6-1.6a7.2 7.2 0 0 0 .7-1.8H21z"}],g=f=>f.matches.some(d=>n.path===d||n.path.startsWith(`${d}/`)),O=_(()=>h.map(f=>({...f,active:g(f)})));return(f,d)=>(o(),i("nav",Xe,[(o(!0),i(U,null,Q(O.value,C=>(o(),ze(E(W),{key:C.label,to:C.to,class:X(["bottom-nav__item",C.active?"bottom-nav__item--active":""]),"aria-current":C.active?"page":void 0},{default:J(()=>[(o(),i("svg",Ye,[t("path",{d:C.icon,fill:"none",stroke:"currentColor","stroke-width":"1.6","stroke-linecap":"round"},null,8,Ze)])),t("span",null,r(C.label),1)]),_:2},1032,["to","class","aria-current"]))),128))]))}}),tt=async l=>{const n=await b(`users-search?q=${encodeURIComponent(l)}`);return n.ok?n.users??[]:[]},pa=async l=>{const n=await b(`users-profile?id=${encodeURIComponent(l)}`);return!n.ok||!n.profile?null:{...n.profile,friendStatus:n.friendStatus??"none"}},ma=async l=>{const n=await b(`users-badges?id=${encodeURIComponent(l)}`);return n.ok?n.badges??[]:[]},ya=async l=>b("friends-request",{method:"POST",body:JSON.stringify({userId:l})}),at=async(l,n)=>b("friends-respond",{method:"POST",body:JSON.stringify({userId:l,action:n})}),_a=async l=>b("friends-cancel",{method:"POST",body:JSON.stringify({userId:l})}),ba=async l=>b("friends-remove",{method:"POST",body:JSON.stringify({userId:l})}),st="/api",nt=async()=>{const l=await b("notifications-get");return{friendRequests:(l.friendRequests??[]).map(n=>({...n,isNew:n.isNew??!1})),matchInvites:(l.matchInvites??[]).map(n=>({...n,isNew:n.isNew??!1})),matchReady:(l.matchReady??[]).map(n=>({...n,isNew:n.isNew??!1}))}},ga=async(l,n="10+0",h="Aleatoire")=>b("match-invite-create",{method:"POST",body:JSON.stringify({userId:l,timeControl:n,requesterSide:h})}),ot=async(l,n)=>b("match-invite-respond",{method:"POST",body:JSON.stringify({inviteId:l,action:n})}),ne=async(l="all")=>b("notifications-read",{method:"POST",body:JSON.stringify({type:l})}),it=(l,n,h)=>{const g=new EventSource(`${st}/notifications-stream?token=${encodeURIComponent(l)}`);return g.addEventListener("notifications",O=>{try{const f=JSON.parse(O.data);n({friendRequests:(f.friendRequests??[]).map(d=>({...d,isNew:d.isNew??!1})),matchInvites:(f.matchInvites??[]).map(d=>({...d,isNew:d.isNew??!1})),matchReady:(f.matchReady??[]).map(d=>({...d,isNew:d.isNew??!1}))})}catch{}}),h&&g.addEventListener("error",h),g},lt={class:"app-shell"},rt={class:"dashboard-nav-actions"},ct={class:"toast-stack","aria-live":"polite","aria-atomic":"true"},ut={key:0,class:"toast-card",role:"status"},dt={class:"toast-main"},vt={class:"toast-sub"},ht={class:"toast-timer"},ft={id:"main-content",class:"main"},pt={class:"topbar"},mt={class:"welcome"},yt={class:"eyebrow"},_t={class:"headline"},bt={key:0,class:"subhead"},gt={class:"top-actions"},kt={class:"search"},wt={key:0,class:"search-panel"},Ct={key:0,class:"search-status"},Rt=["onMousedown"],Nt={class:"search-avatar"},Mt={class:"search-main"},St={class:"search-name"},It={class:"search-sub"},Ot={class:"search-meta"},$t={key:1,class:"search-status"},xt={class:"top-buttons"},At=["aria-expanded"],Tt={key:0,class:"notify-badge"},Lt={key:1,class:"notify-dot"},Pt={key:0,id:"match-panel",class:"notify-panel",role:"region","aria-label":"Invitations de match"},Bt={key:0,class:"notify-status"},zt={key:1,class:"notify-status notify-status--error"},Ft={class:"notify-avatar"},jt={class:"notify-main"},Dt={class:"notify-name"},Ut={class:"notify-sub"},Et={class:"notify-actions"},Jt=["onClick"],Vt=["onClick"],qt={key:2,class:"notify-status"},Gt=["aria-expanded"],Ht={key:0,class:"notify-badge"},Kt={key:1,class:"notify-dot"},Qt={key:0,id:"friend-panel",class:"notify-panel",role:"region","aria-label":"Demandes d'amis"},Wt={key:0,class:"notify-status"},Xt={key:1,class:"notify-status notify-status--error"},Yt={class:"notify-avatar"},Zt={class:"notify-main"},ea={class:"notify-name"},ta={class:"notify-actions"},aa=["onClick"],sa=["onClick"],na={key:2,class:"notify-status"},oa={class:"user-pill"},ia={class:"avatar"},la=["src"],ra={key:1},ca={class:"user-name"},ua={class:"user-meta"},ge=2,da=5,ka=ke({__name:"DashboardLayout",props:{eyebrow:{default:"Bon retour"},title:{},subtitle:{default:""}},setup(l){const n=l,h=He(),g=c(null),O=_(()=>g.value?.profile.name??"Invite"),f=_(()=>ye()&&!j()?"Mode invite":g.value?.profile.title??"Compte local"),d=_(()=>ye()&&!j()?"Quitter":"Se deconnecter"),C=[{label:"Dashboard",to:"/dashboard"},{label:"Jouer",to:"/play"},{label:"Classement",to:"/leaderboard"},{label:"Profil",to:"/profile"},{label:"Parametres",to:"/settings"}],oe=_(()=>g.value?.profile.avatarUrl??""),we=_(()=>{const s=O.value.trim();return s&&s.split(" ").filter(Boolean).slice(0,2).map(v=>v[0]?.toUpperCase()??"").join("")||"??"}),A=c(""),$=c([]),R=c(!1),w=c(""),T=c(!1),Y=c(null);let L=null,V=0;const p=c([]),m=c([]),Z=c([]),N=c(!1),y=c(""),P=c(""),q=c(!1),B=c(""),G=c(!1),M=c(!1),k=c(!1),ee=c(null),te=c(null);let I=null;const ie=_(()=>p.value.length),le=_(()=>m.value.length),Ce=_(()=>p.value.some(s=>s.isNew)),Re=_(()=>m.value.some(s=>s.isNew)),re=new Set;let z=!1;const S=c(null),x=c(0);let H=null;const ce=()=>{$.value=[],R.value=!1,w.value=""},ue=()=>{P.value="",q.value=!1},de=()=>{B.value="",G.value=!1},ae=s=>{const e=s.trim();return e&&e.split(" ").filter(Boolean).slice(0,2).map(a=>a[0]?.toUpperCase()??"").join("")||"?"},Ne=s=>s.isOnline===!0?"En ligne":s.isOnline===!1?"Hors ligne":"Statut inconnu",Me=s=>s.isOnline===!0?"presence-dot--online":s.isOnline===!1?"presence-dot--offline":"presence-dot--unknown",Se=async s=>{if(!j()){w.value="Connectez-vous pour rechercher.",$.value=[],R.value=!1;return}const e=V+=1;R.value=!0,w.value="";try{const a=await tt(s);if(e!==V)return;$.value=a,a.length||(w.value="Aucun joueur trouve.")}catch(a){if(e!==V)return;w.value=a.message,$.value=[]}finally{e===V&&(R.value=!1)}},Ie=async s=>{T.value=!1,A.value="",ce(),await h.push(`/joueur/${s.id}`)},se=async(s=!1)=>{if(s||(y.value=""),!j()){p.value=[],m.value=[],Z.value=[];return}s||(N.value=!0);try{const e=await nt();p.value=e.friendRequests,m.value=e.matchInvites,Z.value=e.matchReady,he(e.matchReady)}catch(e){s||(y.value=e.message)}finally{s||(N.value=!1)}},Oe=async()=>{try{await ne("friends"),p.value=p.value.map(s=>({...s,isNew:!1}))}catch{}},$e=async()=>{try{await ne("matches"),m.value=m.value.map(s=>({...s,isNew:!1}))}catch{}},F=()=>{H&&(clearInterval(H),H=null)},xe=()=>{try{"vibrate"in navigator&&navigator.vibrate([120,60,120])}catch{}try{const s=window.AudioContext||window.webkitAudioContext;if(!s)return;const e=new s,a=e.createOscillator(),v=e.createGain();a.type="triangle",a.frequency.value=880,v.gain.value=.06,a.connect(v),v.connect(e.destination),a.start(),setTimeout(()=>{a.stop(),e.close().catch(()=>{})},200)}catch{}},Ae=()=>{F(),S.value=null,x.value=0,z=!1},ve=async()=>{if(!S.value||z)return;const s=S.value.matchId;F(),S.value=null,x.value=0,z=!0;const e=h.currentRoute.value,a=typeof e.params.id=="string"?e.params.id:"";e.name==="play"&&a===s||(be(),k.value=!1,await h.push(`/jeu/${s}`)),z=!1},he=async s=>{if(!s.length||z)return;const e=s.find(a=>!re.has(a.matchId));if(e){re.add(e.matchId),S.value=e,x.value=da,xe();try{await ne("match-ready")}catch{}F(),H=setInterval(()=>{if(x.value<=1){ve();return}x.value-=1},1e3)}},Te=async()=>{M.value=!M.value,M.value&&(k.value=!1,ue(),await se(),await Oe())},Le=async()=>{k.value=!k.value,k.value&&(M.value=!1,de(),await se(),await $e())},fe=async(s,e)=>{ue();try{const a=await at(s.user.id,e);P.value=a.message,q.value=!a.ok,a.ok&&(p.value=p.value.filter(v=>v.id!==s.id))}catch(a){P.value=a.message,q.value=!0}},pe=async(s,e)=>{de();try{const a=await ot(s.id,e);B.value=a.message,G.value=!a.ok,a.ok&&(m.value=m.value.filter(v=>v.id!==s.id),e==="accept"&&a.matchId&&(be(),k.value=!1,await h.push(`/jeu/${a.matchId}`)))}catch(a){B.value=a.message,G.value=!0}},me=s=>{const e=s.target;e&&(Y.value&&!Y.value.contains(e)&&(T.value=!1),ee.value&&!ee.value.contains(e)&&(M.value=!1),te.value&&!te.value.contains(e)&&(k.value=!1))},Pe=_(()=>{const s=A.value.trim().length>=ge;return T.value&&(s||R.value||!!w.value)});_e(async()=>{g.value=await je(),await se();const s=j();s&&(I=it(s,e=>{p.value=e.friendRequests,m.value=e.matchInvites,Z.value=e.matchReady,he(e.matchReady),y.value&&(y.value="")},()=>{(M.value||k.value)&&(y.value="Connexion temps reel interrompue.")}))}),_e(()=>{document.addEventListener("mousedown",me)}),De(()=>{L&&clearTimeout(L),F(),I&&(I.close(),I=null),document.removeEventListener("mousedown",me)}),Ue(A,s=>{L&&clearTimeout(L);const e=s.trim();if(!e){ce();return}if(e.length<ge){$.value=[],R.value=!1,w.value="Entrez au moins 2 caracteres.";return}L=setTimeout(()=>{Se(e)},300)});const Be=async()=>{I&&(I.close(),I=null),F(),await We(),await h.push("/auth")};return(s,e)=>(o(),i(U,null,[e[14]||(e[14]=t("a",{class:"skip-link",href:"#main-content"},"Aller au contenu",-1)),t("div",lt,[D(Qe,{class:"app-navbar--dashboard",items:C,"brand-label":"WarChess","brand-logo":E(Ke)},{actions:J(()=>[t("div",rt,[D(E(W),{class:"button-ghost nav-action",to:"/matchs"},{default:J(()=>[...e[3]||(e[3]=[K("Matchs",-1)])]),_:1}),D(E(W),{class:"button-ghost nav-action",to:"/amis"},{default:J(()=>[...e[4]||(e[4]=[K("Amis",-1)])]),_:1}),D(E(W),{class:"app-navbar__link nav-action",to:"/help"},{default:J(()=>[...e[5]||(e[5]=[K("Aide & regles",-1)])]),_:1}),t("button",{class:"button-outline nav-action",type:"button",onClick:Be},r(d.value),1)])]),_:1},8,["brand-logo"]),t("div",ct,[S.value?(o(),i("div",ut,[t("div",dt,[e[6]||(e[6]=t("p",{class:"toast-title"},"Match accepte",-1)),t("p",vt,r(S.value.from.name)+" a accepte votre invitation - "+r(S.value.timeControl)+". ",1),t("p",ht,"Redirection dans "+r(x.value)+"s",1)]),t("div",{class:"toast-actions"},[t("button",{class:"button-primary",type:"button",onClick:ve},"Rejoindre"),t("button",{class:"button-ghost",type:"button",onClick:Ae},"Annuler")])])):u("",!0)]),t("main",ft,[t("header",pt,[t("div",mt,[t("p",yt,r(n.eyebrow),1),t("h1",_t,r(n.title),1),n.subtitle?(o(),i("p",bt,r(n.subtitle),1)):u("",!0)]),t("div",gt,[t("div",{ref_key:"searchGroup",ref:Y,class:"search-group"},[t("label",kt,[e[7]||(e[7]=t("svg",{viewBox:"0 0 24 24","aria-hidden":"true"},[t("circle",{cx:"11",cy:"11",r:"7",stroke:"currentColor","stroke-width":"1.6",fill:"none"}),t("path",{d:"M16.5 16.5L21 21",stroke:"currentColor","stroke-width":"1.6","stroke-linecap":"round"})],-1)),Je(t("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>A.value=a),type:"search",placeholder:"Rechercher joueurs, parties, ouvertures","aria-label":"Rechercher",onFocus:e[1]||(e[1]=a=>T.value=!0),onKeydown:e[2]||(e[2]=qe(a=>T.value=!1,["escape"]))},null,544),[[Ve,A.value]])]),Pe.value?(o(),i("div",wt,[e[8]||(e[8]=t("p",{class:"search-title"},"Joueurs",-1)),R.value?(o(),i("p",Ct,"Recherche en cours...")):u("",!0),(o(!0),i(U,null,Q($.value,a=>(o(),i("button",{key:a.id,class:"search-item",type:"button",onMousedown:Ge(v=>Ie(a),["prevent"])},[t("span",Nt,r(ae(a.name)),1),t("span",Mt,[t("span",St,r(a.name),1),t("span",It,r(a.title||"Profil public"),1)]),t("span",Ot,[t("span",{class:X(["presence-dot",Me(a)]),"aria-hidden":"true"},null,2),K(" "+r(Ne(a))+" - Elo "+r(a.rating),1)])],40,Rt))),128)),!R.value&&w.value?(o(),i("p",$t,r(w.value),1)):u("",!0)])):u("",!0)],512),t("div",xt,[t("div",{ref_key:"matchGroup",ref:te,class:"notify-group"},[t("button",{class:"icon-button notify-button",type:"button","aria-label":"Notifications de match","aria-expanded":k.value,"aria-controls":"match-panel",onClick:Le},[e[9]||(e[9]=t("svg",{viewBox:"0 0 24 24","aria-hidden":"true"},[t("path",{d:"M12 4a5 5 0 0 0-5 5v2.8l-1.4 2.2h12.8L17 11.8V9a5 5 0 0 0-5-5z",stroke:"currentColor","stroke-width":"1.6",fill:"none"}),t("path",{d:"M9.5 18a2.5 2.5 0 0 0 5 0",stroke:"currentColor","stroke-width":"1.6",fill:"none"})],-1)),le.value?(o(),i("span",Tt,r(le.value),1)):u("",!0),Re.value?(o(),i("span",Lt)):u("",!0)],8,At),k.value?(o(),i("div",Pt,[e[10]||(e[10]=t("p",{class:"notify-title"},"Invitations de match",-1)),N.value?(o(),i("p",Bt,"Chargement...")):u("",!0),!N.value&&y.value?(o(),i("p",zt,r(y.value),1)):u("",!0),(o(!0),i(U,null,Q(m.value,a=>(o(),i("div",{key:a.id,class:"notify-item"},[t("span",Ft,r(ae(a.from.name)),1),t("span",jt,[t("span",Dt,r(a.from.name),1),t("span",Ut,"Invitation de match - "+r(a.timeControl),1)]),t("span",Et,[t("button",{class:"notify-action button-primary",type:"button",onClick:v=>pe(a,"accept")}," Accepter ",8,Jt),t("button",{class:"notify-action button-ghost",type:"button",onClick:v=>pe(a,"decline")}," Refuser ",8,Vt)])]))),128)),!N.value&&!m.value.length&&!y.value?(o(),i("p",qt," Aucune invitation. ")):u("",!0),B.value?(o(),i("p",{key:3,class:X(["notify-status",G.value?"notify-status--error":"notify-status--success"])},r(B.value),3)):u("",!0)])):u("",!0)],512),t("div",{ref_key:"friendGroup",ref:ee,class:"notify-group"},[t("button",{class:"icon-button notify-button",type:"button","aria-label":"Demandes d'amis","aria-expanded":M.value,"aria-controls":"friend-panel",onClick:Te},[e[11]||(e[11]=t("svg",{viewBox:"0 0 24 24","aria-hidden":"true"},[t("path",{d:"M4 6h16v9H7l-3 3V6z",stroke:"currentColor","stroke-width":"1.6",fill:"none","stroke-linejoin":"round"})],-1)),ie.value?(o(),i("span",Ht,r(ie.value),1)):u("",!0),Ce.value?(o(),i("span",Kt)):u("",!0)],8,Gt),M.value?(o(),i("div",Qt,[e[13]||(e[13]=t("p",{class:"notify-title"},"Demandes d'amis",-1)),N.value?(o(),i("p",Wt,"Chargement...")):u("",!0),!N.value&&y.value?(o(),i("p",Xt,r(y.value),1)):u("",!0),(o(!0),i(U,null,Q(p.value,a=>(o(),i("div",{key:a.id,class:"notify-item"},[t("span",Yt,r(ae(a.user.name)),1),t("span",Zt,[t("span",ea,r(a.user.name),1),e[12]||(e[12]=t("span",{class:"notify-sub"},"Demande d'ami",-1))]),t("span",ta,[t("button",{class:"notify-action button-primary",type:"button",onClick:v=>fe(a,"accept")}," Accepter ",8,aa),t("button",{class:"notify-action button-ghost",type:"button",onClick:v=>fe(a,"decline")}," Refuser ",8,sa)])]))),128)),!N.value&&!p.value.length&&!y.value?(o(),i("p",na," Aucune demande. ")):u("",!0),P.value?(o(),i("p",{key:3,class:X(["notify-status",q.value?"notify-status--error":"notify-status--success"])},r(P.value),3)):u("",!0)])):u("",!0)],512)]),t("div",oa,[t("div",ia,[oe.value?(o(),i("img",{key:0,src:oe.value,alt:"Avatar"},null,8,la)):(o(),i("span",ra,r(we.value),1))]),t("div",null,[t("p",ca,r(O.value),1),t("p",ua,r(f.value),1)])])])]),Ee(s.$slots,"default")]),D(et)])],64))}});export{ka as _,at as a,_a as b,ga as c,ba as d,ma as e,nt as f,pa as g,ot as h,ne as m,ya as r};
