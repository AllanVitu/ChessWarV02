import{d as ke,i as _,c as i,F as q,r as W,A as Be,u as w,R as S,x as X,w as I,K as ze,o,b as t,t as r,I as b,h as c,_ as me,J as V,j as ye,C as Fe,k as je,D as De,a as N,l as u,B as Ue,p as Ee,v as Je,L as Ve,m as qe,g as M,f as Ge,N as _e}from"./index-0n7ZVvpq.js";import{l as He}from"./brand-icon-CfIn26ur.js";import{c as Ke}from"./auth-NbawEJAF.js";const Qe={class:"bottom-nav","aria-label":"Navigation mobile"},We={viewBox:"0 0 24 24","aria-hidden":"true"},Xe=["d"],Ye=ke({__name:"BottomNav",setup(l){const n=ze(),f=[{label:"Dashboard",to:"/dashboard",matches:["/dashboard","/tableau-de-bord"],icon:"M4 11.5L12 5l8 6.5V20a1 1 0 0 1-1 1h-4v-6H9v6H5a1 1 0 0 1-1-1z"},{label:"Jouer",to:"/play",matches:["/play","/jeu"],icon:"M7 5h10a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2zm3 3h4v4h-4z"},{label:"Classement",to:"/leaderboard",matches:["/leaderboard","/classement"],icon:"M6 6h4v12H6zM14 3h4v15h-4zM10 10h4v8h-4z"},{label:"Profil",to:"/profile",matches:["/profile","/profil","/profil/analyse","/joueur"],icon:"M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm-7 9a7 7 0 0 1 14 0"},{label:"Parametres",to:"/settings",matches:["/settings","/parametres"],icon:"M12 7a5 5 0 1 0 5 5 5 5 0 0 0-5-5zm9 5h-2.2a7.2 7.2 0 0 0-.7-1.8l1.6-1.6-1.4-1.4-1.6 1.6a7.2 7.2 0 0 0-1.8-.7V3h-2v2.2a7.2 7.2 0 0 0-1.8.7L8.5 4.3 7.1 5.7l1.6 1.6a7.2 7.2 0 0 0-.7 1.8H5v2h2.2a7.2 7.2 0 0 0 .7 1.8l-1.6 1.6 1.4 1.4 1.6-1.6a7.2 7.2 0 0 0 1.8.7V21h2v-2.2a7.2 7.2 0 0 0 1.8-.7l1.6 1.6 1.4-1.4-1.6-1.6a7.2 7.2 0 0 0 .7-1.8H21z"}],k=h=>h.matches.some(d=>n.path===d||n.path.startsWith(`${d}/`)),L=_(()=>f.map(h=>({...h,active:k(h)})));return(h,d)=>(o(),i("nav",Qe,[(o(!0),i(q,null,W(L.value,C=>(o(),Be(w(S),{key:C.label,to:C.to,class:X(["bottom-nav__item",C.active?"bottom-nav__item--active":""]),"aria-current":C.active?"page":void 0},{default:I(()=>[(o(),i("svg",We,[t("path",{d:C.icon,fill:"none",stroke:"currentColor","stroke-width":"1.6","stroke-linecap":"round"},null,8,Xe)])),t("span",null,r(C.label),1)]),_:2},1032,["to","class","aria-current"]))),128))]))}}),Ze=async l=>{const n=await b(`users-search?q=${encodeURIComponent(l)}`);return n.ok?n.users??[]:[]},ka=async l=>{const n=await b(`users-profile?id=${encodeURIComponent(l)}`);return!n.ok||!n.profile?null:{...n.profile,friendStatus:n.friendStatus??"none"}},ga=async l=>{const n=await b(`users-badges?id=${encodeURIComponent(l)}`);return n.ok?n.badges??[]:[]},wa=async l=>b("friends-request",{method:"POST",body:JSON.stringify({userId:l})}),et=async(l,n)=>b("friends-respond",{method:"POST",body:JSON.stringify({userId:l,action:n})}),Ca=async l=>b("friends-cancel",{method:"POST",body:JSON.stringify({userId:l})}),Ra=async l=>b("friends-remove",{method:"POST",body:JSON.stringify({userId:l})}),tt="/api",at=async()=>{const l=await b("notifications-get");return{friendRequests:(l.friendRequests??[]).map(n=>({...n,isNew:n.isNew??!1})),matchInvites:(l.matchInvites??[]).map(n=>({...n,isNew:n.isNew??!1})),matchReady:(l.matchReady??[]).map(n=>({...n,isNew:n.isNew??!1}))}},Na=async(l,n="10+0",f="Aleatoire")=>b("match-invite-create",{method:"POST",body:JSON.stringify({userId:l,timeControl:n,requesterSide:f})}),st=async(l,n)=>b("match-invite-respond",{method:"POST",body:JSON.stringify({inviteId:l,action:n})}),ne=async(l="all")=>b("notifications-read",{method:"POST",body:JSON.stringify({type:l})}),nt=(l,n,f)=>{const k=new EventSource(`${tt}/notifications-stream?token=${encodeURIComponent(l)}`);return k.addEventListener("notifications",L=>{try{const h=JSON.parse(L.data);n({friendRequests:(h.friendRequests??[]).map(d=>({...d,isNew:d.isNew??!1})),matchInvites:(h.matchInvites??[]).map(d=>({...d,isNew:d.isNew??!1})),matchReady:(h.matchReady??[]).map(d=>({...d,isNew:d.isNew??!1}))})}catch{}}),f&&k.addEventListener("error",f),k},ot={class:"app-shell"},it={class:"toast-stack","aria-live":"polite","aria-atomic":"true"},lt={key:0,class:"toast-card",role:"status"},rt={class:"toast-main"},ct={class:"toast-sub"},ut={class:"toast-timer"},dt={class:"sidebar reveal"},vt={class:"brand"},ft={class:"brand-mark"},ht=["src"],pt={class:"nav-group nav-group--primary","aria-label":"Navigation principale"},mt={class:"sidebar-card"},yt={class:"card-actions"},_t={class:"sidebar-footer"},bt={id:"main-content",class:"main"},kt={class:"topbar"},gt={class:"welcome"},wt={class:"eyebrow"},Ct={class:"headline"},Rt={key:0,class:"subhead"},Nt={class:"top-actions"},Mt={class:"search"},St={key:0,class:"search-panel"},It={key:0,class:"search-status"},Ot=["onMousedown"],xt={class:"search-avatar"},At={class:"search-main"},$t={class:"search-name"},Tt={class:"search-sub"},Lt={class:"search-meta"},Pt={key:1,class:"search-status"},Bt={class:"top-buttons"},zt=["aria-expanded"],Ft={key:0,class:"notify-badge"},jt={key:1,class:"notify-dot"},Dt={key:0,id:"match-panel",class:"notify-panel",role:"region","aria-label":"Invitations de match"},Ut={key:0,class:"notify-status"},Et={key:1,class:"notify-status notify-status--error"},Jt={class:"notify-avatar"},Vt={class:"notify-main"},qt={class:"notify-name"},Gt={class:"notify-sub"},Ht={class:"notify-actions"},Kt=["onClick"],Qt=["onClick"],Wt={key:2,class:"notify-status"},Xt=["aria-expanded"],Yt={key:0,class:"notify-badge"},Zt={key:1,class:"notify-dot"},ea={key:0,id:"friend-panel",class:"notify-panel",role:"region","aria-label":"Demandes d'amis"},ta={key:0,class:"notify-status"},aa={key:1,class:"notify-status notify-status--error"},sa={class:"notify-avatar"},na={class:"notify-main"},oa={class:"notify-name"},ia={class:"notify-actions"},la=["onClick"],ra=["onClick"],ca={key:2,class:"notify-status"},ua={class:"user-pill"},da={class:"avatar"},va=["src"],fa={key:1},ha={class:"user-name"},pa={class:"user-meta"},be=2,ma=5,Ma=ke({__name:"DashboardLayout",props:{eyebrow:{default:"Bon retour"},title:{},subtitle:{default:""}},setup(l){const n=l,f=Ge(),k=c(null),L=_(()=>k.value?.profile.name??"Invite"),h=_(()=>me()&&!V()?"Mode invite":k.value?.profile.title??"Compte local"),d=_(()=>me()&&!V()?"Quitter":"Se deconnecter"),C=_(()=>k.value?.profile.avatarUrl??""),ge=_(()=>{const s=L.value.trim();return s&&s.split(" ").filter(Boolean).slice(0,2).map(v=>v[0]?.toUpperCase()??"").join("")||"??"}),z=c(""),P=c([]),O=c(!1),R=c(""),F=c(!1),Y=c(null);let j=null,G=0;const p=c([]),m=c([]),Z=c([]),x=c(!1),y=c(""),D=c(""),H=c(!1),U=c(""),K=c(!1),A=c(!1),g=c(!1),ee=c(null),te=c(null);let T=null;const oe=_(()=>p.value.length),ie=_(()=>m.value.length),we=_(()=>p.value.some(s=>s.isNew)),Ce=_(()=>m.value.some(s=>s.isNew)),le=new Set;let E=!1;const $=c(null),B=c(0);let Q=null;const re=()=>{P.value=[],O.value=!1,R.value=""},ce=()=>{D.value="",H.value=!1},ue=()=>{U.value="",K.value=!1},ae=s=>{const e=s.trim();return e&&e.split(" ").filter(Boolean).slice(0,2).map(a=>a[0]?.toUpperCase()??"").join("")||"?"},Re=s=>s.isOnline===!0?"En ligne":s.isOnline===!1?"Hors ligne":"Statut inconnu",Ne=s=>s.isOnline===!0?"presence-dot--online":s.isOnline===!1?"presence-dot--offline":"presence-dot--unknown",Me=async s=>{if(!V()){R.value="Connectez-vous pour rechercher.",P.value=[],O.value=!1;return}const e=G+=1;O.value=!0,R.value="";try{const a=await Ze(s);if(e!==G)return;P.value=a,a.length||(R.value="Aucun joueur trouve.")}catch(a){if(e!==G)return;R.value=a.message,P.value=[]}finally{e===G&&(O.value=!1)}},Se=async s=>{F.value=!1,z.value="",re(),await f.push(`/joueur/${s.id}`)},se=async(s=!1)=>{if(s||(y.value=""),!V()){p.value=[],m.value=[],Z.value=[];return}s||(x.value=!0);try{const e=await at();p.value=e.friendRequests,m.value=e.matchInvites,Z.value=e.matchReady,ve(e.matchReady)}catch(e){s||(y.value=e.message)}finally{s||(x.value=!1)}},Ie=async()=>{try{await ne("friends"),p.value=p.value.map(s=>({...s,isNew:!1}))}catch{}},Oe=async()=>{try{await ne("matches"),m.value=m.value.map(s=>({...s,isNew:!1}))}catch{}},J=()=>{Q&&(clearInterval(Q),Q=null)},xe=()=>{try{"vibrate"in navigator&&navigator.vibrate([120,60,120])}catch{}try{const s=window.AudioContext||window.webkitAudioContext;if(!s)return;const e=new s,a=e.createOscillator(),v=e.createGain();a.type="triangle",a.frequency.value=880,v.gain.value=.06,a.connect(v),v.connect(e.destination),a.start(),setTimeout(()=>{a.stop(),e.close().catch(()=>{})},200)}catch{}},Ae=()=>{J(),$.value=null,B.value=0,E=!1},de=async()=>{if(!$.value||E)return;const s=$.value.matchId;J(),$.value=null,B.value=0,E=!0;const e=f.currentRoute.value,a=typeof e.params.id=="string"?e.params.id:"";e.name==="play"&&a===s||(_e(),g.value=!1,await f.push(`/jeu/${s}`)),E=!1},ve=async s=>{if(!s.length||E)return;const e=s.find(a=>!le.has(a.matchId));if(e){le.add(e.matchId),$.value=e,B.value=ma,xe();try{await ne("match-ready")}catch{}J(),Q=setInterval(()=>{if(B.value<=1){de();return}B.value-=1},1e3)}},$e=async()=>{A.value=!A.value,A.value&&(g.value=!1,ce(),await se(),await Ie())},Te=async()=>{g.value=!g.value,g.value&&(A.value=!1,ue(),await se(),await Oe())},fe=async(s,e)=>{ce();try{const a=await et(s.user.id,e);D.value=a.message,H.value=!a.ok,a.ok&&(p.value=p.value.filter(v=>v.id!==s.id))}catch(a){D.value=a.message,H.value=!0}},he=async(s,e)=>{ue();try{const a=await st(s.id,e);U.value=a.message,K.value=!a.ok,a.ok&&(m.value=m.value.filter(v=>v.id!==s.id),e==="accept"&&a.matchId&&(_e(),g.value=!1,await f.push(`/jeu/${a.matchId}`)))}catch(a){U.value=a.message,K.value=!0}},pe=s=>{const e=s.target;e&&(Y.value&&!Y.value.contains(e)&&(F.value=!1),ee.value&&!ee.value.contains(e)&&(A.value=!1),te.value&&!te.value.contains(e)&&(g.value=!1))},Le=_(()=>{const s=z.value.trim().length>=be;return F.value&&(s||O.value||!!R.value)});ye(async()=>{k.value=await Fe(),await se();const s=V();s&&(T=nt(s,e=>{p.value=e.friendRequests,m.value=e.matchInvites,Z.value=e.matchReady,ve(e.matchReady),y.value&&(y.value="")},()=>{(A.value||g.value)&&(y.value="Connexion temps reel interrompue.")}))}),ye(()=>{document.addEventListener("mousedown",pe)}),je(()=>{j&&clearTimeout(j),J(),T&&(T.close(),T=null),document.removeEventListener("mousedown",pe)}),De(z,s=>{j&&clearTimeout(j);const e=s.trim();if(!e){re();return}if(e.length<be){P.value=[],O.value=!1,R.value="Entrez au moins 2 caracteres.";return}j=setTimeout(()=>{Me(e)},300)});const Pe=async()=>{T&&(T.close(),T=null),J(),await Ke(),await f.push("/auth")};return(s,e)=>(o(),i(q,null,[e[22]||(e[22]=t("a",{class:"skip-link",href:"#main-content"},"Aller au contenu",-1)),t("div",ot,[t("div",it,[$.value?(o(),i("div",lt,[t("div",rt,[e[3]||(e[3]=t("p",{class:"toast-title"},"Match accepte",-1)),t("p",ct,r($.value.from.name)+" a accepte votre invitation - "+r($.value.timeControl)+". ",1),t("p",ut,"Redirection dans "+r(B.value)+"s",1)]),t("div",{class:"toast-actions"},[t("button",{class:"button-primary",type:"button",onClick:de},"Rejoindre"),t("button",{class:"button-ghost",type:"button",onClick:Ae},"Annuler")])])):u("",!0)]),t("aside",dt,[t("div",vt,[t("div",ft,[t("img",{class:"brand-logo",src:w(He),alt:"WarChess"},null,8,ht)]),e[4]||(e[4]=t("div",null,[t("p",{class:"brand-title"},"WarChess"),t("p",{class:"brand-sub"},"Operations Arena")],-1))]),t("nav",pt,[N(w(S),{to:"/dashboard",class:"nav-link","exact-active-class":"nav-link--active"},{default:I(()=>[...e[5]||(e[5]=[t("span",{class:"nav-dot"},null,-1),M(" Dashboard ",-1)])]),_:1}),N(w(S),{to:"/play",class:"nav-link","active-class":"nav-link--active"},{default:I(()=>[...e[6]||(e[6]=[t("span",{class:"nav-dot"},null,-1),M(" Jouer ",-1)])]),_:1}),N(w(S),{to:"/leaderboard",class:"nav-link","active-class":"nav-link--active"},{default:I(()=>[...e[7]||(e[7]=[t("span",{class:"nav-dot"},null,-1),M(" Classement ",-1)])]),_:1}),N(w(S),{to:"/profile",class:"nav-link","active-class":"nav-link--active"},{default:I(()=>[...e[8]||(e[8]=[t("span",{class:"nav-dot"},null,-1),M(" Profil ",-1)])]),_:1}),N(w(S),{to:"/settings",class:"nav-link","active-class":"nav-link--active"},{default:I(()=>[...e[9]||(e[9]=[t("span",{class:"nav-dot"},null,-1),M(" Parametres ",-1)])]),_:1})]),t("div",mt,[e[12]||(e[12]=t("p",{class:"card-title"},"Raccourcis",-1)),e[13]||(e[13]=t("p",{class:"card-text"},"Acces direct aux matchs et a votre reseau.",-1)),t("div",yt,[N(w(S),{class:"button-ghost",to:"/matchs"},{default:I(()=>[...e[10]||(e[10]=[M("Matchs",-1)])]),_:1}),N(w(S),{class:"button-ghost",to:"/amis"},{default:I(()=>[...e[11]||(e[11]=[M("Amis",-1)])]),_:1})])]),t("div",_t,[N(w(S),{class:"nav-link nav-link--secondary",to:"/help"},{default:I(()=>[...e[14]||(e[14]=[M(" Aide & regles ",-1)])]),_:1})]),t("button",{class:"logout",type:"button",onClick:Pe},r(d.value),1)]),t("main",bt,[t("header",kt,[t("div",gt,[t("p",wt,r(n.eyebrow),1),t("h1",Ct,r(n.title),1),n.subtitle?(o(),i("p",Rt,r(n.subtitle),1)):u("",!0)]),t("div",Nt,[t("div",{ref_key:"searchGroup",ref:Y,class:"search-group"},[t("label",Mt,[e[15]||(e[15]=t("svg",{viewBox:"0 0 24 24","aria-hidden":"true"},[t("circle",{cx:"11",cy:"11",r:"7",stroke:"currentColor","stroke-width":"1.6",fill:"none"}),t("path",{d:"M16.5 16.5L21 21",stroke:"currentColor","stroke-width":"1.6","stroke-linecap":"round"})],-1)),Ee(t("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>z.value=a),type:"search",placeholder:"Rechercher joueurs, parties, ouvertures","aria-label":"Rechercher",onFocus:e[1]||(e[1]=a=>F.value=!0),onKeydown:e[2]||(e[2]=Ve(a=>F.value=!1,["escape"]))},null,544),[[Je,z.value]])]),Le.value?(o(),i("div",St,[e[16]||(e[16]=t("p",{class:"search-title"},"Joueurs",-1)),O.value?(o(),i("p",It,"Recherche en cours...")):u("",!0),(o(!0),i(q,null,W(P.value,a=>(o(),i("button",{key:a.id,class:"search-item",type:"button",onMousedown:qe(v=>Se(a),["prevent"])},[t("span",xt,r(ae(a.name)),1),t("span",At,[t("span",$t,r(a.name),1),t("span",Tt,r(a.title||"Profil public"),1)]),t("span",Lt,[t("span",{class:X(["presence-dot",Ne(a)]),"aria-hidden":"true"},null,2),M(" "+r(Re(a))+" - Elo "+r(a.rating),1)])],40,Ot))),128)),!O.value&&R.value?(o(),i("p",Pt,r(R.value),1)):u("",!0)])):u("",!0)],512),t("div",Bt,[t("div",{ref_key:"matchGroup",ref:te,class:"notify-group"},[t("button",{class:"icon-button notify-button",type:"button","aria-label":"Notifications de match","aria-expanded":g.value,"aria-controls":"match-panel",onClick:Te},[e[17]||(e[17]=t("svg",{viewBox:"0 0 24 24","aria-hidden":"true"},[t("path",{d:"M12 4a5 5 0 0 0-5 5v2.8l-1.4 2.2h12.8L17 11.8V9a5 5 0 0 0-5-5z",stroke:"currentColor","stroke-width":"1.6",fill:"none"}),t("path",{d:"M9.5 18a2.5 2.5 0 0 0 5 0",stroke:"currentColor","stroke-width":"1.6",fill:"none"})],-1)),ie.value?(o(),i("span",Ft,r(ie.value),1)):u("",!0),Ce.value?(o(),i("span",jt)):u("",!0)],8,zt),g.value?(o(),i("div",Dt,[e[18]||(e[18]=t("p",{class:"notify-title"},"Invitations de match",-1)),x.value?(o(),i("p",Ut,"Chargement...")):u("",!0),!x.value&&y.value?(o(),i("p",Et,r(y.value),1)):u("",!0),(o(!0),i(q,null,W(m.value,a=>(o(),i("div",{key:a.id,class:"notify-item"},[t("span",Jt,r(ae(a.from.name)),1),t("span",Vt,[t("span",qt,r(a.from.name),1),t("span",Gt,"Invitation de match - "+r(a.timeControl),1)]),t("span",Ht,[t("button",{class:"notify-action button-primary",type:"button",onClick:v=>he(a,"accept")}," Accepter ",8,Kt),t("button",{class:"notify-action button-ghost",type:"button",onClick:v=>he(a,"decline")}," Refuser ",8,Qt)])]))),128)),!x.value&&!m.value.length&&!y.value?(o(),i("p",Wt," Aucune invitation. ")):u("",!0),U.value?(o(),i("p",{key:3,class:X(["notify-status",K.value?"notify-status--error":"notify-status--success"])},r(U.value),3)):u("",!0)])):u("",!0)],512),t("div",{ref_key:"friendGroup",ref:ee,class:"notify-group"},[t("button",{class:"icon-button notify-button",type:"button","aria-label":"Demandes d'amis","aria-expanded":A.value,"aria-controls":"friend-panel",onClick:$e},[e[19]||(e[19]=t("svg",{viewBox:"0 0 24 24","aria-hidden":"true"},[t("path",{d:"M4 6h16v9H7l-3 3V6z",stroke:"currentColor","stroke-width":"1.6",fill:"none","stroke-linejoin":"round"})],-1)),oe.value?(o(),i("span",Yt,r(oe.value),1)):u("",!0),we.value?(o(),i("span",Zt)):u("",!0)],8,Xt),A.value?(o(),i("div",ea,[e[21]||(e[21]=t("p",{class:"notify-title"},"Demandes d'amis",-1)),x.value?(o(),i("p",ta,"Chargement...")):u("",!0),!x.value&&y.value?(o(),i("p",aa,r(y.value),1)):u("",!0),(o(!0),i(q,null,W(p.value,a=>(o(),i("div",{key:a.id,class:"notify-item"},[t("span",sa,r(ae(a.user.name)),1),t("span",na,[t("span",oa,r(a.user.name),1),e[20]||(e[20]=t("span",{class:"notify-sub"},"Demande d'ami",-1))]),t("span",ia,[t("button",{class:"notify-action button-primary",type:"button",onClick:v=>fe(a,"accept")}," Accepter ",8,la),t("button",{class:"notify-action button-ghost",type:"button",onClick:v=>fe(a,"decline")}," Refuser ",8,ra)])]))),128)),!x.value&&!p.value.length&&!y.value?(o(),i("p",ca," Aucune demande. ")):u("",!0),D.value?(o(),i("p",{key:3,class:X(["notify-status",H.value?"notify-status--error":"notify-status--success"])},r(D.value),3)):u("",!0)])):u("",!0)],512)]),t("div",ua,[t("div",da,[C.value?(o(),i("img",{key:0,src:C.value,alt:"Avatar"},null,8,va)):(o(),i("span",fa,r(ge.value),1))]),t("div",null,[t("p",ha,r(L.value),1),t("p",pa,r(h.value),1)])])])]),Ue(s.$slots,"default")]),N(Ye)])],64))}});export{Ma as _,et as a,Ca as b,Na as c,Ra as d,ga as e,at as f,ka as g,st as h,ne as m,wa as r};
