const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./GameView-DaUPw3So.js","./index-DDgC0ReB.js","./index-UyhTMYuc.css","./auth-CjXYnRhk.js","./brand-icon-DO1QUDMu.js"])))=>i.map(i=>d[i]);
import{d as Me,i as _,c as i,F as U,r as X,A as Je,u as V,R as Y,x as Z,w as J,K as qe,o,b as t,t as l,I as b,h as c,_ as ke,J as F,j as Ce,C as Ge,k as He,D as Ke,a as j,l as u,B as Qe,p as We,v as Xe,L as Ye,m as Ze,g as W,$ as et,f as tt,N as Re}from"./index-DDgC0ReB.js";import{l as at,_ as st}from"./brand-icon-DO1QUDMu.js";import{c as nt}from"./auth-CjXYnRhk.js";const ot={class:"bottom-nav","aria-label":"Navigation mobile"},it={viewBox:"0 0 24 24","aria-hidden":"true"},rt=["d"],lt=Me({__name:"BottomNav",setup(r){const n=qe(),h=[{label:"Dashboard",to:"/dashboard",matches:["/dashboard","/tableau-de-bord"],icon:"M4 11.5L12 5l8 6.5V20a1 1 0 0 1-1 1h-4v-6H9v6H5a1 1 0 0 1-1-1z"},{label:"Jouer",to:"/play",matches:["/play","/jeu"],icon:"M7 5h10a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2zm3 3h4v4h-4z"},{label:"Classement",to:"/leaderboard",matches:["/leaderboard","/classement"],icon:"M6 6h4v12H6zM14 3h4v15h-4zM10 10h4v8h-4z"},{label:"Profil",to:"/profile",matches:["/profile","/profil","/profil/analyse","/joueur"],icon:"M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm-7 9a7 7 0 0 1 14 0"},{label:"Parametres",to:"/settings",matches:["/settings","/parametres"],icon:"M12 7a5 5 0 1 0 5 5 5 5 0 0 0-5-5zm9 5h-2.2a7.2 7.2 0 0 0-.7-1.8l1.6-1.6-1.4-1.4-1.6 1.6a7.2 7.2 0 0 0-1.8-.7V3h-2v2.2a7.2 7.2 0 0 0-1.8.7L8.5 4.3 7.1 5.7l1.6 1.6a7.2 7.2 0 0 0-.7 1.8H5v2h2.2a7.2 7.2 0 0 0 .7 1.8l-1.6 1.6 1.4 1.4 1.6-1.6a7.2 7.2 0 0 0 1.8.7V21h2v-2.2a7.2 7.2 0 0 0 1.8-.7l1.6 1.6 1.4-1.4-1.6-1.6a7.2 7.2 0 0 0 .7-1.8H21z"}],g=f=>f.matches.some(d=>n.path===d||n.path.startsWith(`${d}/`)),S=_(()=>h.map(f=>({...f,active:g(f)})));return(f,d)=>(o(),i("nav",ot,[(o(!0),i(U,null,X(S.value,C=>(o(),Je(V(Y),{key:C.label,to:C.to,class:Z(["bottom-nav__item",C.active?"bottom-nav__item--active":""]),"aria-current":C.active?"page":void 0},{default:J(()=>[(o(),i("svg",it,[t("path",{d:C.icon,fill:"none",stroke:"currentColor","stroke-width":"1.6","stroke-linecap":"round"},null,8,rt)])),t("span",null,l(C.label),1)]),_:2},1032,["to","class","aria-current"]))),128))]))}}),ct=async r=>{const n=await b(`users-search?q=${encodeURIComponent(r)}`,{cacheTtlMs:1e4});return n.ok?n.users??[]:[]},Ca=async r=>{const n=await b(`users-profile?id=${encodeURIComponent(r)}`,{cacheTtlMs:6e4});return!n.ok||!n.profile?null:{...n.profile,friendStatus:n.friendStatus??"none"}},Ra=async r=>{const n=await b(`users-badges?id=${encodeURIComponent(r)}`,{cacheTtlMs:6e4});return n.ok?n.badges??[]:[]},Na=async r=>b("friends-request",{method:"POST",body:JSON.stringify({userId:r})}),ut=async(r,n)=>b("friends-respond",{method:"POST",body:JSON.stringify({userId:r,action:n})}),Ma=async r=>b("friends-cancel",{method:"POST",body:JSON.stringify({userId:r})}),Ia=async r=>b("friends-remove",{method:"POST",body:JSON.stringify({userId:r})}),dt="/api",vt=async()=>{const r=await b("notifications-get");return{friendRequests:(r.friendRequests??[]).map(n=>({...n,isNew:n.isNew??!1})),matchInvites:(r.matchInvites??[]).map(n=>({...n,isNew:n.isNew??!1})),matchReady:(r.matchReady??[]).map(n=>({...n,isNew:n.isNew??!1}))}},Sa=async(r,n="10+0",h="Aleatoire")=>b("match-invite-create",{method:"POST",body:JSON.stringify({userId:r,timeControl:n,requesterSide:h})}),ht=async(r,n)=>b("match-invite-respond",{method:"POST",body:JSON.stringify({inviteId:r,action:n})}),ie=async(r="all")=>b("notifications-read",{method:"POST",body:JSON.stringify({type:r})}),ft=(r,n,h)=>{const g=new EventSource(`${dt}/notifications-stream?token=${encodeURIComponent(r)}`);return g.addEventListener("notifications",S=>{try{const f=JSON.parse(S.data);n({friendRequests:(f.friendRequests??[]).map(d=>({...d,isNew:d.isNew??!1})),matchInvites:(f.matchInvites??[]).map(d=>({...d,isNew:d.isNew??!1})),matchReady:(f.matchReady??[]).map(d=>({...d,isNew:d.isNew??!1}))})}catch{}}),h&&g.addEventListener("error",h),g},pt={class:"app-shell"},mt={class:"dashboard-nav-actions"},yt={class:"toast-stack","aria-live":"polite","aria-atomic":"true"},_t={key:0,class:"toast-card",role:"status"},bt={class:"toast-main"},gt={class:"toast-sub"},wt={class:"toast-timer"},kt={id:"main-content",class:"main"},Ct={class:"topbar"},Rt={class:"welcome"},Nt={class:"eyebrow"},Mt={class:"headline"},It={key:0,class:"subhead"},St={class:"top-actions"},Ot={class:"search"},Tt={key:0,class:"search-panel"},Lt={key:0,class:"search-status"},$t=["onMousedown"],Pt={class:"search-avatar"},xt={class:"search-main"},At={class:"search-name"},Et={class:"search-sub"},Bt={class:"search-meta"},zt={key:1,class:"search-status"},Dt={class:"top-buttons"},Ft=["aria-expanded"],jt={key:0,class:"notify-badge"},Ut={key:1,class:"notify-dot"},Vt={key:0,id:"match-panel",class:"notify-panel",role:"region","aria-label":"Invitations de match"},Jt={key:0,class:"notify-status"},qt={key:1,class:"notify-status notify-status--error"},Gt={class:"notify-avatar"},Ht={class:"notify-main"},Kt={class:"notify-name"},Qt={class:"notify-sub"},Wt={class:"notify-actions"},Xt=["onClick"],Yt=["onClick"],Zt={key:2,class:"notify-status"},ea=["aria-expanded"],ta={key:0,class:"notify-badge"},aa={key:1,class:"notify-dot"},sa={key:0,id:"friend-panel",class:"notify-panel",role:"region","aria-label":"Demandes d'amis"},na={key:0,class:"notify-status"},oa={key:1,class:"notify-status notify-status--error"},ia={class:"notify-avatar"},ra={class:"notify-main"},la={class:"notify-name"},ca={class:"notify-actions"},ua=["onClick"],da=["onClick"],va={key:2,class:"notify-status"},ha={class:"user-pill"},fa={class:"avatar"},pa=["src"],ma={key:1},ya={class:"user-name"},_a={class:"user-meta"},Ne=2,ba=5,Oa=Me({__name:"DashboardLayout",props:{eyebrow:{default:"Bon retour"},title:{},subtitle:{default:""}},setup(r){const n=r,h=tt(),g=c(null),S=_(()=>g.value?.profile.name??"Invite"),f=_(()=>ke()&&!F()?"Mode invite":g.value?.profile.title??"Compte local"),d=_(()=>ke()&&!F()?"Quitter":"Se deconnecter"),C=[{label:"Dashboard",to:"/dashboard"},{label:"Jouer",to:"/play"},{label:"Classement",to:"/leaderboard"},{label:"Profil",to:"/profile"},{label:"Parametres",to:"/settings"}],re=_(()=>g.value?.profile.avatarUrl??""),Ie=_(()=>{const a=S.value.trim();return a&&a.split(" ").filter(Boolean).slice(0,2).map(v=>v[0]?.toUpperCase()??"").join("")||"??"}),L=c(""),O=c([]),R=c(!1),k=c(""),$=c(!1),ee=c(null);let P=null,q=0;const p=c([]),m=c([]),te=c([]),N=c(!1),y=c(""),x=c(""),G=c(!1),A=c(""),H=c(!1),M=c(!1),w=c(!1),ae=c(null),se=c(null);let E=null;const le=_(()=>p.value.length),ce=_(()=>m.value.length),Se=_(()=>p.value.some(a=>a.isNew)),Oe=_(()=>m.value.some(a=>a.isNew)),ue=new Set;let B=!1;const I=c(null),T=c(0);let K=null;const de=()=>{O.value=[],R.value=!1,k.value=""},ve=()=>{x.value="",G.value=!1},he=()=>{A.value="",H.value=!1},ne=a=>{const e=a.trim();return e&&e.split(" ").filter(Boolean).slice(0,2).map(s=>s[0]?.toUpperCase()??"").join("")||"?"},Te=a=>a.isOnline===!0?"En ligne":a.isOnline===!1?"Hors ligne":"Statut inconnu",Le=a=>a.isOnline===!0?"presence-dot--online":a.isOnline===!1?"presence-dot--offline":"presence-dot--unknown",$e=async a=>{if(!F()){k.value="Connectez-vous pour rechercher.",O.value=[],R.value=!1;return}const e=q+=1;R.value=!0,k.value="";try{const s=await ct(a);if(e!==q)return;O.value=s,s.length||(k.value="Aucun joueur trouve.")}catch(s){if(e!==q)return;k.value=s.message,O.value=[]}finally{e===q&&(R.value=!1)}},Pe=async a=>{$.value=!1,L.value="",de(),await h.push(`/joueur/${a.id}`)},z=async(a=!1)=>{if(a||(y.value=""),!F()){p.value=[],m.value=[],te.value=[];return}a||(N.value=!0);try{const e=await vt();p.value=e.friendRequests,m.value=e.matchInvites,te.value=e.matchReady,_e(e.matchReady)}catch(e){a||(y.value=e.message)}finally{a||(N.value=!1)}},oe=()=>{if(document.hidden)return;const a=F();!a||E||(E=ft(a,e=>{p.value=e.friendRequests,m.value=e.matchInvites,te.value=e.matchReady,_e(e.matchReady),y.value&&(y.value="")},()=>{(M.value||w.value)&&(y.value="Connexion temps reel interrompue.")}))},Q=()=>{E&&(E.close(),E=null)},fe=()=>{if(document.hidden){Q();return}oe(),z(!0)},pe=()=>{document.hidden||(oe(),z(!0))},me=()=>{Q()},xe=()=>{if(typeof navigator>"u")return!1;const a=navigator.connection;return!(a?.saveData||a?.effectiveType&&/2g/.test(a.effectiveType))},Ae=()=>{if(typeof window>"u"||!xe())return;(window.requestIdleCallback??(e=>window.setTimeout(e,800)))(()=>{et(()=>import("./GameView-DaUPw3So.js"),__vite__mapDeps([0,1,2,3,4]),import.meta.url)})},Ee=async()=>{try{await ie("friends"),p.value=p.value.map(a=>({...a,isNew:!1}))}catch{}},Be=async()=>{try{await ie("matches"),m.value=m.value.map(a=>({...a,isNew:!1}))}catch{}},D=()=>{K&&(clearInterval(K),K=null)},ze=()=>{try{"vibrate"in navigator&&navigator.vibrate([120,60,120])}catch{}try{const a=window.AudioContext||window.webkitAudioContext;if(!a)return;const e=new a,s=e.createOscillator(),v=e.createGain();s.type="triangle",s.frequency.value=880,v.gain.value=.06,s.connect(v),v.connect(e.destination),s.start(),setTimeout(()=>{s.stop(),e.close().catch(()=>{})},200)}catch{}},De=()=>{D(),I.value=null,T.value=0,B=!1},ye=async()=>{if(!I.value||B)return;const a=I.value.matchId;D(),I.value=null,T.value=0,B=!0;const e=h.currentRoute.value,s=typeof e.params.id=="string"?e.params.id:"";e.name==="play"&&s===a||(Re(),w.value=!1,await h.push(`/jeu/${a}`)),B=!1},_e=async a=>{if(!a.length||B)return;const e=a.find(s=>!ue.has(s.matchId));if(e){ue.add(e.matchId),I.value=e,T.value=ba,ze();try{await ie("match-ready")}catch{}D(),K=setInterval(()=>{if(T.value<=1){ye();return}T.value-=1},1e3)}},Fe=async()=>{M.value=!M.value,M.value&&(w.value=!1,ve(),await z(),await Ee())},je=async()=>{w.value=!w.value,w.value&&(M.value=!1,he(),await z(),await Be())},be=async(a,e)=>{ve();try{const s=await ut(a.user.id,e);x.value=s.message,G.value=!s.ok,s.ok&&(p.value=p.value.filter(v=>v.id!==a.id))}catch(s){x.value=s.message,G.value=!0}},ge=async(a,e)=>{he();try{const s=await ht(a.id,e);A.value=s.message,H.value=!s.ok,s.ok&&(m.value=m.value.filter(v=>v.id!==a.id),e==="accept"&&s.matchId&&(Re(),w.value=!1,await h.push(`/jeu/${s.matchId}`)))}catch(s){A.value=s.message,H.value=!0}},we=a=>{const e=a.target;e&&(ee.value&&!ee.value.contains(e)&&($.value=!1),ae.value&&!ae.value.contains(e)&&(M.value=!1),se.value&&!se.value.contains(e)&&(w.value=!1))},Ue=_(()=>{const a=L.value.trim().length>=Ne;return $.value&&(a||R.value||!!k.value)});Ce(async()=>{g.value=await Ge(),await z(),oe(),Ae()}),Ce(()=>{document.addEventListener("mousedown",we),document.addEventListener("visibilitychange",fe),window.addEventListener("online",pe),window.addEventListener("offline",me)}),He(()=>{P&&clearTimeout(P),D(),Q(),document.removeEventListener("mousedown",we),document.removeEventListener("visibilitychange",fe),window.removeEventListener("online",pe),window.removeEventListener("offline",me)}),Ke(L,a=>{P&&clearTimeout(P);const e=a.trim();if(!e){de();return}if(e.length<Ne){O.value=[],R.value=!1,k.value="Entrez au moins 2 caracteres.";return}P=setTimeout(()=>{$e(e)},300)});const Ve=async()=>{Q(),D(),await nt(),await h.push("/auth")};return(a,e)=>(o(),i(U,null,[e[14]||(e[14]=t("a",{class:"skip-link",href:"#main-content"},"Aller au contenu",-1)),t("div",pt,[j(st,{class:"app-navbar--dashboard",items:C,"brand-label":"WarChess","brand-logo":V(at)},{actions:J(()=>[t("div",mt,[j(V(Y),{class:"button-ghost nav-action",to:"/matchs"},{default:J(()=>[...e[3]||(e[3]=[W("Matchs",-1)])]),_:1}),j(V(Y),{class:"button-ghost nav-action",to:"/amis"},{default:J(()=>[...e[4]||(e[4]=[W("Amis",-1)])]),_:1}),j(V(Y),{class:"app-navbar__link nav-action",to:"/help"},{default:J(()=>[...e[5]||(e[5]=[W("Aide & regles",-1)])]),_:1}),t("button",{class:"button-outline nav-action",type:"button",onClick:Ve},l(d.value),1)])]),_:1},8,["brand-logo"]),t("div",yt,[I.value?(o(),i("div",_t,[t("div",bt,[e[6]||(e[6]=t("p",{class:"toast-title"},"Match accepte",-1)),t("p",gt,l(I.value.from.name)+" a accepte votre invitation - "+l(I.value.timeControl)+". ",1),t("p",wt,"Redirection dans "+l(T.value)+"s",1)]),t("div",{class:"toast-actions"},[t("button",{class:"button-primary",type:"button",onClick:ye},"Rejoindre"),t("button",{class:"button-ghost",type:"button",onClick:De},"Annuler")])])):u("",!0)]),t("main",kt,[t("header",Ct,[t("div",Rt,[t("p",Nt,l(n.eyebrow),1),t("h1",Mt,l(n.title),1),n.subtitle?(o(),i("p",It,l(n.subtitle),1)):u("",!0)]),t("div",St,[t("div",{ref_key:"searchGroup",ref:ee,class:"search-group"},[t("label",Ot,[e[7]||(e[7]=t("svg",{viewBox:"0 0 24 24","aria-hidden":"true"},[t("circle",{cx:"11",cy:"11",r:"7",stroke:"currentColor","stroke-width":"1.6",fill:"none"}),t("path",{d:"M16.5 16.5L21 21",stroke:"currentColor","stroke-width":"1.6","stroke-linecap":"round"})],-1)),We(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>L.value=s),type:"search",placeholder:"Rechercher joueurs, parties, ouvertures","aria-label":"Rechercher",onFocus:e[1]||(e[1]=s=>$.value=!0),onKeydown:e[2]||(e[2]=Ye(s=>$.value=!1,["escape"]))},null,544),[[Xe,L.value]])]),Ue.value?(o(),i("div",Tt,[e[8]||(e[8]=t("p",{class:"search-title"},"Joueurs",-1)),R.value?(o(),i("p",Lt,"Recherche en cours...")):u("",!0),(o(!0),i(U,null,X(O.value,s=>(o(),i("button",{key:s.id,class:"search-item",type:"button",onMousedown:Ze(v=>Pe(s),["prevent"])},[t("span",Pt,l(ne(s.name)),1),t("span",xt,[t("span",At,l(s.name),1),t("span",Et,l(s.title||"Profil public"),1)]),t("span",Bt,[t("span",{class:Z(["presence-dot",Le(s)]),"aria-hidden":"true"},null,2),W(" "+l(Te(s))+" - Elo "+l(s.rating),1)])],40,$t))),128)),!R.value&&k.value?(o(),i("p",zt,l(k.value),1)):u("",!0)])):u("",!0)],512),t("div",Dt,[t("div",{ref_key:"matchGroup",ref:se,class:"notify-group"},[t("button",{class:"icon-button notify-button",type:"button","aria-label":"Notifications de match","aria-expanded":w.value,"aria-controls":"match-panel",onClick:je},[e[9]||(e[9]=t("svg",{viewBox:"0 0 24 24","aria-hidden":"true"},[t("path",{d:"M12 4a5 5 0 0 0-5 5v2.8l-1.4 2.2h12.8L17 11.8V9a5 5 0 0 0-5-5z",stroke:"currentColor","stroke-width":"1.6",fill:"none"}),t("path",{d:"M9.5 18a2.5 2.5 0 0 0 5 0",stroke:"currentColor","stroke-width":"1.6",fill:"none"})],-1)),ce.value?(o(),i("span",jt,l(ce.value),1)):u("",!0),Oe.value?(o(),i("span",Ut)):u("",!0)],8,Ft),w.value?(o(),i("div",Vt,[e[10]||(e[10]=t("p",{class:"notify-title"},"Invitations de match",-1)),N.value?(o(),i("p",Jt,"Chargement...")):u("",!0),!N.value&&y.value?(o(),i("p",qt,l(y.value),1)):u("",!0),(o(!0),i(U,null,X(m.value,s=>(o(),i("div",{key:s.id,class:"notify-item"},[t("span",Gt,l(ne(s.from.name)),1),t("span",Ht,[t("span",Kt,l(s.from.name),1),t("span",Qt,"Invitation de match - "+l(s.timeControl),1)]),t("span",Wt,[t("button",{class:"notify-action button-primary",type:"button",onClick:v=>ge(s,"accept")}," Accepter ",8,Xt),t("button",{class:"notify-action button-ghost",type:"button",onClick:v=>ge(s,"decline")}," Refuser ",8,Yt)])]))),128)),!N.value&&!m.value.length&&!y.value?(o(),i("p",Zt," Aucune invitation. ")):u("",!0),A.value?(o(),i("p",{key:3,class:Z(["notify-status",H.value?"notify-status--error":"notify-status--success"])},l(A.value),3)):u("",!0)])):u("",!0)],512),t("div",{ref_key:"friendGroup",ref:ae,class:"notify-group"},[t("button",{class:"icon-button notify-button",type:"button","aria-label":"Demandes d'amis","aria-expanded":M.value,"aria-controls":"friend-panel",onClick:Fe},[e[11]||(e[11]=t("svg",{viewBox:"0 0 24 24","aria-hidden":"true"},[t("path",{d:"M4 6h16v9H7l-3 3V6z",stroke:"currentColor","stroke-width":"1.6",fill:"none","stroke-linejoin":"round"})],-1)),le.value?(o(),i("span",ta,l(le.value),1)):u("",!0),Se.value?(o(),i("span",aa)):u("",!0)],8,ea),M.value?(o(),i("div",sa,[e[13]||(e[13]=t("p",{class:"notify-title"},"Demandes d'amis",-1)),N.value?(o(),i("p",na,"Chargement...")):u("",!0),!N.value&&y.value?(o(),i("p",oa,l(y.value),1)):u("",!0),(o(!0),i(U,null,X(p.value,s=>(o(),i("div",{key:s.id,class:"notify-item"},[t("span",ia,l(ne(s.user.name)),1),t("span",ra,[t("span",la,l(s.user.name),1),e[12]||(e[12]=t("span",{class:"notify-sub"},"Demande d'ami",-1))]),t("span",ca,[t("button",{class:"notify-action button-primary",type:"button",onClick:v=>be(s,"accept")}," Accepter ",8,ua),t("button",{class:"notify-action button-ghost",type:"button",onClick:v=>be(s,"decline")}," Refuser ",8,da)])]))),128)),!N.value&&!p.value.length&&!y.value?(o(),i("p",va," Aucune demande. ")):u("",!0),x.value?(o(),i("p",{key:3,class:Z(["notify-status",G.value?"notify-status--error":"notify-status--success"])},l(x.value),3)):u("",!0)])):u("",!0)],512)]),t("div",ha,[t("div",fa,[re.value?(o(),i("img",{key:0,src:re.value,alt:"Avatar",width:"36",height:"36",loading:"lazy",decoding:"async"},null,8,pa)):(o(),i("span",ma,l(Ie.value),1))]),t("div",null,[t("p",ya,l(S.value),1),t("p",_a,l(f.value),1)])])])]),Qe(a.$slots,"default")]),j(lt)])],64))}});export{Oa as _,ut as a,Ma as b,Sa as c,Ia as d,Ra as e,vt as f,Ca as g,ht as h,ie as m,Na as r};
