import{d as Ns,p as i,A as Ps,e as r,G as at,h as Ls,s as Es,w as Ts,o as f,b as a,c as p,g as w,t as v,n as A,a as Re,F as xe,C as Pt,D as Lt,J as $s,B as As,K as wa,y as Rs}from"./vendor-vue-DHDwDR0M.js";import{_ as xs,c as Fs}from"./DashboardLayout.vue_vue_type_script_setup_true_lang-wVOHqvGg.js";import{f as De,i as ka,j as Ma,k as Os,e as Ea,m as Bs,t as Fe,o as _a,p as Ds,q as Us}from"./index-DneDkzAD.js";import{C as zs,g as Js,i as Sa,c as Me,f as Et,a as Tt,b as $t,e as Ws,d as Ca,l as Gs,h as Oe,j as st}from"./engine-CJX4mt8-.js";import{b as Vs}from"./puzzles-C5G97RSN.js";import{g as Ia}from"./pieceAssets-DL4XSxcU.js";import"./brand-icon-IDKxxvz3.js";const qs=""+new URL("stockfish-18-lite-single-D0nR0yNp.js",import.meta.url).href,js=""+new URL("stockfish-18-lite-single-BRScAmIT.wasm",import.meta.url).href,Hs=11,Ks=9,Qs=36;class Xs{worker=null;started=!1;ready=!1;waitingReady=!1;waiters=[];waiterId=0;ensureWorker(){if(this.worker)return this.worker;const n=`${qs}#${encodeURIComponent(js)},worker`,c=new Worker(n);return c.addEventListener("message",l=>{const y=String(l.data??"").trim();if(!y)return;y==="uciok"&&this.waitingReady&&c.postMessage("isready"),y==="readyok"&&(this.ready=!0);const b=[];for(const k of this.waiters)k.predicate(y)?(clearTimeout(k.timeout),k.resolve(y)):b.push(k);this.waiters=b}),c.addEventListener("error",()=>{this.dispose(new Error("Stockfish indisponible."))}),this.worker=c,c}waitForLine(n,c=15e3){return new Promise((l,y)=>{const b=++this.waiterId,k=setTimeout(()=>{this.waiters=this.waiters.filter(R=>R.id!==b),y(new Error("Timeout Stockfish."))},c);this.waiters.push({id:b,predicate:n,resolve:l,reject:y,timeout:k})})}async init(){const n=this.ensureWorker();if(!this.ready){if(this.waitingReady){await this.waitForLine(c=>c==="readyok");return}this.waitingReady=!0,this.started||(this.started=!0,n.postMessage("uci")),await this.waitForLine(c=>c==="readyok")}}async evaluateFen(n,c){const l=this.ensureWorker();await this.init();let y="",b=0,k=0;const R=this.waitForLine($=>{if(!$.startsWith("info "))return!1;const se=/\bdepth\s+(\d+)/.exec($),W=/\bscore\s+(cp|mate)\s+(-?\d+)/.exec($);if(!se||!W)return!1;const I=Number.parseInt(se[1]??"0",10);if(!Number.isFinite(I)||I<k)return!1;k=I;const le=W[1],Q=Number.parseInt(W[2]??"0",10);return Number.isFinite(Q)&&(le==="cp"?b=Q:b=(Q>=0?1:-1)*(1e5-Math.min(99,Math.abs(Q))*100)),!1},2e4).catch(()=>"");l.postMessage("position fen "+n),l.postMessage("go depth "+c);const g=await this.waitForLine($=>$.startsWith("bestmove "),25e3);return y=/^bestmove\s+([a-h][1-8][a-h][1-8][qrbn]?)/.exec(g)?.[1]??"",l.postMessage("isready"),await this.waitForLine($=>$==="readyok",15e3),await R,{bestMove:y,scoreCp:b,depth:k}}dispose(n){this.worker&&this.worker.terminate(),this.worker=null,this.started=!1,this.ready=!1,this.waitingReady=!1;for(const c of this.waiters)clearTimeout(c.timeout),c.reject(n??new Error("Stockfish arrete."));this.waiters=[]}}let Be=null;const Ys=()=>(Be||(Be=new Xs),Be),Zs=u=>u<=30?"best":u<=90?"good":u<=170?"inaccuracy":u<=300?"mistake":"blunder",el=u=>{const n=/^([a-h][1-8])([a-h][1-8])([qrbn])?$/.exec(u.trim());if(!n)return null;const c=n[3];return{from:n[1]??"",to:n[2]??"",...c?{promotion:c}:{}}},Na=u=>`${u.from}${u.to}${u.promotion??""}`,tl=async u=>{const n=new zs,c=Math.max(0,u.length-Qs);for(let g=0;g<c;g+=1){const C=u[g];if(!C)continue;if(!n.move({from:C.from,to:C.to,...C.promotion?{promotion:C.promotion}:{}}))break}const l=[],y=Ys();for(let g=c;g<u.length;g+=1){const C=u[g];if(!C)continue;const $=n.turn()==="w"?"white":"black",se=n.fen(),W=await y.evaluateFen(se,Hs);if(!n.move({from:C.from,to:C.to,...C.promotion?{promotion:C.promotion}:{}}))break;const le=n.fen(),Q=await y.evaluateFen(le,Ks),de=W.scoreCp,G=-Q.scoreCp,M=Math.max(0,de-G),X=el(W.bestMove),me=X?Na(X):W.bestMove;l.push({ply:g+1,side:$,played:Na(C),best:me,cpLoss:M,scoreBefore:de,scoreAfterPlayed:G,classification:Zs(M)})}const b={best:l.filter(g=>g.classification==="best").length,good:l.filter(g=>g.classification==="good").length,inaccuracies:l.filter(g=>g.classification==="inaccuracy").length,mistakes:l.filter(g=>g.classification==="mistake").length,blunders:l.filter(g=>g.classification==="blunder").length},k=l.length?l.reduce((g,C)=>g+C.cpLoss,0)/l.length:0,R=Math.max(0,Math.min(100,Math.round(100-k/8)));return{analyzedPlies:l.length,accuracy:R,best:b.best,good:b.good,inaccuracies:b.inaccuracies,mistakes:b.mistakes,blunders:b.blunders,moves:l}},al=()=>{Be&&(Be.dispose(),Be=null)},sl="/api",Pa=(()=>{const u="".trim();return u?u.startsWith("ws://")||u.startsWith("wss://")?u:u.startsWith("https://")?`wss://${u.slice(8)}`:u.startsWith("http://")?`ws://${u.slice(7)}`:u:""})(),La=async u=>{const n=await De(`match-room-get?matchId=${encodeURIComponent(u)}`);if(!n.ok||!n.match)throw new Error("Match introuvable.");return n.match},ll=async(u,n)=>{if(ka())throw await Ma("match-move",{matchId:u,...n}),new Error("Connexion hors ligne. Coup mis en attente.");try{const c=await De("match-move-add",{method:"POST",body:JSON.stringify({matchId:u,from:n.from,to:n.to,notation:n.notation,promotion:n.promotion})});if(!c.ok||!c.match)throw new Error("Impossible de jouer le coup.");return c.match}catch(c){throw Os(c)||ka()?(await Ma("match-move",{matchId:u,...n}),new Error("Connexion instable. Coup mis en attente.")):c}},nl=async(u,n)=>{const c=await De("match-message-add",{method:"POST",body:JSON.stringify({matchId:u,message:n})});if(!c.ok||!c.match)throw new Error("Impossible d'envoyer le message.");return c.match},ol=async(u,n)=>{const c=await De("match-finish",{method:"POST",body:JSON.stringify({matchId:u,result:n})});if(!c.ok||!c.match)throw new Error("Impossible de terminer le match.");return c.match},rl=async u=>{const n=await De("match-ready",{method:"POST",body:JSON.stringify({matchId:u})});if(!n.ok||!n.match)throw new Error("Impossible de confirmer la presence.");return n.match},il=async u=>{const n=await De("match-presence",{method:"POST",body:JSON.stringify({matchId:u})});if(!n.ok||!n.match)throw new Error("Presence non enregistree.");return n.match},ul=(u,n,c)=>{const l=Ea();if(!l)return null;const y=new EventSource(`${sl}/match-stream?matchId=${encodeURIComponent(u)}&token=${encodeURIComponent(l)}`);return y.addEventListener("match",b=>{try{const k=JSON.parse(b.data);n(k)}catch{}}),c&&y.addEventListener("error",c),y},cl=(u,n,c)=>{if(!Pa)return null;const l=Ea();if(!l||!u)return null;const y=new WebSocket(Pa),b=JSON.stringify({type:"subscribe",matchId:u,token:l});return y.addEventListener("open",()=>{y.send(b)}),y.addEventListener("message",k=>{try{const R=JSON.parse(String(k.data));n(R)}catch{}}),y};let J=null,vl=0;const lt=new Map,Ta=u=>{for(const n of lt.values())n.reject(new Error(u));lt.clear()},dl=()=>typeof Worker>"u"?null:J||(J=new Worker(new URL(""+new URL("chessAiWorker-aeqgS5EU.js",import.meta.url).href,import.meta.url),{type:"module"}),J.addEventListener("message",u=>{const n=u.data,c=lt.get(n.id);c&&(lt.delete(n.id),c.resolve(n.move??null))}),J.addEventListener("error",()=>{Ta("Le moteur IA est indisponible."),J&&(J.terminate(),J=null)}),J),ml=async(u,n,c,l="equilibre")=>{const y=dl();if(!y)return Js(u,n,c,l);const b=++vl;return await new Promise((k,R)=>{lt.set(b,{resolve:k,reject:R});const g={id:b,fen:u,side:n,difficulty:c,persona:l};y.postMessage(g)})},fl=()=>{J&&(J.terminate(),J=null,Ta("Le moteur IA a ete arrete."))},pl={class:"game-layout"},hl={class:"game-stack"},yl={class:"panel game-board"},gl={class:"panel-header"},bl={class:"panel-headline"},wl={class:"badge-soft"},kl={key:0,class:"form-message form-message--success"},Ml={key:1,class:"panel-sub"},_l={key:2,class:"form-message form-message--error"},Sl={class:"player-strip"},Cl={class:"player-avatar"},Il={class:"player-info"},Nl={class:"player-name"},Pl={class:"player-avatar"},Ll={class:"player-info"},El={class:"player-name"},Tl={class:"board-wrap"},$l={class:"board"},Al={class:"board-grid",role:"grid","aria-label":"Plateau d'echecs"},Rl=["aria-label","aria-pressed","onClick"],xl=["src"],Fl={class:"panel game-actions"},Ol={key:0,class:"game-ready"},Bl={class:"panel-sub"},Dl=["disabled"],Ul=["disabled"],zl=["disabled"],Jl=["disabled"],Wl={key:2,class:"game-rematch"},Gl={class:"panel game-panel"},Vl={class:"game-info"},ql={class:"metric-label"},jl={class:"metric-value"},Hl={class:"metric-label"},Kl={class:"metric-value"},Ql={class:"metric-value"},Xl={class:"metric-value"},Yl={key:0},Zl={class:"metric-value"},en={key:1},tn={class:"metric-value"},an={key:2},sn={class:"metric-value"},ln={key:3},nn={class:"metric-value"},on={key:4},rn={class:"metric-value"},un={key:5},cn={class:"metric-value"},vn={class:"panel-subsection"},dn={class:"move-list"},mn={key:0,class:"empty-state"},fn={class:"move-ply"},pn={class:"move-side"},hn={class:"move-notation"},yn={key:1,class:"panel-subsection"},gn={class:"form-stack"},bn={class:"form-field"},wn=["value"],kn={class:"form-field"},Mn=["value"],_n={class:"form-field"},Sn={class:"form-field"},Cn={key:0,class:"form-message form-message--error"},In={key:1,class:"form-message form-message--success"},Nn={key:2,class:"form-message form-message--error"},Pn={key:3,class:"game-info"},Ln={class:"metric-value"},En={class:"metric-value"},Tn={class:"metric-value"},$n={class:"metric-value"},An={class:"panel-subsection"},Rn={class:"board-wrap"},xn={class:"board"},Fn={class:"board-grid",role:"grid","aria-label":"Board analyse"},On=["aria-label","aria-pressed","onClick"],Bn=["src"],Dn={class:"game-info"},Un={class:"metric-value"},zn={class:"metric-value"},Jn={class:"move-list"},Wn={class:"move-item"},Gn={class:"move-notation"},Vn=["onClick"],qn={key:0,class:"move-item"},jn={class:"move-notation"},Hn=["onClick"],Kn={key:1,class:"empty-state"},Qn={key:2,class:"panel-subsection match-chat"},Xn={key:0,class:"empty-state"},Yn={class:"chat-row"},Zn={class:"chat-name"},eo={class:"chat-time"},to={class:"chat-text"},ao={class:"chat-input-row"},so=["disabled","onKeydown"],lo=["disabled"],no={key:0,class:"form-message form-message--error"},_e="analysis-root",po=Ns({__name:"GameView",setup(u){const n=Ps(),c=Rs(),l=i(()=>n.params.id?String(n.params.id):""),y=r(null),b=r([]),k=r([]),R=r("white"),g=r("white"),C=r(null),$=r(null),se=r(null),W=r(null),I=r("waiting"),le=r(null),Q=r(null),de=r(null),G=r(!1),M=r(""),X=r(!1);let me=null,Se=null,pt=!1;const Ce=r(""),Ie=r(!1),Ue=r(""),fe=r(null),pe=r(""),Ne=r(!1),ne=r(""),nt=r(!1),V=r(0),q=r(0),Y=r(0),ze=r(!1),te=r(""),oe=r(!1);let ot=null;const B=r(!1),Je=r("");let We=null,At="";const Rt=r(Math.floor(Math.random()*1e3)),he=r(!1);let Ge=null;const ht=r(0),ye=r(0);let Ve=null,qe=null;const je=(()=>{const e="".trim().toLowerCase();return e==="ws"||e==="sse"||e==="poll"||e==="auto"?e:"auto"})(),x=r(null),$a=e=>/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e),xt=i(()=>$a(l.value)),re=e=>Array.isArray(e)?e[0]??"":typeof e=="string"?e:"",Ft=i(()=>re(n.query.mode).toLowerCase()),Ot=i(()=>Ft.value==="ia"?"IA":Ft.value==="histoire"?"Histoire":"Local"),Bt=i(()=>{const e=re(n.query.side);return e==="Blancs"||e==="Noirs"||e==="Aleatoire"?e:"Aleatoire"}),Dt=i(()=>{const e=re(n.query.time).trim();return e&&/^\d+(?:\+\d+)?$/.test(e)?e:"10+0"}),yt=i(()=>{const e=re(n.query.difficulty);return e==="facile"||e==="intermediaire"||e==="difficile"||e==="maitre"?e:"intermediaire"}),gt=i(()=>{const e=re(n.query.persona).toLowerCase();return e==="equilibre"||e==="agressif"||e==="solide"||e==="fou"?e:"equilibre"}),He=i(()=>{const e=Number.parseInt(re(n.query.chapter),10);return Number.isFinite(e)?e:0}),bt=i(()=>re(n.query.puzzle).trim()),D=i(()=>l.value||!bt.value?null:Vs(bt.value)),rt=i(()=>{if(D.value)return D.value.fen;const e=re(n.query.fen).trim();return e&&Sa(e)?e:Me()}),F=i(()=>l.value?xt.value?"JcJ":y.value?.mode??le.value??"JcJ":Ot.value),h=i(()=>F.value==="JcJ"),E=i(()=>F.value==="IA"||F.value==="Histoire"),Ut=i(()=>F.value==="JcJ"?"En ligne":F.value),it=i(()=>{if(E.value)return"IA";const e=y.value?.opponent??Q.value;return e||"Adversaire"}),Pe=i(()=>l.value?y.value?.timeControl??de.value??"10+0":Dt.value),Aa=i(()=>F.value==="Local"&&!E.value?"Camp joueur 1":"Votre couleur"),Ra=i(()=>F.value==="Local"&&!E.value?"Joueur 2":"Adversaire"),xa=i(()=>F.value==="Histoire"&&He.value?`Mode ${Ut.value} - Chapitre ${He.value} - Cadence ${Pe.value}`:!h.value&&D.value?`Mode Puzzle - ${D.value.title} - Cadence ${Pe.value}`:`Mode ${Ut.value} - ${it.value} - Cadence ${Pe.value}`),zt=i(()=>h.value?G.value?"Connexion au match en ligne...":X.value?"Envoi du coup...":I.value==="waiting"?"En attente des joueurs.":I.value==="ready"?ye.value>0?`Demarrage dans ${ye.value}s`:"Demarrage en cours...":I.value==="finished"||I.value==="aborted"?"Match termine. Vous pouvez proposer une revanche.":P.value===O.value?"A vous de jouer.":"En attente du coup adverse.":""),Jt=i(()=>h.value?x.value==="ws"?"WebSocket":x.value==="sse"?"SSE":x.value==="poll"?"Polling":"N/A":""),Fa=async()=>{if(Je.value)return;const e=await Us();Je.value=e?.id??""};at(l,async()=>{const e=l.value||"local";if(At!==e&&(At=e,Fe({payload:{mode:F.value}})),we(),ke(),$e(),ee(),St(),et(),ua(),b.value=[],k.value=[],M.value="",X.value=!1,R.value="white",g.value="white",C.value=null,$.value=null,se.value=null,W.value=null,I.value="waiting",le.value=null,Q.value=null,de.value=null,x.value=null,Ce.value="",Ie.value=!1,Ue.value="",pe.value="",Ne.value=!1,ne.value="",nt.value=!1,V.value=0,q.value=0,Y.value=0,ze.value=!1,te.value="",oe.value=!1,B.value=!1,ht.value=0,ye.value=0,Xe.value=!1,Te.value="",K.value=null,!l.value){y.value=null,dt();return}const t=xt.value;t&&(le.value="JcJ"),y.value=await Ds(l.value),y.value?.mode==="JcJ"?await fa():y.value?dt(!1):t&&await fa()},{immediate:!0});const Oa=i(()=>`${Ot.value}|${Bt.value}|${Dt.value}|${yt.value}|${gt.value}|${He.value}|${bt.value}|${rt.value}`);at(Oa,()=>{l.value||dt()});const Wt=i(()=>y.value?.side?y.value.side:l.value?"Aleatoire":Bt.value),O=i(()=>h.value?R.value:Wt.value==="Blancs"?"white":Wt.value==="Noirs"?"black":(l.value?Number.parseInt(l.value.slice(-1)||"0",10):Rt.value)%2===0?"white":"black"),Ke=i(()=>E.value?O.value==="white"?"black":"white":null),Z=i(()=>h.value?["finished","aborted"].includes(I.value):B.value),Gt=i(()=>h.value?O.value==="white"?$.value??"":C.value??"":""),wt=i(()=>h.value?O.value==="white"?!!se.value:!!W.value:!1),Ba=e=>{const t=e.trim(),s=/^(\d+)(?:\+(\d+))?$/.exec(t);if(!s)return{initialMs:600*1e3,incrementMs:0};const o=Math.max(1,Number.parseInt(s[1]??"10",10)),m=Math.max(0,Number.parseInt(s[2]??"0",10));return{initialMs:o*60*1e3,incrementMs:m*1e3}},kt=i(()=>Ba(Pe.value)),Vt=e=>{const t=Math.max(0,Math.ceil(e/1e3)),s=Math.floor(t/60),o=t%60;return`${s}:${o.toString().padStart(2,"0")}`},qt=e=>e<=1e4?"player-clock--danger":e<=3e4?"player-clock--warning":"",Da=i(()=>Vt(V.value)),Ua=i(()=>Vt(q.value)),jt=i(()=>h.value?I.value==="started"&&!G.value&&!X.value:!B.value),T=r(Me()),Ht=r(Et(T.value)),P=r(Tt(T.value)),j=r(null),ie=r(null),H=r([]),U=r([]),ut=i(()=>$t(T.value)),Kt=i(()=>Ws(U.value)),Qe=r(""),ct=r(""),ue=r(""),ge=r(""),Le=r(!1),Ee=r(!1),Xe=r(!1),Te=r(""),K=r(null),ce=r({}),Ye=r(_e),za=r([_e]),z=r(null);let Mt=0;const Qt=["a","b","c","d","e","f","g","h"],Xt=[8,7,6,5,4,3,2,1],Yt={p:"p",r:"r",n:"n",b:"b",q:"q",k:"k",P:"P",R:"R",N:"N",B:"B",Q:"Q",K:"K"},Zt={p:"pion noir",r:"tour noire",n:"cavalier noir",b:"fou noir",q:"dame noire",k:"roi noir",P:"pion blanc",R:"tour blanche",N:"cavalier blanc",B:"fou blanc",Q:"dame blanche",K:"roi blanc"},Ja=i(()=>Ca(T.value,P.value));at(T,e=>{Ht.value=Et(e),P.value=Tt(e)},{immediate:!0});const ea=i(()=>j.value?Ja.value.filter(e=>e.from===j.value):[]),Wa=i(()=>new Set(ea.value.map(e=>e.to))),ta=()=>(Mt+=1,`analysis-${Mt}`),Ga=()=>{Mt=0;const e={id:_e,parentId:null,fen:Me(),moveUci:null,notation:null,children:[],ply:0},t={[_e]:e},s=[_e];let o=e;for(const m of U.value){const d=st(o.fen,m);if(!d.move)break;const S=ta(),L={id:S,parentId:o.id,fen:d.fen,moveUci:`${d.move.from}${d.move.to}${d.move.promotion??""}`,notation:Oe(d.move),children:[],ply:o.ply+1};t[S]=L;const N=t[o.id];if(!N)break;N.children=[...N.children,S],s.push(S),o=L}ce.value=t,za.value=s,Ye.value=s[s.length-1]??_e,z.value=null};at(U,()=>{h.value||Ga(),ys()},{deep:!0,immediate:!0});const Ze=i(()=>ce.value[Ye.value]??{id:_e,parentId:null,fen:Me(),moveUci:null,notation:null,children:[],ply:0}),_t=i(()=>Ze.value.fen),vt=i(()=>Tt(_t.value)),Va=i(()=>Et(_t.value)),qa=i(()=>Ca(_t.value,vt.value)),aa=i(()=>z.value?qa.value.filter(e=>e.from===z.value):[]),ja=i(()=>new Set(aa.value.map(e=>e.to))),sa=i(()=>Ze.value.children.map(e=>ce.value[e]).filter(e=>!!e)),Ha=i(()=>{const e=[];let t=Ze.value;for(;t&&(e.unshift(t),!!t.parentId);)t=ce.value[t.parentId];return e}),Ka=i(()=>h.value?I.value==="started"&&!G.value&&!X.value&&P.value===O.value:B.value?!1:E.value?P.value===O.value&&!he.value:!0),la=i(()=>F.value==="Local"&&!E.value?"Joueur 1":E.value?O.value==="white"?"Vous":"IA":O.value==="white"?"Vous":it.value),na=i(()=>F.value==="Local"&&!E.value?"Joueur 2":E.value?O.value==="black"?"Vous":"IA":O.value==="black"?"Vous":it.value),oa=i(()=>({facile:"Facile",intermediaire:"Intermediaire",difficile:"Difficile",maitre:"Maitre"})[yt.value]??"Intermediaire"),ra=i(()=>({equilibre:"Equilibre",agressif:"Agressif",solide:"Solide",fou:"Chaos"})[gt.value]??"Equilibre"),Qa=i(()=>ut.value.isCheckmate?"Echec et mat":ut.value.isStalemate?"Pat":ut.value.isDraw?"Nulle":ut.value.inCheck?P.value==="white"?"Blancs en echec":"Noirs en echec":"En cours"),ia=e=>{const t=e.trim();return t&&t.split(" ").filter(Boolean).slice(0,2).map(s=>s[0]?.toUpperCase()??"").join("")||"?"},Xa=e=>{let t=Me();const s=[],o=[];let m=null;for(const d of e){const S=st(t,{from:d.from,to:d.to,promotion:d.promotion});S.move&&(t=S.fen,o.push({from:S.move.from,to:S.move.to,promotion:S.move.promotion}),s.push({ply:d.ply,side:d.side==="white"?"white":"black",notation:d.notation||Oe(S.move)}),m={from:d.from,to:d.to})}T.value=t,U.value=o,H.value=s,ie.value=m,j.value=null},ae=e=>{b.value=e.moves??[],k.value=e.messages??[];let t=e.yourSide;Je.value&&(e.whiteId&&e.whiteId===Je.value?t="white":e.blackId&&e.blackId===Je.value&&(t="black")),R.value=t??"white",g.value=e.sideToMove,C.value=e.whiteId??null,$.value=e.blackId??null,se.value=e.whiteReadyAt??null,W.value=e.blackReadyAt??null,I.value=e.status??"waiting",le.value=e.mode??"JcJ",e.opponent&&(Q.value=e.opponent),e.timeControl&&(de.value=e.timeControl),X.value=!1,Ya(e),Xa(b.value),ts(e),as(e)},be=()=>Date.now()+ht.value,Ya=e=>{if(!e.serverTime)return;const t=new Date(e.serverTime).getTime();Number.isFinite(t)&&(ht.value=t-Date.now())},ee=()=>{ot&&(clearInterval(ot),ot=null)},et=()=>{Ve&&(clearInterval(Ve),Ve=null)},ua=()=>{qe&&(clearInterval(qe),qe=null)},St=()=>{Ge&&(clearTimeout(Ge),Ge=null),he.value=!1},Ct=()=>{ze.value||(V.value===0||q.value===0)&&(ze.value=!0,vs())},ca=()=>{ee(),Y.value=h.value?be():Date.now(),ot=setInterval(()=>{if(!jt.value||Z.value){Y.value=h.value?be():Date.now();return}const e=h.value?be():Date.now(),t=e-Y.value;Y.value=e,P.value==="white"?V.value=Math.max(0,V.value-t):q.value=Math.max(0,q.value-t),Ct()},250)},Za=()=>{if(!jt.value||Z.value)return;const e=h.value?be():Date.now(),t=e-Y.value;Y.value=e,P.value==="white"?V.value=Math.max(0,V.value-t):q.value=Math.max(0,q.value-t)},es=e=>{const{incrementMs:t}=kt.value;t<=0||(e==="white"?V.value+=t:q.value+=t)},va=()=>{const{initialMs:e}=kt.value;V.value=e,q.value=e,B.value=!1,ze.value=!1,te.value="",oe.value=!1,Y.value=Date.now(),ca()},dt=(e=!0)=>{St(),ee(),T.value=rt.value,j.value=null,ie.value=null,H.value=[],U.value=[],Qe.value=rt.value===Me()?"":rt.value,ct.value="",ue.value="",ge.value="",Le.value=!1,Ee.value=!1,Xe.value=!1,Te.value="",K.value=null,e&&(Rt.value=Math.floor(Math.random()*1e3)),va(),It()},It=()=>{if(!E.value||!Ke.value||Z.value||B.value||P.value!==Ke.value||he.value)return;he.value=!0;const e=450+Math.floor(Math.random()*650);Ge=setTimeout(()=>{Ge=null,(async()=>{if(!E.value||!Ke.value){he.value=!1;return}if(Z.value||B.value||P.value!==Ke.value){he.value=!1;return}const t=await ml(T.value,Ke.value,yt.value,gt.value).catch(()=>null);if(he.value=!1,!t){B.value=!0,te.value="IA bloquee. Match termine.",oe.value=!0,ee();return}ha(t)})()},e)},ts=e=>{const{initialMs:t,incrementMs:s}=kt.value;let o=t,m=t;const d=N=>{if(!N)return null;const _=new Date(N).getTime();return Number.isFinite(_)?_:null};let L=d(e.startAt??e.createdAt)??be();for(const N of e.moves??[]){const _=d(N.createdAt);if(!_)continue;const Ae=Math.max(0,_-L);N.side==="white"?o=Math.max(0,o-Ae+s):m=Math.max(0,m-Ae+s),L=_}if(e.status==="started"){const N=Math.max(0,be()-L);e.sideToMove==="white"?o=Math.max(0,o-N):m=Math.max(0,m-N)}(!Number.isFinite(o)||!Number.isFinite(m))&&(o=t,m=t),e.status==="started"&&(!e.moves||e.moves.length===0)&&(o<=0||m<=0)&&(o=t,m=t),V.value=o,q.value=m,Y.value=Date.now(),ze.value=e.status!=="started",Ct(),e.status==="started"?ca():ee()},as=e=>{if(e.status!=="ready"||!e.startAt){ye.value=0,et();return}const t=new Date(e.startAt).getTime();if(!Number.isFinite(t)){ye.value=0,et();return}const s=()=>{const o=Math.ceil((t-be())/1e3);ye.value=Math.max(0,o),ye.value<=0&&et()};s(),Ve||(Ve=setInterval(s,250))},we=()=>{if(!Se)return;const e=Se;Se=null,e.close(),x.value==="ws"&&(x.value=null)},ke=()=>{me&&(me.close(),me=null),x.value==="sse"&&(x.value=null)},$e=()=>{We&&(clearInterval(We),We=null),x.value==="poll"&&(x.value=null)},da=async(e=!1)=>{if(!(!l.value||pt)){pt=!0;try{const t=await La(l.value);ae(t),M.value&&(M.value="")}catch(t){e||(M.value=t.message)}finally{pt=!1}}},ss=async e=>{if(!(!e||e.matchId!==l.value)){if(e.type==="state"&&e.match){ae(e.match),M.value&&(M.value="");return}if(e.type==="match-update"){await da();return}e.type==="error"&&(M.value=e.message||"Erreur temps reel.")}},ve=()=>{we(),ke(),!We&&(x.value="poll",We=setInterval(async()=>{await da(!0)},3e3))},ls=()=>{qe||!l.value||(qe=setInterval(async()=>{if(l.value)try{const e=await il(l.value);ae(e)}catch{}},8e3))},mt=()=>l.value?(we(),ke(),$e(),me=ul(l.value,e=>{ae(e),M.value&&(M.value="")},()=>{M.value||(M.value="Connexion temps reel interrompue."),ve()}),me?(x.value="sse",!0):(ve(),!1)):!1,ma=()=>{if(!l.value)return!1;we(),ke(),$e();const e=cl(l.value,s=>{ss(s)});if(!e)return!1;Se=e,x.value="ws";const t=()=>{Se===e&&(Se=null,M.value||(M.value="Connexion temps reel interrompue."),!((je==="ws"||je==="auto")&&mt())&&ve())};return e.addEventListener("error",t),e.addEventListener("close",()=>{t()}),!0},ns=()=>{if(l.value){if($e(),ke(),we(),je==="poll"){ve();return}if(je==="sse"){mt()||ve();return}if(je==="ws"){!ma()&&!mt()&&ve();return}ma()||mt()||ve()}},fa=async()=>{if(l.value){G.value=!0,M.value="",$e(),ke(),we(),await Fa();try{const e=await La(l.value);ae(e),ns(),ls()}catch(e){M.value=e.message,ve()}finally{G.value=!1}}},os=async()=>{if(!(!l.value||!h.value))try{const e=await rl(l.value);ae(e)}catch(e){M.value=e.message}},ft=(e,t)=>e?t==="white"?e===e.toUpperCase():e===e.toLowerCase():!1,pa=e=>e==="checkmate"?"Echec et mat.":e==="stalemate"?"Pat. Match nul.":e==="threefold-repetition"?"Nulle par repetition.":e==="insufficient-material"?"Nulle: materiel insuffisant.":e==="fifty-moves"?"Nulle: regle des 50 coups.":e==="draw"?"Match nul.":"Partie terminee.",rs=()=>{const e=Math.max(1,H.value.length),t=Math.max(0,Math.round(e*.05)),s=Math.max(0,Math.round(e*.12)),o=Math.max(0,e-t-s);return{accuracy:Math.max(0,Math.min(100,100-s*5-t*14)),best:o,mistakes:s,blunders:t}},tt=e=>{const t=`local-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,s=rs(),o=U.value.map(_=>({..._})),m=Kt.value,d=T.value,S=H.value.length,L=E.value?`IA ${ra.value} ${oa.value}`:"Local",N=new Date().toISOString();_a({id:t,opponent:L,result:e,opening:"Inconnue",date:N,moves:S,accuracy:s.accuracy,pgn:m,finalFen:d,review:{best:s.best,mistakes:s.mistakes,blunders:s.blunders}}),Xe.value=!0,Te.value="",K.value=null,tl(o).then(_=>{K.value=_,_a({id:t,opponent:L,result:e,opening:"Inconnue",date:N,moves:S,accuracy:_.accuracy,pgn:m,finalFen:d,review:{best:_.best+_.good,good:_.good,inaccuracies:_.inaccuracies,mistakes:_.mistakes,blunders:_.blunders}})}).catch(_=>{Te.value=_.message||"Review indisponible."}).finally(()=>{Xe.value=!1})},ha=e=>{h.value||(Za(),es(P.value),Ct());const t=st(T.value,{from:e.from,to:e.to,promotion:e.promotion});if(!t.move)return;T.value=t.fen,U.value=[...U.value,{from:t.move.from,to:t.move.to,promotion:t.move.promotion}],H.value=[...H.value,{ply:H.value.length+1,side:P.value,notation:Oe(t.move)}],ie.value={from:t.move.from,to:t.move.to},j.value=null;const s=$t(t.fen);if(!h.value&&s.isGameOver){B.value=!0,ee(),te.value=pa(s.reason),oe.value=!1,s.reason==="checkmate"&&s.winner?tt(s.winner===O.value?"win":"loss"):tt("draw"),Fe({payload:{matchId:l.value||"local",result:s.reason??"game-over"}});return}Y.value=Date.now(),!h.value&&E.value&&It()},is=async e=>{if(l.value&&I.value==="started"){X.value=!0,M.value="",ee();try{const t=await ll(l.value,{from:e.from,to:e.to,notation:Oe(e),promotion:e.promotion});ae(t)}catch(t){M.value=t.message}finally{X.value=!1}}},us=e=>{if(!e)return"";const t=new Date(e);return Number.isNaN(t.getTime())?"":t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},ya=async()=>{if(!l.value||!h.value)return;const e=Ce.value.trim();if(e){Ie.value=!0,Ue.value="";try{const t=await nl(l.value,e);ae(t),Ce.value="",await wa(),fe.value&&(fe.value.scrollTop=fe.value.scrollHeight)}catch(t){Ue.value=t.message}finally{Ie.value=!1}}},cs=async()=>{if(!Gt.value){pe.value="Adversaire introuvable.",Ne.value=!0;return}pe.value="",Ne.value=!1;try{const e=await Fs(Gt.value,Pe.value,"Aleatoire");pe.value=e.message,Ne.value=!e.ok,e.ok&&e.status==="accepted"&&e.matchId&&(Bs(),await c.push(`/jeu/${e.matchId}`))}catch(e){pe.value=e.message,Ne.value=!0}},Nt=async e=>{if(!(!l.value||!h.value)){ne.value="",nt.value=!1;try{const t=await ol(l.value,e);ae(t),e==="draw"?ne.value="Match nul enregistre.":e==="timeout"?ne.value="Temps ecoule.":ne.value="Match termine.",Fe({name:"finish_game",payload:{matchId:l.value,result:e}})}catch(t){ne.value=t.message,nt.value=!0}}},vs=async()=>{if(Z.value)return;if(ee(),h.value){await Nt("timeout");return}B.value=!0;const e=P.value;tt(e===O.value?"loss":"win"),te.value="Temps ecoule. Match termine.",oe.value=!0,Fe({payload:{matchId:l.value||"local"}})},ds=(e,t)=>{if(!Ka.value)return;if(!j.value){if(!t||!ft(t,P.value))return;j.value=e;return}if(e===j.value){j.value=null;return}const s=ea.value.find(o=>o.to===e);if(!s){t&&ft(t,P.value)&&(j.value=e);return}if(h.value){is(s);return}ha(s)},ms=async()=>{if(h.value){if(Z.value)return;await Nt("resign");return}tt("loss"),Fe({payload:{matchId:l.value||"local"}}),await c.push("/dashboard")},fs=async()=>{if(h.value){if(Z.value)return;await Nt("draw");return}tt("draw"),Fe({payload:{matchId:l.value||"local"}}),await c.push("/dashboard")},ps=()=>{h.value||dt()},hs=e=>{let t=Me();const s=[],o=[];for(const m of e){const d=st(t,m);if(!d.move)break;t=d.fen,o.push({from:d.move.from,to:d.move.to,promotion:d.move.promotion}),s.push({ply:s.length+1,side:s.length%2===0?"white":"black",notation:Oe(d.move)})}T.value=t,U.value=o,H.value=s,ie.value=s.length?{from:o[o.length-1]?.from??"",to:o[o.length-1]?.to??""}:null},ga=()=>{if(h.value)return;const e=$t(T.value);if(e.isGameOver){B.value=!0,ee(),te.value=pa(e.reason),oe.value=!1;return}B.value=!1,te.value="",oe.value=!1,va(),It()},ys=()=>{if(!D.value||h.value){ge.value="",Le.value=!1,Ee.value=!1;return}const e=U.value.map(o=>`${o.from}${o.to}${o.promotion??""}`),t=D.value.solution,s=Math.min(e.length,t.length);for(let o=0;o<s;o+=1){const m=e[o]??"",d=t[o]??"";if(m!==d){Ee.value=!1,Le.value=!0,ge.value=`Ligne incorrecte au coup ${o+1}. Attendu: ${d}.`;return}}if(e.length>=t.length){Ee.value=!0,Le.value=!1,ge.value="Puzzle resolu. Bonne ligne tactique.";return}Ee.value=!1,Le.value=!1,ge.value=`Ligne correcte (${e.length}/${t.length}).`},gs=()=>{if(h.value)return;const e=Qe.value.trim();if(!e||!Sa(e)){ue.value="FEN invalide.";return}ue.value="",T.value=e,H.value=[],U.value=[],ie.value=null,ga()},bs=()=>{if(h.value)return;const e=ct.value.trim();if(!e){ue.value="PGN vide.";return}const t=Gs(e);if(!t.ok){ue.value=t.error||"PGN invalide.";return}ue.value="";const s=t.moves.map(o=>({from:o.from,to:o.to,promotion:o.promotion}));hs(s),Qe.value=t.fen,ga()},ba=e=>{ce.value[e]&&(Ye.value=e,z.value=null)},ws=e=>{const t=Ze.value,s=st(t.fen,{from:e.from,to:e.to,promotion:e.promotion});if(!s.move)return;const o=`${s.move.from}${s.move.to}${s.move.promotion??""}`,m=t.children.map(L=>ce.value[L]).find(L=>L&&L.moveUci===o);if(m){Ye.value=m.id,z.value=null;return}const d=ta(),S={id:d,parentId:t.id,fen:s.fen,moveUci:o,notation:Oe(s.move),children:[],ply:t.ply+1};ce.value={...ce.value,[d]:S,[t.id]:{...t,children:[...t.children,d]}},Ye.value=d,z.value=null},ks=(e,t)=>{if(!z.value){if(!t||!ft(t,vt.value))return;z.value=e;return}if(z.value===e){z.value=null;return}const s=aa.value.find(o=>o.to===e);if(!s){t&&ft(t,vt.value)&&(z.value=e);return}ws(s)},Ms=i(()=>Xt.flatMap((e,t)=>Qt.map((s,o)=>{const m=Va.value[t]?.[o]??"",d=`${s}${e}`,S=(t+o)%2===1,L=m?m===m.toUpperCase()?"light":"dark":"",N=z.value===d,_=ja.value.has(d),Ae=m?`${d} ${Zt[m]??"piece"}`:`${d} vide`;return{id:d,piece:m,symbol:Yt[m]??"",image:m?Ia(m):"",dark:S,tone:L,isSelected:N,isTarget:_,ariaLabel:Ae}}))),_s=async()=>{await c.push("/dashboard")};at(()=>k.value.length,async()=>{await wa(),fe.value&&(fe.value.scrollTop=fe.value.scrollHeight)}),Ls(()=>{we(),ke(),$e(),ee(),St(),et(),ua(),fl(),al()});const Ss=i(()=>Xt.flatMap((e,t)=>Qt.map((s,o)=>{const m=Ht.value[t]?.[o]??"",d=`${s}${e}`,S=(t+o)%2===1,L=m?m===m.toUpperCase()?"light":"dark":"",N=j.value===d,_=Wa.value.has(d),Ae=ie.value?.from===d||ie.value?.to===d,Cs=ie.value?.to===d,Is=m?`${d} ${Zt[m]??"piece"}`:`${d} vide`;return{id:d,piece:m,symbol:Yt[m]??"",image:m?Ia(m):"",dark:S,tone:L,isSelected:N,isTarget:_,isLast:Ae,isArrival:Cs,ariaLabel:Is}})));return(e,t)=>(f(),Es(xs,{eyebrow:"Partie",title:`Match ${l.value||"Libre"}`,subtitle:xa.value},{default:Ts(()=>[a("section",pl,[a("div",hl,[a("div",yl,[a("div",gl,[a("div",null,[t[3]||(t[3]=a("p",{class:"panel-title"},"Plateau",-1)),a("h3",bl," Tour: "+v(P.value==="white"?"Blancs":"Noirs"),1)]),a("span",wl,v(F.value==="JcJ"?"En ligne":"Local"),1)]),zt.value?(f(),p("p",kl,v(zt.value),1)):w("",!0),h.value&&Jt.value?(f(),p("p",Ml," Transport actif: "+v(Jt.value),1)):w("",!0),M.value?(f(),p("p",_l,v(M.value),1)):w("",!0),te.value?(f(),p("p",{key:3,class:A(["form-message",oe.value?"form-message--error":"form-message--success"])},v(te.value),3)):w("",!0),a("div",Sl,[a("div",{class:A(["player-chip",P.value==="white"&&"player-chip--active"])},[a("div",Cl,v(ia(la.value)),1),a("div",Il,[a("p",Nl,v(la.value),1),t[4]||(t[4]=a("p",{class:"player-meta"},"Blancs",-1))]),a("div",{class:A(["player-clock",qt(V.value)])},v(Da.value),3)],2),t[6]||(t[6]=a("span",{class:"vs-pill"},"VS",-1)),a("div",{class:A(["player-chip",P.value==="black"&&"player-chip--active"])},[a("div",Pl,v(ia(na.value)),1),a("div",Ll,[a("p",El,v(na.value),1),t[5]||(t[5]=a("p",{class:"player-meta"},"Noirs",-1))]),a("div",{class:A(["player-clock",qt(q.value)])},v(Ua.value),3)],2)]),a("div",Tl,[a("div",$l,[a("div",Al,[(f(!0),p(xe,null,Re(Ss.value,s=>(f(),p("button",{key:s.id,type:"button",class:A(["square",s.dark?"square--dark":"square--light",s.isLast?"square--last":"",s.isArrival?"square--arrival":"",s.isSelected?"square--selected":"",s.isTarget?"square--target":""]),"aria-label":s.ariaLabel,"aria-pressed":s.isSelected,role:"gridcell",onClick:o=>ds(s.id,s.piece)},[s.piece&&s.image?(f(),p("img",{key:0,src:s.image,alt:"","aria-hidden":"true",class:A(["piece","piece-img",s.tone==="light"?"piece--light":"piece--dark",s.isArrival?"piece--impact":""])},null,10,xl)):s.piece?(f(),p("span",{key:1,class:A(["piece",s.tone==="light"?"piece--light":"piece--dark",s.isArrival?"piece--impact":""])},v(s.symbol),3)):w("",!0)],10,Rl))),128))])])])]),a("div",Fl,[t[10]||(t[10]=a("div",null,[a("p",{class:"panel-title"},"Actions"),a("h3",{class:"panel-headline"},"Fin de match"),a("p",{class:"panel-sub"},"Gerez la partie en cours en un clic.")],-1)),h.value&&(I.value==="waiting"||I.value==="ready")?(f(),p("div",Ol,[t[7]||(t[7]=a("p",{class:"panel-title"},"Synchronisation",-1)),a("p",Bl,v(wt.value?"Presence confirmee.":"Confirmez votre presence pour lancer la partie."),1),a("button",{class:"button-primary",type:"button",disabled:wt.value||G.value,onClick:os},v(wt.value?"Pret":"Je suis pret"),9,Dl)])):w("",!0),a("button",{class:"button-ghost game-action",type:"button",disabled:Z.value||h.value&&I.value!=="started",onClick:ms}," Abandonner ",8,Ul),a("button",{class:"button-ghost game-action",type:"button",disabled:Z.value||h.value&&I.value!=="started",onClick:fs}," Match Nul ",8,zl),a("button",{class:"button-ghost game-action",type:"button",disabled:h.value,onClick:ps}," Reinitialiser le match ",8,Jl),ne.value?(f(),p("p",{key:1,class:A(["form-message",nt.value?"form-message--error":"form-message--success"])},v(ne.value),3)):w("",!0),h.value&&Z.value?(f(),p("div",Wl,[t[8]||(t[8]=a("p",{class:"panel-title"},"Revanche",-1)),t[9]||(t[9]=a("p",{class:"panel-sub"}," Proposez une nouvelle partie a votre adversaire. ",-1)),a("div",{class:"game-rematch-actions"},[a("button",{class:"button-primary",type:"button",onClick:cs}," Proposer une revanche "),a("button",{class:"button-ghost",type:"button",onClick:_s}," Retour au tableau ")]),pe.value?(f(),p("p",{key:0,class:A(["form-message",Ne.value?"form-message--error":"form-message--success"])},v(pe.value),3)):w("",!0)])):w("",!0)])]),a("div",Gl,[t[36]||(t[36]=a("div",{class:"panel-header"},[a("div",null,[a("p",{class:"panel-title"},"Commandes"),a("h3",{class:"panel-headline"},"Gestion du match")])],-1)),a("div",Vl,[a("div",null,[a("p",ql,v(Aa.value),1),a("p",jl,v(O.value==="white"?"Blancs":"Noirs"),1)]),a("div",null,[a("p",Hl,v(Ra.value),1),a("p",Kl,v(it.value),1)]),a("div",null,[t[11]||(t[11]=a("p",{class:"metric-label"},"Cadence",-1)),a("p",Ql,v(Pe.value),1)]),a("div",null,[t[12]||(t[12]=a("p",{class:"metric-label"},"Etat",-1)),a("p",Xl,v(Qa.value),1)]),E.value?(f(),p("div",Yl,[t[13]||(t[13]=a("p",{class:"metric-label"},"Difficulte",-1)),a("p",Zl,v(oa.value),1)])):w("",!0),E.value?(f(),p("div",en,[t[14]||(t[14]=a("p",{class:"metric-label"},"Profil IA",-1)),a("p",tn,v(ra.value),1)])):w("",!0),F.value==="Histoire"&&He.value?(f(),p("div",an,[t[15]||(t[15]=a("p",{class:"metric-label"},"Chapitre",-1)),a("p",sn,"#"+v(He.value),1)])):w("",!0),D.value?(f(),p("div",ln,[t[16]||(t[16]=a("p",{class:"metric-label"},"Puzzle",-1)),a("p",nn,v(D.value.title),1)])):w("",!0),D.value?(f(),p("div",on,[t[17]||(t[17]=a("p",{class:"metric-label"},"Progression",-1)),a("p",rn,v(Math.min(U.value.length,D.value.solution.length))+"/"+v(D.value.solution.length),1)])):w("",!0),D.value?(f(),p("div",un,[t[18]||(t[18]=a("p",{class:"metric-label"},"Statut",-1)),a("p",cn,v(Ee.value?"Resolu":"En cours"),1)])):w("",!0)]),ge.value?(f(),p("p",{key:0,class:A(["form-message",Le.value?"form-message--error":"form-message--success"])},v(ge.value),3)):w("",!0),a("div",vn,[t[19]||(t[19]=a("p",{class:"panel-title"},"Historique",-1)),a("div",dn,[H.value.length?w("",!0):(f(),p("div",mn," Aucun coup joue. ")),(f(!0),p(xe,null,Re(H.value,s=>(f(),p("div",{key:s.ply,class:"move-item"},[a("span",fn,"#"+v(s.ply),1),a("span",pn,v(s.side==="white"?"Blancs":"Noirs"),1),a("span",hn,v(s.notation),1)]))),128))])]),h.value?w("",!0):(f(),p("div",yn,[t[34]||(t[34]=a("p",{class:"panel-title"},"Analyse (FEN / PGN)",-1)),a("div",gn,[a("label",bn,[t[20]||(t[20]=a("span",{class:"form-label"},"FEN courant",-1)),a("textarea",{class:"form-input",rows:"2",value:T.value,readonly:""},null,8,wn)]),a("label",kn,[t[21]||(t[21]=a("span",{class:"form-label"},"PGN courant",-1)),a("textarea",{class:"form-input",rows:"5",value:Kt.value,readonly:""},null,8,Mn)]),a("label",_n,[t[22]||(t[22]=a("span",{class:"form-label"},"Importer FEN",-1)),Pt(a("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>Qe.value=s),class:"form-input",type:"text",placeholder:"ex: rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"},null,512),[[Lt,Qe.value]])]),a("button",{class:"button-ghost game-action",type:"button",onClick:gs}," Charger FEN "),a("label",Sn,[t[23]||(t[23]=a("span",{class:"form-label"},"Importer PGN",-1)),Pt(a("textarea",{"onUpdate:modelValue":t[1]||(t[1]=s=>ct.value=s),class:"form-input",rows:"4",placeholder:"Collez un PGN complet"},null,512),[[Lt,ct.value]])]),a("button",{class:"button-ghost game-action",type:"button",onClick:bs}," Charger PGN "),ue.value?(f(),p("p",Cn,v(ue.value),1)):w("",!0),Xe.value?(f(),p("p",In," Analyse Stockfish en cours... ")):w("",!0),Te.value?(f(),p("p",Nn,v(Te.value),1)):w("",!0),K.value?(f(),p("div",Pn,[a("div",null,[t[24]||(t[24]=a("p",{class:"metric-label"},"Precision",-1)),a("p",Ln,v(K.value.accuracy)+"%",1)]),a("div",null,[t[25]||(t[25]=a("p",{class:"metric-label"},"Best / Good",-1)),a("p",En,v(K.value.best)+" / "+v(K.value.good),1)]),a("div",null,[t[26]||(t[26]=a("p",{class:"metric-label"},"Inexactitudes",-1)),a("p",Tn,v(K.value.inaccuracies),1)]),a("div",null,[t[27]||(t[27]=a("p",{class:"metric-label"},"Erreurs / Gaffes",-1)),a("p",$n,v(K.value.mistakes)+" / "+v(K.value.blunders),1)])])):w("",!0),a("div",An,[t[32]||(t[32]=a("p",{class:"panel-title"},"Board d'analyse (variantes)",-1)),t[33]||(t[33]=a("p",{class:"panel-sub"}," Cliquez les cases pour explorer une ligne. Un coup non present cree une nouvelle variante. ",-1)),a("div",Rn,[a("div",xn,[a("div",Fn,[(f(!0),p(xe,null,Re(Ms.value,s=>(f(),p("button",{key:`analysis-${s.id}`,type:"button",class:A(["square",s.dark?"square--dark":"square--light",s.isSelected?"square--selected":"",s.isTarget?"square--target":""]),"aria-label":s.ariaLabel,"aria-pressed":s.isSelected,role:"gridcell",onClick:o=>ks(s.id,s.piece)},[s.piece&&s.image?(f(),p("img",{key:0,src:s.image,alt:"","aria-hidden":"true",class:A(["piece","piece-img",s.tone==="light"?"piece--light":"piece--dark"])},null,10,Bn)):s.piece?(f(),p("span",{key:1,class:A(["piece",s.tone==="light"?"piece--light":"piece--dark"])},v(s.symbol),3)):w("",!0)],10,On))),128))])])]),a("div",Dn,[a("div",null,[t[28]||(t[28]=a("p",{class:"metric-label"},"Noeud",-1)),a("p",Un,"#"+v(Ze.value.ply),1)]),a("div",null,[t[29]||(t[29]=a("p",{class:"metric-label"},"Trait",-1)),a("p",zn,v(vt.value==="white"?"Blancs":"Noirs"),1)])]),a("div",Jn,[a("div",Wn,[t[30]||(t[30]=a("span",{class:"move-side"},"Chemin",-1)),a("span",Gn,[(f(!0),p(xe,null,Re(Ha.value,s=>(f(),p("button",{key:`path-${s.id}`,class:"button-ghost",type:"button",onClick:o=>ba(s.id)},v(s.notation||"Depart"),9,Vn))),128))])]),sa.value.length?(f(),p("div",qn,[t[31]||(t[31]=a("span",{class:"move-side"},"Branches",-1)),a("span",jn,[(f(!0),p(xe,null,Re(sa.value,s=>(f(),p("button",{key:`branch-${s.id}`,class:"button-ghost",type:"button",onClick:o=>ba(s.id)},v(s.notation||"..."),9,Hn))),128))])])):(f(),p("div",Kn,"Aucune branche depuis ce noeud."))])])])])),h.value?(f(),p("div",Qn,[t[35]||(t[35]=a("p",{class:"panel-title"},"Chat",-1)),a("div",{ref_key:"chatListRef",ref:fe,class:"chat-list"},[k.value.length?w("",!0):(f(),p("div",Xn," Aucun message. ")),(f(!0),p(xe,null,Re(k.value,s=>(f(),p("div",{key:s.id,class:"chat-item"},[a("div",Yn,[a("span",Zn,v(s.userName),1),a("span",eo,v(us(s.createdAt)),1)]),a("p",to,v(s.message),1)]))),128))],512),a("div",ao,[Pt(a("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>Ce.value=s),type:"text",placeholder:"Ecrire un message...","aria-label":"Message",disabled:Ie.value||G.value,onKeydown:$s(As(ya,["prevent"]),["enter"])},null,40,so),[[Lt,Ce.value]]),a("button",{class:"button-primary",type:"button",disabled:Ie.value||G.value||!Ce.value.trim(),onClick:ya},v(Ie.value?"Envoi...":"Envoyer"),9,lo)]),Ue.value?(f(),p("p",no,v(Ue.value),1)):w("",!0)])):w("",!0)])])]),_:1},8,["title","subtitle"]))}});export{po as default};
