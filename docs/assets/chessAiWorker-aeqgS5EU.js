(function(){"use strict";function ot(i){return i!==null?{comment:i,variations:[]}:{variations:[]}}function at(i,t,e,s,r){const o={move:i,variations:r};return t&&(o.suffix=t),e&&(o.nag=e),s!==null&&(o.comment=s),o}function lt(...i){const[t,...e]=i;let s=t;for(const r of e)r!==null&&(s.variations=[r,...r.variations],r.variations=[],s=r);return t}function ft(i,t){if(t.marker&&t.marker.comment){let e=t.root;for(;;){const s=e.variations[0];if(!s){e.comment=t.marker.comment;break}e=s}}return{headers:i,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function ht(i,t){function e(){this.constructor=i}e.prototype=t.prototype,i.prototype=new e}function G(i,t,e,s){var r=Error.call(this,i);return Object.setPrototypeOf&&Object.setPrototypeOf(r,G.prototype),r.expected=t,r.found=e,r.location=s,r.name="SyntaxError",r}ht(G,Error);function he(i,t,e){return e=e||" ",i.length>t?i:(t-=i.length,e+=e.repeat(t),i+e.slice(0,t))}G.prototype.format=function(i){var t="Error: "+this.message;if(this.location){var e=null,s;for(s=0;s<i.length;s++)if(i[s].source===this.location.source){e=i[s].text.split(/\r\n|\n|\r/g);break}var r=this.location.start,o=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(r):r,c=this.location.source+":"+o.line+":"+o.column;if(e){var h=this.location.end,u=he("",o.line.toString().length," "),p=e[r.line-1],g=r.line===h.line?h.column:p.length+1,C=g-r.column||1;t+=`
 --> `+c+`
`+u+` |
`+o.line+" | "+p+`
`+u+" | "+he("",r.column-1," ")+he("",C,"^")}else t+=`
 at `+c}return t},G.buildMessage=function(i,t){var e={literal:function(p){return'"'+r(p.text)+'"'},class:function(p){var g=p.parts.map(function(C){return Array.isArray(C)?o(C[0])+"-"+o(C[1]):o(C)});return"["+(p.inverted?"^":"")+g.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(p){return p.description}};function s(p){return p.charCodeAt(0).toString(16).toUpperCase()}function r(p){return p.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+s(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+s(g)})}function o(p){return p.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+s(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+s(g)})}function c(p){return e[p.type](p)}function h(p){var g=p.map(c),C,_;if(g.sort(),g.length>0){for(C=1,_=1;C<g.length;C++)g[C-1]!==g[C]&&(g[_]=g[C],_++);g.length=_}switch(g.length){case 1:return g[0];case 2:return g[0]+" or "+g[1];default:return g.slice(0,-1).join(", ")+", or "+g[g.length-1]}}function u(p){return p?'"'+r(p)+'"':"end of input"}return"Expected "+h(i)+" but "+u(t)+" found."};function ct(i,t){t=t!==void 0?t:{};var e={},s=t.grammarSource,r={pgn:et},o=et,c="[",h='"',u="]",p=".",g="O-O-O",C="O-O",_="0-0-0",m="0-0",k="$",T="{",K="}",ne=";",Se="(",Ft=")",Oe="1-0",Le="0-1",Ke="1/2-1/2",qt="*",Ce=/^[a-zA-Z]/,Fe=/^[^"]/,oe=/^[0-9]/,qe=/^[.]/,Re=/^[a-zA-Z1-8\-=]/,Rt=/^[+#]/,De=/^[!?]/,Ue=/^[^}]/,Be=/^[^\r\n]/,Qe=/^[ \t\r\n]/,Dt=L("tag pair"),Ut=w("[",!1),je=w('"',!1),Bt=w("]",!1),Qt=L("tag name"),Ae=q([["a","z"],["A","Z"]],!1,!1),jt=L("tag value"),Ge=q(['"'],!0,!1),Gt=L("move number"),ae=q([["0","9"]],!1,!1),Ht=w(".",!1),He=q(["."],!1,!1),Vt=L("standard algebraic notation"),Wt=w("O-O-O",!1),Yt=w("O-O",!1),zt=w("0-0-0",!1),Zt=w("0-0",!1),Ve=q([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),Jt=q(["+","#"],!1,!1),Xt=L("suffix annotation"),We=q(["!","?"],!1,!1),es=L("NAG"),ts=w("$",!1),ss=L("brace comment"),is=w("{",!1),Ye=q(["}"],!0,!1),rs=w("}",!1),ns=L("rest of line comment"),os=w(";",!1),ze=q(["\r",`
`],!0,!1),as=L("variation"),ls=w("(",!1),fs=w(")",!1),hs=L("game termination marker"),cs=w("1-0",!1),us=w("0-1",!1),ps=w("1/2-1/2",!1),_s=w("*",!1),gs=L("whitespace"),Ze=q([" ","	","\r",`
`],!1,!1),ds=function(n,l){return ft(n,l)},ms=function(n){return Object.fromEntries(n)},vs=function(n,l){return[n,l]},bs=function(n,l){return{root:n,marker:l}},Es=function(n,l){return lt(ot(n),...l.flat())},Ss=function(n,l,f,b,E){return at(n,l,f,b,E)},Cs=function(n){return n},As=function(n){return n.replace(/[\r\n]+/g," ")},ks=function(n){return n.trim()},$s=function(n){return n},Ts=function(n,l){return{result:n,comment:l}},a=t.peg$currPos|0,V=[{line:1,column:1}],F=a,le=t.peg$maxFailExpected||[],d=t.peg$silentFails|0,J;if(t.startRule){if(!(t.startRule in r))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');o=r[t.startRule]}function w(n,l){return{type:"literal",text:n,ignoreCase:l}}function q(n,l,f){return{type:"class",parts:n,inverted:l,ignoreCase:f}}function ys(){return{type:"end"}}function L(n){return{type:"other",description:n}}function Je(n){var l=V[n],f;if(l)return l;if(n>=V.length)f=V.length-1;else for(f=n;!V[--f];);for(l=V[f],l={line:l.line,column:l.column};f<n;)i.charCodeAt(f)===10?(l.line++,l.column=1):l.column++,f++;return V[n]=l,l}function Xe(n,l,f){var b=Je(n),E=Je(l),$={source:s,start:{offset:n,line:b.line,column:b.column},end:{offset:l,line:E.line,column:E.column}};return $}function v(n){a<F||(a>F&&(F=a,le=[]),le.push(n))}function Ns(n,l,f){return new G(G.buildMessage(n,l),n,l,f)}function et(){var n,l,f;return n=a,l=Is(),f=xs(),n=ds(l,f),n}function Is(){var n,l,f;for(n=a,l=[],f=tt();f!==e;)l.push(f),f=tt();return f=M(),n=ms(l),n}function tt(){var n,l,f,b,E,$,j;return d++,n=a,M(),i.charCodeAt(a)===91?(l=c,a++):(l=e,d===0&&v(Ut)),l!==e?(M(),f=ws(),f!==e?(M(),i.charCodeAt(a)===34?(b=h,a++):(b=e,d===0&&v(je)),b!==e?(E=Ps(),i.charCodeAt(a)===34?($=h,a++):($=e,d===0&&v(je)),$!==e?(M(),i.charCodeAt(a)===93?(j=u,a++):(j=e,d===0&&v(Bt)),j!==e?n=vs(f,E):(a=n,n=e)):(a=n,n=e)):(a=n,n=e)):(a=n,n=e)):(a=n,n=e),d--,n===e&&d===0&&v(Dt),n}function ws(){var n,l,f;if(d++,n=a,l=[],f=i.charAt(a),Ce.test(f)?a++:(f=e,d===0&&v(Ae)),f!==e)for(;f!==e;)l.push(f),f=i.charAt(a),Ce.test(f)?a++:(f=e,d===0&&v(Ae));else l=e;return l!==e?n=i.substring(n,a):n=l,d--,n===e&&(l=e,d===0&&v(Qt)),n}function Ps(){var n,l,f;for(d++,n=a,l=[],f=i.charAt(a),Fe.test(f)?a++:(f=e,d===0&&v(Ge));f!==e;)l.push(f),f=i.charAt(a),Fe.test(f)?a++:(f=e,d===0&&v(Ge));return n=i.substring(n,a),d--,l=e,d===0&&v(jt),n}function xs(){var n,l,f;return n=a,l=st(),M(),f=qs(),f===e&&(f=null),M(),n=bs(l,f),n}function st(){var n,l,f,b;for(n=a,l=ke(),l===e&&(l=null),f=[],b=it();b!==e;)f.push(b),b=it();return n=Es(l,f),n}function it(){var n,l,f,b,E,$,j,fe;if(n=a,M(),Ms(),M(),l=Os(),l!==e){for(f=Ls(),f===e&&(f=null),b=[],E=rt();E!==e;)b.push(E),E=rt();for(E=M(),$=ke(),$===e&&($=null),j=[],fe=nt();fe!==e;)j.push(fe),fe=nt();n=Ss(l,f,b,$,j)}else a=n,n=e;return n}function Ms(){var n,l,f,b,E,$;for(d++,n=a,l=[],f=i.charAt(a),oe.test(f)?a++:(f=e,d===0&&v(ae));f!==e;)l.push(f),f=i.charAt(a),oe.test(f)?a++:(f=e,d===0&&v(ae));if(i.charCodeAt(a)===46?(f=p,a++):(f=e,d===0&&v(Ht)),f!==e){for(b=M(),E=[],$=i.charAt(a),qe.test($)?a++:($=e,d===0&&v(He));$!==e;)E.push($),$=i.charAt(a),qe.test($)?a++:($=e,d===0&&v(He));l=[l,f,b,E],n=l}else a=n,n=e;return d--,n===e&&(l=e,d===0&&v(Gt)),n}function Os(){var n,l,f,b,E,$;if(d++,n=a,l=a,i.substr(a,5)===g?(f=g,a+=5):(f=e,d===0&&v(Wt)),f===e&&(i.substr(a,3)===C?(f=C,a+=3):(f=e,d===0&&v(Yt)),f===e&&(i.substr(a,5)===_?(f=_,a+=5):(f=e,d===0&&v(zt)),f===e&&(i.substr(a,3)===m?(f=m,a+=3):(f=e,d===0&&v(Zt)),f===e))))if(f=a,b=i.charAt(a),Ce.test(b)?a++:(b=e,d===0&&v(Ae)),b!==e){if(E=[],$=i.charAt(a),Re.test($)?a++:($=e,d===0&&v(Ve)),$!==e)for(;$!==e;)E.push($),$=i.charAt(a),Re.test($)?a++:($=e,d===0&&v(Ve));else E=e;E!==e?(b=[b,E],f=b):(a=f,f=e)}else a=f,f=e;return f!==e?(b=i.charAt(a),Rt.test(b)?a++:(b=e,d===0&&v(Jt)),b===e&&(b=null),f=[f,b],l=f):(a=l,l=e),l!==e?n=i.substring(n,a):n=l,d--,n===e&&(l=e,d===0&&v(Vt)),n}function Ls(){var n,l,f;for(d++,n=a,l=[],f=i.charAt(a),De.test(f)?a++:(f=e,d===0&&v(We));f!==e;)l.push(f),l.length>=2?f=e:(f=i.charAt(a),De.test(f)?a++:(f=e,d===0&&v(We)));return l.length<1?(a=n,n=e):n=l,d--,n===e&&(l=e,d===0&&v(Xt)),n}function rt(){var n,l,f,b,E;if(d++,n=a,M(),i.charCodeAt(a)===36?(l=k,a++):(l=e,d===0&&v(ts)),l!==e){if(f=a,b=[],E=i.charAt(a),oe.test(E)?a++:(E=e,d===0&&v(ae)),E!==e)for(;E!==e;)b.push(E),E=i.charAt(a),oe.test(E)?a++:(E=e,d===0&&v(ae));else b=e;b!==e?f=i.substring(f,a):f=b,f!==e?n=Cs(f):(a=n,n=e)}else a=n,n=e;return d--,n===e&&d===0&&v(es),n}function ke(){var n;return n=Ks(),n===e&&(n=Fs()),n}function Ks(){var n,l,f,b,E;if(d++,n=a,i.charCodeAt(a)===123?(l=T,a++):(l=e,d===0&&v(is)),l!==e){for(f=a,b=[],E=i.charAt(a),Ue.test(E)?a++:(E=e,d===0&&v(Ye));E!==e;)b.push(E),E=i.charAt(a),Ue.test(E)?a++:(E=e,d===0&&v(Ye));f=i.substring(f,a),i.charCodeAt(a)===125?(b=K,a++):(b=e,d===0&&v(rs)),b!==e?n=As(f):(a=n,n=e)}else a=n,n=e;return d--,n===e&&(l=e,d===0&&v(ss)),n}function Fs(){var n,l,f,b,E;if(d++,n=a,i.charCodeAt(a)===59?(l=ne,a++):(l=e,d===0&&v(os)),l!==e){for(f=a,b=[],E=i.charAt(a),Be.test(E)?a++:(E=e,d===0&&v(ze));E!==e;)b.push(E),E=i.charAt(a),Be.test(E)?a++:(E=e,d===0&&v(ze));f=i.substring(f,a),n=ks(f)}else a=n,n=e;return d--,n===e&&(l=e,d===0&&v(ns)),n}function nt(){var n,l,f,b;return d++,n=a,M(),i.charCodeAt(a)===40?(l=Se,a++):(l=e,d===0&&v(ls)),l!==e?(f=st(),f!==e?(M(),i.charCodeAt(a)===41?(b=Ft,a++):(b=e,d===0&&v(fs)),b!==e?n=$s(f):(a=n,n=e)):(a=n,n=e)):(a=n,n=e),d--,n===e&&d===0&&v(as),n}function qs(){var n,l,f;return d++,n=a,i.substr(a,3)===Oe?(l=Oe,a+=3):(l=e,d===0&&v(cs)),l===e&&(i.substr(a,3)===Le?(l=Le,a+=3):(l=e,d===0&&v(us)),l===e&&(i.substr(a,7)===Ke?(l=Ke,a+=7):(l=e,d===0&&v(ps)),l===e&&(i.charCodeAt(a)===42?(l=qt,a++):(l=e,d===0&&v(_s))))),l!==e?(M(),f=ke(),f===e&&(f=null),n=Ts(l,f)):(a=n,n=e),d--,n===e&&(l=e,d===0&&v(hs)),n}function M(){var n,l;for(d++,n=[],l=i.charAt(a),Qe.test(l)?a++:(l=e,d===0&&v(Ze));l!==e;)n.push(l),l=i.charAt(a),Qe.test(l)?a++:(l=e,d===0&&v(Ze));return d--,l=e,d===0&&v(gs),n}if(J=o(),t.peg$library)return{peg$result:J,peg$currPos:a,peg$FAILED:e,peg$maxFailExpected:le,peg$maxFailPos:F};if(J!==e&&a===i.length)return J;throw J!==e&&a<i.length&&v(ys()),Ns(le,F<i.length?i.charAt(F):null,F<i.length?Xe(F,F+1):Xe(F,F))}const X=0xffffffffffffffffn;function ce(i,t){return(i<<t|i>>64n-t)&0xffffffffffffffffn}function $e(i,t){return i*t&X}function ut(i){return function(){let t=BigInt(i&X),e=BigInt(i>>64n&X);const s=$e(ce($e(t,5n),7n),9n);return e^=t,t=(ce(t,24n)^e^e<<16n)&X,e=ce(e,37n),i=e<<64n|t,s}}const ee=ut(0xa187eb39cdcaed8f31c4b365b102e01en),pt=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>ee()))),_t=Array.from({length:8},()=>ee()),gt=Array.from({length:16},()=>ee()),ue=ee(),x="w",O="b",y="p",pe="n",te="b",W="r",R="q",N="k",_e="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class se{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(t,e){const{color:s,piece:r,from:o,to:c,flags:h,captured:u,promotion:p}=e,g=I(o),C=I(c);this.color=s,this.piece=r,this.from=g,this.to=C,this.san=t._moveToSan(e,t._moves({legal:!0})),this.lan=g+C,this.before=t.fen(),t._makeMove(e),this.after=t.fen(),t._undoMove(),this.flags="";for(const _ in A)A[_]&h&&(this.flags+=B[_]);u&&(this.captured=u),p&&(this.promotion=p,this.lan+=p)}isCapture(){return this.flags.indexOf(B.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(B.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(B.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(B.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(B.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(B.BIG_PAWN)>-1}}const P=-1,B={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},A={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},ge={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},dt={...ge,...{WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null}},S={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},de={b:[16,32,17,15],w:[-16,-32,-17,-15]},Te={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},mt=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],vt=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],bt={p:1,n:2,b:4,r:8,q:16,k:32},Et="pnbrqkPNBRQK",ye=[pe,te,W,R],St=7,Ct=6,At=1,kt=0,ie={[N]:A.KSIDE_CASTLE,[R]:A.QSIDE_CASTLE},D={w:[{square:S.a1,flag:A.QSIDE_CASTLE},{square:S.h1,flag:A.KSIDE_CASTLE}],b:[{square:S.a8,flag:A.QSIDE_CASTLE},{square:S.h8,flag:A.KSIDE_CASTLE}]},$t={b:At,w:Ct},me="--";function Q(i){return i>>4}function Y(i){return i&15}function Ne(i){return"0123456789".indexOf(i)!==-1}function I(i){const t=Y(i),e=Q(i);return"abcdefgh".substring(t,t+1)+"87654321".substring(e,e+1)}function z(i){return i===x?O:x}function Tt(i){const t=i.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const e=parseInt(t[5],10);if(isNaN(e)||e<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const s=parseInt(t[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const r=t[0].split("/");if(r.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let c=0;c<r.length;c++){let h=0,u=!1;for(let p=0;p<r[c].length;p++)if(Ne(r[c][p])){if(u)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};h+=parseInt(r[c][p],10),u=!0}else{if(!/^[prnbqkPRNBQK]$/.test(r[c][p]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};h+=1,u=!1}if(h!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const o=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:c,regex:h}of o){if(!h.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${c} king`};if((t[0].match(h)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${c} kings`}}return Array.from(r[0]+r[7]).some(c=>c.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function yt(i,t){const e=i.from,s=i.to,r=i.piece;let o=0,c=0,h=0;for(let u=0,p=t.length;u<p;u++){const g=t[u].from,C=t[u].to,_=t[u].piece;r===_&&e!==g&&s===C&&(o++,Q(e)===Q(g)&&c++,Y(e)===Y(g)&&h++)}return o>0?c>0&&h>0?I(e):h>0?I(e).charAt(1):I(e).charAt(0):""}function U(i,t,e,s,r,o=void 0,c=A.NORMAL){const h=Q(s);if(r===y&&(h===St||h===kt))for(let u=0;u<ye.length;u++){const p=ye[u];i.push({color:t,from:e,to:s,piece:r,captured:o,promotion:p,flags:c|A.PROMOTION})}else i.push({color:t,from:e,to:s,piece:r,captured:o,flags:c})}function Ie(i){let t=i.charAt(0);return t>="a"&&t<="h"?i.match(/[a-h]\d.*[a-h]\d/)?void 0:y:(t=t.toLowerCase(),t==="o"?N:t)}function ve(i){return i.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class Z{_board=new Array(128);_turn=x;_header={};_kings={w:P,b:P};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(t=_e,{skipValidation:e=!1}={}){this.load(t,{skipValidation:e})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:P,b:P},this._turn=x,this._castling={w:0,b:0},this._epSquare=P,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...dt},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:e=!1,preserveHeaders:s=!1}={}){let r=t.split(/\s+/);if(r.length>=2&&r.length<6){const h=["-","-","0","1"];t=r.concat(h.slice(-(6-r.length))).join(" ")}if(r=t.split(/\s+/),!e){const{ok:h,error:u}=Tt(t);if(!h)throw new Error(u)}const o=r[0];let c=0;this.clear({preserveHeaders:s});for(let h=0;h<o.length;h++){const u=o.charAt(h);if(u==="/")c+=8;else if(Ne(u))c+=parseInt(u,10);else{const p=u<"a"?x:O;this._put({type:u.toLowerCase(),color:p},I(c)),c++}}this._turn=r[1],r[2].indexOf("K")>-1&&(this._castling.w|=A.KSIDE_CASTLE),r[2].indexOf("Q")>-1&&(this._castling.w|=A.QSIDE_CASTLE),r[2].indexOf("k")>-1&&(this._castling.b|=A.KSIDE_CASTLE),r[2].indexOf("q")>-1&&(this._castling.b|=A.QSIDE_CASTLE),this._epSquare=r[3]==="-"?P:S[r[3]],this._halfMoves=parseInt(r[4],10),this._moveNumber=parseInt(r[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){let e=0,s="";for(let c=S.a8;c<=S.h1;c++){if(this._board[c]){e>0&&(s+=e,e=0);const{color:h,type:u}=this._board[c];s+=h===x?u.toUpperCase():u.toLowerCase()}else e++;c+1&136&&(e>0&&(s+=e),c!==S.h1&&(s+="/"),e=0,c+=8)}let r="";this._castling[x]&A.KSIDE_CASTLE&&(r+="K"),this._castling[x]&A.QSIDE_CASTLE&&(r+="Q"),this._castling[O]&A.KSIDE_CASTLE&&(r+="k"),this._castling[O]&A.QSIDE_CASTLE&&(r+="q"),r=r||"-";let o="-";if(this._epSquare!==P)if(t)o=I(this._epSquare);else{const c=this._epSquare+(this._turn===x?16:-16),h=[c+1,c-1];for(const u of h){if(u&136)continue;const p=this._turn;if(this._board[u]?.color===p&&this._board[u]?.type===y){this._makeMove({color:p,from:u,to:this._epSquare,piece:y,captured:y,flags:A.EP_CAPTURE});const g=!this._isKingAttacked(p);if(this._undoMove(),g){o=I(this._epSquare);break}}}}return[s,this._turn,r,o,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;const{color:e,type:s}=this._board[t],r={w:0,b:1}[e],o={p:0,n:1,b:2,r:3,q:4,k:5}[s];return pt[r][o][t]}_epKey(){return this._epSquare===P?0n:_t[this._epSquare&7]}_castlingKey(){const t=this._castling.w>>5|this._castling.b>>3;return gt[t]}_computeHash(){let t=0n;for(let e=S.a8;e<=S.h1;e++){if(e&136){e+=7;continue}this._board[e]&&(t^=this._pieceKey(e))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=ue),t}_updateSetup(t){this._history.length>0||(t!==_e?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(_e)}get(t){return this._board[S[t]]}findPiece(t){const e=[];for(let s=S.a8;s<=S.h1;s++){if(s&136){s+=7;continue}!this._board[s]||this._board[s]?.color!==t.color||this._board[s].color===t.color&&this._board[s].type===t.type&&e.push(I(s))}return e}put({type:t,color:e},s){return this._put({type:t,color:e},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,e){this._hash^=this._pieceKey(t),this._board[t]=e,this._hash^=this._pieceKey(t)}_put({type:t,color:e},s){if(Et.indexOf(t.toLowerCase())===-1||!(s in S))return!1;const r=S[s];if(t==N&&!(this._kings[e]==P||this._kings[e]==r))return!1;const o=this._board[r];return o&&o.type===N&&(this._kings[o.color]=P),this._set(r,{type:t,color:e}),t===N&&(this._kings[e]=r),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){const e=this.get(t);return this._clear(S[t]),e&&e.type===N&&(this._kings[e.color]=P),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),e}_updateCastlingRights(){this._hash^=this._castlingKey();const t=this._board[S.e1]?.type===N&&this._board[S.e1]?.color===x,e=this._board[S.e8]?.type===N&&this._board[S.e8]?.color===O;(!t||this._board[S.a1]?.type!==W||this._board[S.a1]?.color!==x)&&(this._castling.w&=-65),(!t||this._board[S.h1]?.type!==W||this._board[S.h1]?.color!==x)&&(this._castling.w&=-33),(!e||this._board[S.a8]?.type!==W||this._board[S.a8]?.color!==O)&&(this._castling.b&=-65),(!e||this._board[S.h8]?.type!==W||this._board[S.h8]?.color!==O)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare===P)return;const t=this._epSquare+(this._turn===x?-16:16),e=this._epSquare+(this._turn===x?16:-16),s=[e+1,e-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||this._board[e]?.color!==z(this._turn)||this._board[e]?.type!==y){this._hash^=this._epKey(),this._epSquare=P;return}const r=o=>!(o&136)&&this._board[o]?.color===this._turn&&this._board[o]?.type===y;s.some(r)||(this._hash^=this._epKey(),this._epSquare=P)}_attacked(t,e,s){const r=[];for(let o=S.a8;o<=S.h1;o++){if(o&136){o+=7;continue}if(this._board[o]===void 0||this._board[o].color!==t)continue;const c=this._board[o],h=o-e;if(h===0)continue;const u=h+119;if(mt[u]&bt[c.type]){if(c.type===y){if(h>0&&c.color===x||h<=0&&c.color===O)if(s)r.push(I(o));else return!0;continue}if(c.type==="n"||c.type==="k")if(s){r.push(I(o));continue}else return!0;const p=vt[u];let g=o+p,C=!1;for(;g!==e;){if(this._board[g]!=null){C=!0;break}g+=p}if(!C)if(s){r.push(I(o));continue}else return!0}}return s?r:!1}attackers(t,e){return e?this._attacked(e,S[t],!0):this._attacked(this._turn,S[t],!0)}_isKingAttacked(t){const e=this._kings[t];return e===-1?!1:this._attacked(z(t),e)}hash(){return this._hash.toString(16)}isAttacked(t,e){return this._attacked(e,S[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const t={b:0,n:0,r:0,q:0,k:0,p:0},e=[];let s=0,r=0;for(let o=S.a8;o<=S.h1;o++){if(r=(r+1)%2,o&136){o+=7;continue}const c=this._board[o];c&&(t[c.type]=c.type in t?t[c.type]+1:1,c.type===te&&e.push(r),s++)}if(s===2)return!0;if(s===3&&(t[te]===1||t[pe]===1))return!0;if(s===t[te]+2){let o=0;const c=e.length;for(let h=0;h<c;h++)o+=e[h];if(o===0||o===c)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:e=void 0,piece:s=void 0}={}){const r=this._moves({square:e,piece:s});return t?r.map(o=>new se(this,o)):r.map(o=>this._moveToSan(o,r))}_moves({legal:t=!0,piece:e=void 0,square:s=void 0}={}){const r=s?s.toLowerCase():void 0,o=e?.toLowerCase(),c=[],h=this._turn,u=z(h);let p=S.a8,g=S.h1,C=!1;if(r)if(r in S)p=g=S[r],C=!0;else return[];for(let m=p;m<=g;m++){if(m&136){m+=7;continue}if(!this._board[m]||this._board[m].color===u)continue;const{type:k}=this._board[m];let T;if(k===y){if(o&&o!==k)continue;T=m+de[h][0],this._board[T]||(U(c,h,m,T,y),T=m+de[h][1],$t[h]===Q(m)&&!this._board[T]&&U(c,h,m,T,y,void 0,A.BIG_PAWN));for(let K=2;K<4;K++)T=m+de[h][K],!(T&136)&&(this._board[T]?.color===u?U(c,h,m,T,y,this._board[T].type,A.CAPTURE):T===this._epSquare&&U(c,h,m,T,y,y,A.EP_CAPTURE))}else{if(o&&o!==k)continue;for(let K=0,ne=Te[k].length;K<ne;K++){const Se=Te[k][K];for(T=m;T+=Se,!(T&136);){if(!this._board[T])U(c,h,m,T,k);else{if(this._board[T].color===h)break;U(c,h,m,T,k,this._board[T].type,A.CAPTURE);break}if(k===pe||k===N)break}}}}if((o===void 0||o===N)&&(!C||g===this._kings[h])){if(this._castling[h]&A.KSIDE_CASTLE){const m=this._kings[h],k=m+2;!this._board[m+1]&&!this._board[k]&&!this._attacked(u,this._kings[h])&&!this._attacked(u,m+1)&&!this._attacked(u,k)&&U(c,h,this._kings[h],k,N,void 0,A.KSIDE_CASTLE)}if(this._castling[h]&A.QSIDE_CASTLE){const m=this._kings[h],k=m-2;!this._board[m-1]&&!this._board[m-2]&&!this._board[m-3]&&!this._attacked(u,this._kings[h])&&!this._attacked(u,m-1)&&!this._attacked(u,k)&&U(c,h,this._kings[h],k,N,void 0,A.QSIDE_CASTLE)}}if(!t||this._kings[h]===-1)return c;const _=[];for(let m=0,k=c.length;m<k;m++)this._makeMove(c[m]),this._isKingAttacked(h)||_.push(c[m]),this._undoMove();return _}move(t,{strict:e=!1}={}){let s=null;if(typeof t=="string")s=this._moveFromSan(t,e);else if(t===null)s=this._moveFromSan(me,e);else if(typeof t=="object"){const o=this._moves();for(let c=0,h=o.length;c<h;c++)if(t.from===I(o[c].from)&&t.to===I(o[c].to)&&(!("promotion"in o[c])||t.promotion===o[c].promotion)){s=o[c];break}}if(!s)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&s.flags&A.NULL_MOVE)throw new Error("Null move not allowed when in check");const r=new se(this,s);return this._makeMove(s),this._incPositionCount(),r}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,e){this._hash^=this._pieceKey(t),this._board[e]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(e)}_makeMove(t){const e=this._turn,s=z(e);if(this._push(t),t.flags&A.NULL_MOVE){e===O&&this._moveNumber++,this._halfMoves++,this._turn=s,this._epSquare=P;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&A.EP_CAPTURE&&(this._turn===O?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:e})),this._board[t.to].type===N){if(this._kings[e]=t.to,t.flags&A.KSIDE_CASTLE){const r=t.to-1,o=t.to+1;this._movePiece(o,r)}else if(t.flags&A.QSIDE_CASTLE){const r=t.to+1,o=t.to-2;this._movePiece(o,r)}this._castling[e]=0}if(this._castling[e]){for(let r=0,o=D[e].length;r<o;r++)if(t.from===D[e][r].square&&this._castling[e]&D[e][r].flag){this._castling[e]^=D[e][r].flag;break}}if(this._castling[s]){for(let r=0,o=D[s].length;r<o;r++)if(t.to===D[s][r].square&&this._castling[s]&D[s][r].flag){this._castling[s]^=D[s][r].flag;break}}if(this._hash^=this._castlingKey(),t.flags&A.BIG_PAWN){let r;e===O?r=t.to-16:r=t.to+16,!(t.to-1&136)&&this._board[t.to-1]?.type===y&&this._board[t.to-1]?.color===s||!(t.to+1&136)&&this._board[t.to+1]?.type===y&&this._board[t.to+1]?.color===s?(this._epSquare=r,this._hash^=this._epKey()):this._epSquare=P}else this._epSquare=P;t.piece===y?this._halfMoves=0:t.flags&(A.CAPTURE|A.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,e===O&&this._moveNumber++,this._turn=s,this._hash^=ue}undo(){const t=this._hash,e=this._undoMove();if(e){const s=new se(this,e);return this._decPositionCount(t),s}return null}_undoMove(){const t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();const e=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=ue;const s=this._turn,r=z(s);if(e.flags&A.NULL_MOVE)return e;if(this._movePiece(e.to,e.from),e.piece&&(this._clear(e.from),this._set(e.from,{type:e.piece,color:s})),e.captured)if(e.flags&A.EP_CAPTURE){let o;s===O?o=e.to-16:o=e.to+16,this._set(o,{type:y,color:r})}else this._set(e.to,{type:e.captured,color:r});if(e.flags&(A.KSIDE_CASTLE|A.QSIDE_CASTLE)){let o,c;e.flags&A.KSIDE_CASTLE?(o=e.to+1,c=e.to-1):(o=e.to-2,c=e.to+1),this._movePiece(c,o)}return e}pgn({newline:t=`
`,maxWidth:e=0}={}){const s=[];let r=!1;for(const _ in this._header)this._header[_]&&s.push(`[${_} "${this._header[_]}"]`+t),r=!0;r&&this._history.length&&s.push(t);const o=_=>{const m=this._comments[this.fen()];if(typeof m<"u"){const k=_.length>0?" ":"";_=`${_}${k}{${m}}`}return _},c=[];for(;this._history.length>0;)c.push(this._undoMove());const h=[];let u="";for(c.length===0&&h.push(o(""));c.length>0;){u=o(u);const _=c.pop();if(!_)break;if(!this._history.length&&_.color==="b"){const m=`${this._moveNumber}. ...`;u=u?`${u} ${m}`:m}else _.color==="w"&&(u.length&&h.push(u),u=this._moveNumber+".");u=u+" "+this._moveToSan(_,this._moves({legal:!0})),this._makeMove(_)}if(u.length&&h.push(o(u)),h.push(this._header.Result||"*"),e===0)return s.join("")+h.join(" ");const p=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},g=function(_,m){for(const k of m.split(" "))if(k){if(_+k.length>e){for(;p();)_--;s.push(t),_=0}s.push(k),_+=k.length,s.push(" "),_++}return p()&&_--,_};let C=0;for(let _=0;_<h.length;_++){if(C+h[_].length>e&&h[_].includes("{")){C=g(C,h[_]);continue}C+h[_].length>e&&_!==0?(s[s.length-1]===" "&&s.pop(),s.push(t),C=0):_!==0&&(s.push(" "),C++),s.push(h[_]),C+=h[_].length}return s.join("")}header(...t){for(let e=0;e<t.length;e+=2)typeof t[e]=="string"&&typeof t[e+1]=="string"&&(this._header[t[e]]=t[e+1]);return this._header}setHeader(t,e){return this._header[t]=e??ge[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=ge[t]||null,!0):!1}getHeaders(){const t={};for(const[e,s]of Object.entries(this._header))s!==null&&(t[e]=s);return t}loadPgn(t,{strict:e=!1,newlineChar:s=`\r?
`}={}){s!==`\r?
`&&(t=t.replace(new RegExp(s,"g"),`
`));const r=ct(t);this.reset();const o=r.headers;let c="";for(const p in o)p.toLowerCase()==="fen"&&(c=o[p]),this.header(p,o[p]);if(!e)c&&this.load(c,{preserveHeaders:!0});else if(o.SetUp==="1"){if(!("FEN"in o))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(o.FEN,{preserveHeaders:!0})}let h=r.root;for(;h;){if(h.move){const p=this._moveFromSan(h.move,e);if(p==null)throw new Error(`Invalid move in PGN: ${h.move}`);this._makeMove(p),this._incPositionCount()}h.comment!==void 0&&(this._comments[this.fen()]=h.comment),h=h.variations[0]}const u=r.result;u&&Object.keys(this._header).length&&this._header.Result!==u&&this.setHeader("Result",u)}_moveToSan(t,e){let s="";if(t.flags&A.KSIDE_CASTLE)s="O-O";else if(t.flags&A.QSIDE_CASTLE)s="O-O-O";else{if(t.flags&A.NULL_MOVE)return me;if(t.piece!==y){const r=yt(t,e);s+=t.piece.toUpperCase()+r}t.flags&(A.CAPTURE|A.EP_CAPTURE)&&(t.piece===y&&(s+=I(t.from)[0]),s+="x"),s+=I(t.to),t.promotion&&(s+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(t,e=!1){let s=ve(t);if(e||(s==="0-0"?s="O-O":s==="0-0-0"&&(s="O-O-O")),s==me)return{color:this._turn,from:0,to:0,piece:"k",flags:A.NULL_MOVE};let r=Ie(s),o=this._moves({legal:!0,piece:r});for(let _=0,m=o.length;_<m;_++)if(s===ve(this._moveToSan(o[_],o)))return o[_];if(e)return null;let c,h,u,p,g,C=!1;if(h=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),h?(c=h[1],u=h[2],p=h[3],g=h[4],u.length==1&&(C=!0)):(h=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),h&&(c=h[1],u=h[2],p=h[3],g=h[4],u.length==1&&(C=!0))),r=Ie(s),o=this._moves({legal:!0,piece:c||r}),!p)return null;for(let _=0,m=o.length;_<m;_++)if(u){if((!c||c.toLowerCase()==o[_].piece)&&S[u]==o[_].from&&S[p]==o[_].to&&(!g||g.toLowerCase()==o[_].promotion))return o[_];if(C){const k=I(o[_].from);if((!c||c.toLowerCase()==o[_].piece)&&S[p]==o[_].to&&(u==k[0]||u==k[1])&&(!g||g.toLowerCase()==o[_].promotion))return o[_]}}else if(s===ve(this._moveToSan(o[_],o)).replace("x",""))return o[_];return null}ascii(){let t=`   +------------------------+
`;for(let e=S.a8;e<=S.h1;e++){if(Y(e)===0&&(t+=" "+"87654321"[Q(e)]+" |"),this._board[e]){const s=this._board[e].type,o=this._board[e].color===x?s.toUpperCase():s.toLowerCase();t+=" "+o+" "}else t+=" . ";e+1&136&&(t+=`|
`,e+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){const e=this._moves({legal:!1});let s=0;const r=this._turn;for(let o=0,c=e.length;o<c;o++)this._makeMove(e[o]),this._isKingAttacked(r)||(t-1>0?s+=this.perft(t-1):s++),this._undoMove();return s}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){const t=[];let e=[];for(let s=S.a8;s<=S.h1;s++)this._board[s]==null?e.push(null):e.push({square:I(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(t.push(e),e=[],s+=8);return t}squareColor(t){if(t in S){const e=S[t];return(Q(e)+Y(e))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){const e=[],s=[];for(;this._history.length>0;)e.push(this._undoMove());for(;;){const r=e.pop();if(!r)break;t?s.push(new se(this,r)):s.push(this._moveToSan(r,this._moves())),this._makeMove(r)}return s}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){const e=this._positionCount.get(t)??0;e===1?this._positionCount.delete(t):this._positionCount.set(t,e-1)}_pruneComments(){const t=[],e={},s=r=>{r in this._comments&&(e[r]=this._comments[r])};for(;this._history.length>0;)t.push(this._undoMove());for(s(this.fen());;){const r=t.pop();if(!r)break;this._makeMove(r),s(this.fen())}this._comments=e}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{const e=this._comments[t];return delete this._comments[t],{fen:t,comment:e}})}setCastlingRights(t,e){for(const r of[N,R])e[r]!==void 0&&(e[r]?this._castling[t]|=ie[r]:this._castling[t]&=~ie[r]);this._updateCastlingRights();const s=this.getCastlingRights(t);return(e[N]===void 0||e[N]===s[N])&&(e[R]===void 0||e[R]===s[R])}getCastlingRights(t){return{[N]:(this._castling[t]&ie[N])!==0,[R]:(this._castling[t]&ie[R])!==0}}moveNumber(){return this._moveNumber}}const we=["a","b","c","d","e","f","g","h"],Pe="start",Nt=.08,re={p:100,n:320,b:330,r:500,q:900,k:0},It={p:[0,0,0,0,0,0,0,0,40,40,40,45,45,40,40,40,18,18,25,35,35,25,18,18,8,10,14,24,24,14,10,8,4,8,12,20,20,12,8,4,4,4,8,10,10,8,4,4,5,6,6,-8,-8,6,6,5,0,0,0,0,0,0,0,0],n:[-50,-40,-30,-30,-30,-30,-40,-50,-40,-20,0,2,2,0,-20,-40,-30,2,10,15,15,10,2,-30,-30,4,15,20,20,15,4,-30,-30,2,15,20,20,15,2,-30,-30,4,10,15,15,10,4,-30,-40,-20,0,4,4,0,-20,-40,-50,-40,-30,-30,-30,-30,-40,-50],b:[-20,-12,-10,-10,-10,-10,-12,-20,-12,4,0,0,0,0,4,-12,-10,0,8,10,10,8,0,-10,-10,2,10,10,10,10,2,-10,-10,2,10,10,10,10,2,-10,-10,0,8,10,10,8,0,-10,-12,4,0,0,0,0,4,-12,-20,-12,-10,-10,-10,-10,-12,-20],r:[0,0,4,8,8,4,0,0,-4,0,0,0,0,0,0,-4,-4,0,0,0,0,0,0,-4,-4,0,0,0,0,0,0,-4,-4,0,0,0,0,0,0,-4,-4,0,0,0,0,0,0,-4,4,12,12,12,12,12,12,4,0,0,4,8,8,4,0,0],q:[-20,-10,-10,-5,-5,-10,-10,-20,-10,0,0,0,0,0,0,-10,-10,0,5,5,5,5,0,-10,-5,0,5,5,5,5,0,-5,-5,0,5,5,5,5,0,-5,-10,5,5,5,5,5,0,-10,-10,0,5,0,0,0,0,-10,-20,-10,-10,-5,-5,-10,-10,-20],k:[-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-20,-30,-30,-40,-40,-30,-30,-20,-10,-20,-20,-20,-20,-20,-20,-10,20,20,0,0,0,0,20,20,20,30,10,0,0,10,30,20]},wt=i=>{const t=i[0]??"",e=Number.parseInt(i[1]??"",10),s=we.indexOf(t);return s<0||e<1||e>8?-1:(8-e)*8+s},Pt=i=>{const t=Math.floor(i/8),e=i%8;return(7-t)*8+e},be=i=>i==="white"?"w":"b",xt=(i=Pe)=>i===Pe?new Z:new Z(i),H=i=>({from:i.from,to:i.to,piece:i.color==="w"?i.piece.toUpperCase():i.piece,capture:i.captured?i.color==="w"?i.captured:i.captured.toUpperCase():void 0,promotion:i.promotion,san:i.san}),xe=(i,t)=>{let e=0;const s=i.board();for(let r=0;r<s.length;r+=1){const o=s[r];if(o)for(let c=0;c<o.length;c+=1){const h=o[c];if(!h)continue;const u=`${we[c]??"a"}${8-r}`,p=wt(u),g=It[h.type],C=p>=0?g[h.color==="w"?p:Pt(p)]??0:0,m=re[h.type]+C*Nt;e+=h.color===be(t)?m:-m}}return e},Mt=(i,t)=>i.isGameOver()?i.isCheckmate()?i.turn()===be(t)?-1e5:1e5:0:null,Ee=(i,t,e,s,r,o)=>{const c=Mt(i,o);if(c!==null)return c;if(t<=0)return xe(i,o);const h=i.moves({verbose:!0});if(!h.length)return xe(i,o);if(r){let p=Number.NEGATIVE_INFINITY;for(const g of h){const C=new Z(i.fen());if(C.move(g),p=Math.max(p,Ee(C,t-1,e,s,!1,o)),e=Math.max(e,p),e>=s)break}return p}let u=Number.POSITIVE_INFINITY;for(const p of h){const g=new Z(i.fen());if(g.move(p),u=Math.min(u,Ee(g,t-1,e,s,!0,o)),s=Math.min(s,u),s<=e)break}return u},Ot=i=>i==="facile"?0:i==="intermediaire"?1:i==="difficile"?2:3,Me=i=>i.captured?(re[i.captured]??0)*.4:0,Lt=(i,t)=>{if(t==="agressif"){const e=i.san.includes("+")||i.san.includes("#")?60:0;return Me(i)+e}if(t==="solide"){const e=i.san.includes("+")?-5:0;return Me(i)*.25+e}return 0},Kt=(i,t,e,s="equilibre")=>{const r=xt(i);if(r.turn()!==be(t))return null;const o=r.moves({verbose:!0});if(!o.length)return null;if(s==="fou"){const g=o[Math.floor(Math.random()*o.length)];return g?H(g):null}if(e==="facile"){const g=o[Math.floor(Math.random()*o.length)]??null;return g?H(g):null}if(e==="intermediaire"){const g=o.filter(k=>!!k.captured),_=[...g.length?g:o].sort((k,T)=>{const K=k.captured?re[k.captured]:0;return(T.captured?re[T.captured]:0)-K});if(s==="agressif")return _[0]?H(_[0]):null;const m=_[Math.floor(Math.random()*Math.min(_.length,3))]??_[0];return m?H(m):null}const c=Ot(e);let h=Number.NEGATIVE_INFINITY,u=[];for(const g of o){const C=new Z(r.fen());C.move(g);const _=Ee(C,Math.max(0,c-1),Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,!1,t)+Lt(g,s);_>h?(h=_,u=[g]):_===h&&u.push(g)}if(s==="solide"){const g=u[0]??o[0]??null;return g?H(g):null}const p=u[Math.floor(Math.random()*u.length)]??o[0]??null;return p?H(p):null};self.addEventListener("message",i=>{const t=i.data;if(!t||typeof t.id!="number")return;const e=Kt(t.fen,t.side,t.difficulty,t.persona),s={id:t.id,move:e};self.postMessage(s)})})();
