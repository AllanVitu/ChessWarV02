function hs(r){return r!==null?{comment:r,variations:[]}:{variations:[]}}function us(r,t,e,s,i){const o={move:r,variations:i};return t&&(o.suffix=t),e&&(o.nag=e),s!==null&&(o.comment=s),o}function ps(...r){const[t,...e]=r;let s=t;for(const i of e)i!==null&&(s.variations=[i,...i.variations],i.variations=[],s=i);return t}function _s(r,t){if(t.marker&&t.marker.comment){let e=t.root;for(;;){const s=e.variations[0];if(!s){e.comment=t.marker.comment;break}e=s}}return{headers:r,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function gs(r,t){function e(){this.constructor=r}e.prototype=t.prototype,r.prototype=new e}function Y(r,t,e,s){var i=Error.call(this,r);return Object.setPrototypeOf&&Object.setPrototypeOf(i,Y.prototype),i.expected=t,i.found=e,i.location=s,i.name="SyntaxError",i}gs(Y,Error);function de(r,t,e){return e=e||" ",r.length>t?r:(t-=r.length,e+=e.repeat(t),r+e.slice(0,t))}Y.prototype.format=function(r){var t="Error: "+this.message;if(this.location){var e=null,s;for(s=0;s<r.length;s++)if(r[s].source===this.location.source){e=r[s].text.split(/\r\n|\n|\r/g);break}var i=this.location.start,o=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(i):i,h=this.location.source+":"+o.line+":"+o.column;if(e){var c=this.location.end,u=de("",o.line.toString().length," "),_=e[i.line-1],p=i.line===c.line?c.column:_.length+1,S=p-i.column||1;t+=`
 --> `+h+`
`+u+` |
`+o.line+" | "+_+`
`+u+" | "+de("",i.column-1," ")+de("",S,"^")}else t+=`
 at `+h}return t};Y.buildMessage=function(r,t){var e={literal:function(_){return'"'+i(_.text)+'"'},class:function(_){var p=_.parts.map(function(S){return Array.isArray(S)?o(S[0])+"-"+o(S[1]):o(S)});return"["+(_.inverted?"^":"")+p.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(_){return _.description}};function s(_){return _.charCodeAt(0).toString(16).toUpperCase()}function i(_){return _.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(p){return"\\x0"+s(p)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(p){return"\\x"+s(p)})}function o(_){return _.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(p){return"\\x0"+s(p)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(p){return"\\x"+s(p)})}function h(_){return e[_.type](_)}function c(_){var p=_.map(h),S,g;if(p.sort(),p.length>0){for(S=1,g=1;S<p.length;S++)p[S-1]!==p[S]&&(p[g]=p[S],g++);p.length=g}switch(p.length){case 1:return p[0];case 2:return p[0]+" or "+p[1];default:return p.slice(0,-1).join(", ")+", or "+p[p.length-1]}}function u(_){return _?'"'+i(_)+'"':"end of input"}return"Expected "+c(r)+" but "+u(t)+" found."};function ds(r,t){t=t!==void 0?t:{};var e={},s=t.grammarSource,i={pgn:Ve},o=Ve,h="[",c='"',u="]",_=".",p="O-O-O",S="O-O",g="0-0-0",m="0-0",A="$",y="{",K="}",ee=";",ue="(",ft=")",Te="1-0",we="0-1",Ie="1/2-1/2",ct="*",pe=/^[a-zA-Z]/,Ne=/^[^"]/,te=/^[0-9]/,Pe=/^[.]/,Me=/^[a-zA-Z1-8\-=]/,ht=/^[+#]/,xe=/^[!?]/,Oe=/^[^}]/,Fe=/^[^\r\n]/,Ke=/^[ \t\r\n]/,ut=F("tag pair"),pt=I("[",!1),Le=I('"',!1),_t=I("]",!1),gt=F("tag name"),_e=R([["a","z"],["A","Z"]],!1,!1),dt=F("tag value"),Re=R(['"'],!0,!1),mt=F("move number"),se=R([["0","9"]],!1,!1),vt=I(".",!1),qe=R(["."],!1,!1),bt=F("standard algebraic notation"),Et=I("O-O-O",!1),St=I("O-O",!1),Ct=I("0-0-0",!1),kt=I("0-0",!1),De=R([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),At=R(["+","#"],!1,!1),$t=F("suffix annotation"),Ue=R(["!","?"],!1,!1),yt=F("NAG"),Tt=I("$",!1),wt=F("brace comment"),It=I("{",!1),Be=R(["}"],!0,!1),Nt=I("}",!1),Pt=F("rest of line comment"),Mt=I(";",!1),Qe=R(["\r",`
`],!0,!1),xt=F("variation"),Ot=I("(",!1),Ft=I(")",!1),Kt=F("game termination marker"),Lt=I("1-0",!1),Rt=I("0-1",!1),qt=I("1/2-1/2",!1),Dt=I("*",!1),Ut=F("whitespace"),Ge=R([" ","	","\r",`
`],!1,!1),Bt=function(n,l){return _s(n,l)},Qt=function(n){return Object.fromEntries(n)},Gt=function(n,l){return[n,l]},jt=function(n,l){return{root:n,marker:l}},Ht=function(n,l){return ps(hs(n),...l.flat())},Vt=function(n,l,f,b,E){return us(n,l,f,b,E)},Wt=function(n){return n},Yt=function(n){return n.replace(/[\r\n]+/g," ")},zt=function(n){return n.trim()},Zt=function(n){return n},Jt=function(n,l){return{result:n,comment:l}},a=t.peg$currPos|0,W=[{line:1,column:1}],L=a,re=t.peg$maxFailExpected||[],d=t.peg$silentFails|0,z;if(t.startRule){if(!(t.startRule in i))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');o=i[t.startRule]}function I(n,l){return{type:"literal",text:n,ignoreCase:l}}function R(n,l,f){return{type:"class",parts:n,inverted:l,ignoreCase:f}}function Xt(){return{type:"end"}}function F(n){return{type:"other",description:n}}function je(n){var l=W[n],f;if(l)return l;if(n>=W.length)f=W.length-1;else for(f=n;!W[--f];);for(l=W[f],l={line:l.line,column:l.column};f<n;)r.charCodeAt(f)===10?(l.line++,l.column=1):l.column++,f++;return W[n]=l,l}function He(n,l,f){var b=je(n),E=je(l),$={source:s,start:{offset:n,line:b.line,column:b.column},end:{offset:l,line:E.line,column:E.column}};return $}function v(n){a<L||(a>L&&(L=a,re=[]),re.push(n))}function es(n,l,f){return new Y(Y.buildMessage(n,l),n,l,f)}function Ve(){var n,l,f;return n=a,l=ts(),f=is(),n=Bt(l,f),n}function ts(){var n,l,f;for(n=a,l=[],f=We();f!==e;)l.push(f),f=We();return f=x(),n=Qt(l),n}function We(){var n,l,f,b,E,$,Q;return d++,n=a,x(),r.charCodeAt(a)===91?(l=h,a++):(l=e,d===0&&v(pt)),l!==e?(x(),f=ss(),f!==e?(x(),r.charCodeAt(a)===34?(b=c,a++):(b=e,d===0&&v(Le)),b!==e?(E=rs(),r.charCodeAt(a)===34?($=c,a++):($=e,d===0&&v(Le)),$!==e?(x(),r.charCodeAt(a)===93?(Q=u,a++):(Q=e,d===0&&v(_t)),Q!==e?n=Gt(f,E):(a=n,n=e)):(a=n,n=e)):(a=n,n=e)):(a=n,n=e)):(a=n,n=e),d--,n===e&&d===0&&v(ut),n}function ss(){var n,l,f;if(d++,n=a,l=[],f=r.charAt(a),pe.test(f)?a++:(f=e,d===0&&v(_e)),f!==e)for(;f!==e;)l.push(f),f=r.charAt(a),pe.test(f)?a++:(f=e,d===0&&v(_e));else l=e;return l!==e?n=r.substring(n,a):n=l,d--,n===e&&(l=e,d===0&&v(gt)),n}function rs(){var n,l,f;for(d++,n=a,l=[],f=r.charAt(a),Ne.test(f)?a++:(f=e,d===0&&v(Re));f!==e;)l.push(f),f=r.charAt(a),Ne.test(f)?a++:(f=e,d===0&&v(Re));return n=r.substring(n,a),d--,l=e,d===0&&v(dt),n}function is(){var n,l,f;return n=a,l=Ye(),x(),f=cs(),f===e&&(f=null),x(),n=jt(l,f),n}function Ye(){var n,l,f,b;for(n=a,l=ge(),l===e&&(l=null),f=[],b=ze();b!==e;)f.push(b),b=ze();return n=Ht(l,f),n}function ze(){var n,l,f,b,E,$,Q,ie;if(n=a,x(),ns(),x(),l=os(),l!==e){for(f=as(),f===e&&(f=null),b=[],E=Ze();E!==e;)b.push(E),E=Ze();for(E=x(),$=ge(),$===e&&($=null),Q=[],ie=Je();ie!==e;)Q.push(ie),ie=Je();n=Vt(l,f,b,$,Q)}else a=n,n=e;return n}function ns(){var n,l,f,b,E,$;for(d++,n=a,l=[],f=r.charAt(a),te.test(f)?a++:(f=e,d===0&&v(se));f!==e;)l.push(f),f=r.charAt(a),te.test(f)?a++:(f=e,d===0&&v(se));if(r.charCodeAt(a)===46?(f=_,a++):(f=e,d===0&&v(vt)),f!==e){for(b=x(),E=[],$=r.charAt(a),Pe.test($)?a++:($=e,d===0&&v(qe));$!==e;)E.push($),$=r.charAt(a),Pe.test($)?a++:($=e,d===0&&v(qe));l=[l,f,b,E],n=l}else a=n,n=e;return d--,n===e&&(l=e,d===0&&v(mt)),n}function os(){var n,l,f,b,E,$;if(d++,n=a,l=a,r.substr(a,5)===p?(f=p,a+=5):(f=e,d===0&&v(Et)),f===e&&(r.substr(a,3)===S?(f=S,a+=3):(f=e,d===0&&v(St)),f===e&&(r.substr(a,5)===g?(f=g,a+=5):(f=e,d===0&&v(Ct)),f===e&&(r.substr(a,3)===m?(f=m,a+=3):(f=e,d===0&&v(kt)),f===e))))if(f=a,b=r.charAt(a),pe.test(b)?a++:(b=e,d===0&&v(_e)),b!==e){if(E=[],$=r.charAt(a),Me.test($)?a++:($=e,d===0&&v(De)),$!==e)for(;$!==e;)E.push($),$=r.charAt(a),Me.test($)?a++:($=e,d===0&&v(De));else E=e;E!==e?(b=[b,E],f=b):(a=f,f=e)}else a=f,f=e;return f!==e?(b=r.charAt(a),ht.test(b)?a++:(b=e,d===0&&v(At)),b===e&&(b=null),f=[f,b],l=f):(a=l,l=e),l!==e?n=r.substring(n,a):n=l,d--,n===e&&(l=e,d===0&&v(bt)),n}function as(){var n,l,f;for(d++,n=a,l=[],f=r.charAt(a),xe.test(f)?a++:(f=e,d===0&&v(Ue));f!==e;)l.push(f),l.length>=2?f=e:(f=r.charAt(a),xe.test(f)?a++:(f=e,d===0&&v(Ue)));return l.length<1?(a=n,n=e):n=l,d--,n===e&&(l=e,d===0&&v($t)),n}function Ze(){var n,l,f,b,E;if(d++,n=a,x(),r.charCodeAt(a)===36?(l=A,a++):(l=e,d===0&&v(Tt)),l!==e){if(f=a,b=[],E=r.charAt(a),te.test(E)?a++:(E=e,d===0&&v(se)),E!==e)for(;E!==e;)b.push(E),E=r.charAt(a),te.test(E)?a++:(E=e,d===0&&v(se));else b=e;b!==e?f=r.substring(f,a):f=b,f!==e?n=Wt(f):(a=n,n=e)}else a=n,n=e;return d--,n===e&&d===0&&v(yt),n}function ge(){var n;return n=ls(),n===e&&(n=fs()),n}function ls(){var n,l,f,b,E;if(d++,n=a,r.charCodeAt(a)===123?(l=y,a++):(l=e,d===0&&v(It)),l!==e){for(f=a,b=[],E=r.charAt(a),Oe.test(E)?a++:(E=e,d===0&&v(Be));E!==e;)b.push(E),E=r.charAt(a),Oe.test(E)?a++:(E=e,d===0&&v(Be));f=r.substring(f,a),r.charCodeAt(a)===125?(b=K,a++):(b=e,d===0&&v(Nt)),b!==e?n=Yt(f):(a=n,n=e)}else a=n,n=e;return d--,n===e&&(l=e,d===0&&v(wt)),n}function fs(){var n,l,f,b,E;if(d++,n=a,r.charCodeAt(a)===59?(l=ee,a++):(l=e,d===0&&v(Mt)),l!==e){for(f=a,b=[],E=r.charAt(a),Fe.test(E)?a++:(E=e,d===0&&v(Qe));E!==e;)b.push(E),E=r.charAt(a),Fe.test(E)?a++:(E=e,d===0&&v(Qe));f=r.substring(f,a),n=zt(f)}else a=n,n=e;return d--,n===e&&(l=e,d===0&&v(Pt)),n}function Je(){var n,l,f,b;return d++,n=a,x(),r.charCodeAt(a)===40?(l=ue,a++):(l=e,d===0&&v(Ot)),l!==e?(f=Ye(),f!==e?(x(),r.charCodeAt(a)===41?(b=ft,a++):(b=e,d===0&&v(Ft)),b!==e?n=Zt(f):(a=n,n=e)):(a=n,n=e)):(a=n,n=e),d--,n===e&&d===0&&v(xt),n}function cs(){var n,l,f;return d++,n=a,r.substr(a,3)===Te?(l=Te,a+=3):(l=e,d===0&&v(Lt)),l===e&&(r.substr(a,3)===we?(l=we,a+=3):(l=e,d===0&&v(Rt)),l===e&&(r.substr(a,7)===Ie?(l=Ie,a+=7):(l=e,d===0&&v(qt)),l===e&&(r.charCodeAt(a)===42?(l=ct,a++):(l=e,d===0&&v(Dt))))),l!==e?(x(),f=ge(),f===e&&(f=null),n=Jt(l,f)):(a=n,n=e),d--,n===e&&(l=e,d===0&&v(Kt)),n}function x(){var n,l;for(d++,n=[],l=r.charAt(a),Ke.test(l)?a++:(l=e,d===0&&v(Ge));l!==e;)n.push(l),l=r.charAt(a),Ke.test(l)?a++:(l=e,d===0&&v(Ge));return d--,l=e,d===0&&v(Ut),n}if(z=o(),t.peg$library)return{peg$result:z,peg$currPos:a,peg$FAILED:e,peg$maxFailExpected:re,peg$maxFailPos:L};if(z!==e&&a===r.length)return z;throw z!==e&&a<r.length&&v(Xt()),es(re,L<r.length?r.charAt(L):null,L<r.length?He(L,L+1):He(L,L))}const ae=0xffffffffffffffffn;function me(r,t){return(r<<t|r>>64n-t)&0xffffffffffffffffn}function Xe(r,t){return r*t&ae}function ms(r){return function(){let t=BigInt(r&ae),e=BigInt(r>>64n&ae);const s=Xe(me(Xe(t,5n),7n),9n);return e^=t,t=(me(t,24n)^e^e<<16n)&ae,e=me(e,37n),r=e<<64n|t,s}}const ce=ms(0xa187eb39cdcaed8f31c4b365b102e01en),vs=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>ce()))),bs=Array.from({length:8},()=>ce()),Es=Array.from({length:16},()=>ce()),ve=ce(),M="w",O="b",T="p",ke="n",le="b",J="r",B="q",w="k",be="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class ne{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(t,e){const{color:s,piece:i,from:o,to:h,flags:c,captured:u,promotion:_}=e,p=N(o),S=N(h);this.color=s,this.piece=i,this.from=p,this.to=S,this.san=t._moveToSan(e,t._moves({legal:!0})),this.lan=p+S,this.before=t.fen(),t._makeMove(e),this.after=t.fen(),t._undoMove(),this.flags="";for(const g in k)k[g]&c&&(this.flags+=G[g]);u&&(this.captured=u),_&&(this.promotion=_,this.lan+=_)}isCapture(){return this.flags.indexOf(G.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(G.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(G.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(G.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(G.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(G.BIG_PAWN)>-1}}const P=-1,G={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},k={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},Ae={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},Ss={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},Cs={...Ae,...Ss},C={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},Ee={b:[16,32,17,15],w:[-16,-32,-17,-15]},et={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},ks=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],As=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],$s={p:1,n:2,b:4,r:8,q:16,k:32},ys="pnbrqkPNBRQK",tt=[ke,le,J,B],Ts=7,ws=6,Is=1,Ns=0,oe={[w]:k.KSIDE_CASTLE,[B]:k.QSIDE_CASTLE},D={w:[{square:C.a1,flag:k.QSIDE_CASTLE},{square:C.h1,flag:k.KSIDE_CASTLE}],b:[{square:C.a8,flag:k.QSIDE_CASTLE},{square:C.h8,flag:k.KSIDE_CASTLE}]},Ps={b:Is,w:ws},Se="--";function j(r){return r>>4}function X(r){return r&15}function nt(r){return"0123456789".indexOf(r)!==-1}function N(r){const t=X(r),e=j(r);return"abcdefgh".substring(t,t+1)+"87654321".substring(e,e+1)}function Z(r){return r===M?O:M}function Ms(r){const t=r.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const e=parseInt(t[5],10);if(isNaN(e)||e<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const s=parseInt(t[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const i=t[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let h=0;h<i.length;h++){let c=0,u=!1;for(let _=0;_<i[h].length;_++)if(nt(i[h][_])){if(u)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};c+=parseInt(i[h][_],10),u=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[h][_]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};c+=1,u=!1}if(c!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const o=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:h,regex:c}of o){if(!c.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${h} king`};if((t[0].match(c)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${h} kings`}}return Array.from(i[0]+i[7]).some(h=>h.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function xs(r,t){const e=r.from,s=r.to,i=r.piece;let o=0,h=0,c=0;for(let u=0,_=t.length;u<_;u++){const p=t[u].from,S=t[u].to,g=t[u].piece;i===g&&e!==p&&s===S&&(o++,j(e)===j(p)&&h++,X(e)===X(p)&&c++)}return o>0?h>0&&c>0?N(e):c>0?N(e).charAt(1):N(e).charAt(0):""}function U(r,t,e,s,i,o=void 0,h=k.NORMAL){const c=j(s);if(i===T&&(c===Ts||c===Ns))for(let u=0;u<tt.length;u++){const _=tt[u];r.push({color:t,from:e,to:s,piece:i,captured:o,promotion:_,flags:h|k.PROMOTION})}else r.push({color:t,from:e,to:s,piece:i,captured:o,flags:h})}function st(r){let t=r.charAt(0);return t>="a"&&t<="h"?r.match(/[a-h]\d.*[a-h]\d/)?void 0:T:(t=t.toLowerCase(),t==="o"?w:t)}function Ce(r){return r.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class H{_board=new Array(128);_turn=M;_header={};_kings={w:P,b:P};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(t=be,{skipValidation:e=!1}={}){this.load(t,{skipValidation:e})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:P,b:P},this._turn=M,this._castling={w:0,b:0},this._epSquare=P,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...Cs},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:e=!1,preserveHeaders:s=!1}={}){let i=t.split(/\s+/);if(i.length>=2&&i.length<6){const c=["-","-","0","1"];t=i.concat(c.slice(-(6-i.length))).join(" ")}if(i=t.split(/\s+/),!e){const{ok:c,error:u}=Ms(t);if(!c)throw new Error(u)}const o=i[0];let h=0;this.clear({preserveHeaders:s});for(let c=0;c<o.length;c++){const u=o.charAt(c);if(u==="/")h+=8;else if(nt(u))h+=parseInt(u,10);else{const _=u<"a"?M:O;this._put({type:u.toLowerCase(),color:_},N(h)),h++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=k.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=k.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=k.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=k.QSIDE_CASTLE),this._epSquare=i[3]==="-"?P:C[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){let e=0,s="";for(let h=C.a8;h<=C.h1;h++){if(this._board[h]){e>0&&(s+=e,e=0);const{color:c,type:u}=this._board[h];s+=c===M?u.toUpperCase():u.toLowerCase()}else e++;h+1&136&&(e>0&&(s+=e),h!==C.h1&&(s+="/"),e=0,h+=8)}let i="";this._castling[M]&k.KSIDE_CASTLE&&(i+="K"),this._castling[M]&k.QSIDE_CASTLE&&(i+="Q"),this._castling[O]&k.KSIDE_CASTLE&&(i+="k"),this._castling[O]&k.QSIDE_CASTLE&&(i+="q"),i=i||"-";let o="-";if(this._epSquare!==P)if(t)o=N(this._epSquare);else{const h=this._epSquare+(this._turn===M?16:-16),c=[h+1,h-1];for(const u of c){if(u&136)continue;const _=this._turn;if(this._board[u]?.color===_&&this._board[u]?.type===T){this._makeMove({color:_,from:u,to:this._epSquare,piece:T,captured:T,flags:k.EP_CAPTURE});const p=!this._isKingAttacked(_);if(this._undoMove(),p){o=N(this._epSquare);break}}}}return[s,this._turn,i,o,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;const{color:e,type:s}=this._board[t],i={w:0,b:1}[e],o={p:0,n:1,b:2,r:3,q:4,k:5}[s];return vs[i][o][t]}_epKey(){return this._epSquare===P?0n:bs[this._epSquare&7]}_castlingKey(){const t=this._castling.w>>5|this._castling.b>>3;return Es[t]}_computeHash(){let t=0n;for(let e=C.a8;e<=C.h1;e++){if(e&136){e+=7;continue}this._board[e]&&(t^=this._pieceKey(e))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=ve),t}_updateSetup(t){this._history.length>0||(t!==be?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(be)}get(t){return this._board[C[t]]}findPiece(t){const e=[];for(let s=C.a8;s<=C.h1;s++){if(s&136){s+=7;continue}!this._board[s]||this._board[s]?.color!==t.color||this._board[s].color===t.color&&this._board[s].type===t.type&&e.push(N(s))}return e}put({type:t,color:e},s){return this._put({type:t,color:e},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,e){this._hash^=this._pieceKey(t),this._board[t]=e,this._hash^=this._pieceKey(t)}_put({type:t,color:e},s){if(ys.indexOf(t.toLowerCase())===-1||!(s in C))return!1;const i=C[s];if(t==w&&!(this._kings[e]==P||this._kings[e]==i))return!1;const o=this._board[i];return o&&o.type===w&&(this._kings[o.color]=P),this._set(i,{type:t,color:e}),t===w&&(this._kings[e]=i),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){const e=this.get(t);return this._clear(C[t]),e&&e.type===w&&(this._kings[e.color]=P),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),e}_updateCastlingRights(){this._hash^=this._castlingKey();const t=this._board[C.e1]?.type===w&&this._board[C.e1]?.color===M,e=this._board[C.e8]?.type===w&&this._board[C.e8]?.color===O;(!t||this._board[C.a1]?.type!==J||this._board[C.a1]?.color!==M)&&(this._castling.w&=-65),(!t||this._board[C.h1]?.type!==J||this._board[C.h1]?.color!==M)&&(this._castling.w&=-33),(!e||this._board[C.a8]?.type!==J||this._board[C.a8]?.color!==O)&&(this._castling.b&=-65),(!e||this._board[C.h8]?.type!==J||this._board[C.h8]?.color!==O)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare===P)return;const t=this._epSquare+(this._turn===M?-16:16),e=this._epSquare+(this._turn===M?16:-16),s=[e+1,e-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||this._board[e]?.color!==Z(this._turn)||this._board[e]?.type!==T){this._hash^=this._epKey(),this._epSquare=P;return}const i=o=>!(o&136)&&this._board[o]?.color===this._turn&&this._board[o]?.type===T;s.some(i)||(this._hash^=this._epKey(),this._epSquare=P)}_attacked(t,e,s){const i=[];for(let o=C.a8;o<=C.h1;o++){if(o&136){o+=7;continue}if(this._board[o]===void 0||this._board[o].color!==t)continue;const h=this._board[o],c=o-e;if(c===0)continue;const u=c+119;if(ks[u]&$s[h.type]){if(h.type===T){if(c>0&&h.color===M||c<=0&&h.color===O)if(s)i.push(N(o));else return!0;continue}if(h.type==="n"||h.type==="k")if(s){i.push(N(o));continue}else return!0;const _=As[u];let p=o+_,S=!1;for(;p!==e;){if(this._board[p]!=null){S=!0;break}p+=_}if(!S)if(s){i.push(N(o));continue}else return!0}}return s?i:!1}attackers(t,e){return e?this._attacked(e,C[t],!0):this._attacked(this._turn,C[t],!0)}_isKingAttacked(t){const e=this._kings[t];return e===-1?!1:this._attacked(Z(t),e)}hash(){return this._hash.toString(16)}isAttacked(t,e){return this._attacked(e,C[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const t={b:0,n:0,r:0,q:0,k:0,p:0},e=[];let s=0,i=0;for(let o=C.a8;o<=C.h1;o++){if(i=(i+1)%2,o&136){o+=7;continue}const h=this._board[o];h&&(t[h.type]=h.type in t?t[h.type]+1:1,h.type===le&&e.push(i),s++)}if(s===2)return!0;if(s===3&&(t[le]===1||t[ke]===1))return!0;if(s===t[le]+2){let o=0;const h=e.length;for(let c=0;c<h;c++)o+=e[c];if(o===0||o===h)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:e=void 0,piece:s=void 0}={}){const i=this._moves({square:e,piece:s});return t?i.map(o=>new ne(this,o)):i.map(o=>this._moveToSan(o,i))}_moves({legal:t=!0,piece:e=void 0,square:s=void 0}={}){const i=s?s.toLowerCase():void 0,o=e?.toLowerCase(),h=[],c=this._turn,u=Z(c);let _=C.a8,p=C.h1,S=!1;if(i)if(i in C)_=p=C[i],S=!0;else return[];for(let m=_;m<=p;m++){if(m&136){m+=7;continue}if(!this._board[m]||this._board[m].color===u)continue;const{type:A}=this._board[m];let y;if(A===T){if(o&&o!==A)continue;y=m+Ee[c][0],this._board[y]||(U(h,c,m,y,T),y=m+Ee[c][1],Ps[c]===j(m)&&!this._board[y]&&U(h,c,m,y,T,void 0,k.BIG_PAWN));for(let K=2;K<4;K++)y=m+Ee[c][K],!(y&136)&&(this._board[y]?.color===u?U(h,c,m,y,T,this._board[y].type,k.CAPTURE):y===this._epSquare&&U(h,c,m,y,T,T,k.EP_CAPTURE))}else{if(o&&o!==A)continue;for(let K=0,ee=et[A].length;K<ee;K++){const ue=et[A][K];for(y=m;y+=ue,!(y&136);){if(!this._board[y])U(h,c,m,y,A);else{if(this._board[y].color===c)break;U(h,c,m,y,A,this._board[y].type,k.CAPTURE);break}if(A===ke||A===w)break}}}}if((o===void 0||o===w)&&(!S||p===this._kings[c])){if(this._castling[c]&k.KSIDE_CASTLE){const m=this._kings[c],A=m+2;!this._board[m+1]&&!this._board[A]&&!this._attacked(u,this._kings[c])&&!this._attacked(u,m+1)&&!this._attacked(u,A)&&U(h,c,this._kings[c],A,w,void 0,k.KSIDE_CASTLE)}if(this._castling[c]&k.QSIDE_CASTLE){const m=this._kings[c],A=m-2;!this._board[m-1]&&!this._board[m-2]&&!this._board[m-3]&&!this._attacked(u,this._kings[c])&&!this._attacked(u,m-1)&&!this._attacked(u,A)&&U(h,c,this._kings[c],A,w,void 0,k.QSIDE_CASTLE)}}if(!t||this._kings[c]===-1)return h;const g=[];for(let m=0,A=h.length;m<A;m++)this._makeMove(h[m]),this._isKingAttacked(c)||g.push(h[m]),this._undoMove();return g}move(t,{strict:e=!1}={}){let s=null;if(typeof t=="string")s=this._moveFromSan(t,e);else if(t===null)s=this._moveFromSan(Se,e);else if(typeof t=="object"){const o=this._moves();for(let h=0,c=o.length;h<c;h++)if(t.from===N(o[h].from)&&t.to===N(o[h].to)&&(!("promotion"in o[h])||t.promotion===o[h].promotion)){s=o[h];break}}if(!s)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&s.flags&k.NULL_MOVE)throw new Error("Null move not allowed when in check");const i=new ne(this,s);return this._makeMove(s),this._incPositionCount(),i}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,e){this._hash^=this._pieceKey(t),this._board[e]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(e)}_makeMove(t){const e=this._turn,s=Z(e);if(this._push(t),t.flags&k.NULL_MOVE){e===O&&this._moveNumber++,this._halfMoves++,this._turn=s,this._epSquare=P;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&k.EP_CAPTURE&&(this._turn===O?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:e})),this._board[t.to].type===w){if(this._kings[e]=t.to,t.flags&k.KSIDE_CASTLE){const i=t.to-1,o=t.to+1;this._movePiece(o,i)}else if(t.flags&k.QSIDE_CASTLE){const i=t.to+1,o=t.to-2;this._movePiece(o,i)}this._castling[e]=0}if(this._castling[e]){for(let i=0,o=D[e].length;i<o;i++)if(t.from===D[e][i].square&&this._castling[e]&D[e][i].flag){this._castling[e]^=D[e][i].flag;break}}if(this._castling[s]){for(let i=0,o=D[s].length;i<o;i++)if(t.to===D[s][i].square&&this._castling[s]&D[s][i].flag){this._castling[s]^=D[s][i].flag;break}}if(this._hash^=this._castlingKey(),t.flags&k.BIG_PAWN){let i;e===O?i=t.to-16:i=t.to+16,!(t.to-1&136)&&this._board[t.to-1]?.type===T&&this._board[t.to-1]?.color===s||!(t.to+1&136)&&this._board[t.to+1]?.type===T&&this._board[t.to+1]?.color===s?(this._epSquare=i,this._hash^=this._epKey()):this._epSquare=P}else this._epSquare=P;t.piece===T?this._halfMoves=0:t.flags&(k.CAPTURE|k.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,e===O&&this._moveNumber++,this._turn=s,this._hash^=ve}undo(){const t=this._hash,e=this._undoMove();if(e){const s=new ne(this,e);return this._decPositionCount(t),s}return null}_undoMove(){const t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();const e=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=ve;const s=this._turn,i=Z(s);if(e.flags&k.NULL_MOVE)return e;if(this._movePiece(e.to,e.from),e.piece&&(this._clear(e.from),this._set(e.from,{type:e.piece,color:s})),e.captured)if(e.flags&k.EP_CAPTURE){let o;s===O?o=e.to-16:o=e.to+16,this._set(o,{type:T,color:i})}else this._set(e.to,{type:e.captured,color:i});if(e.flags&(k.KSIDE_CASTLE|k.QSIDE_CASTLE)){let o,h;e.flags&k.KSIDE_CASTLE?(o=e.to+1,h=e.to-1):(o=e.to-2,h=e.to+1),this._movePiece(h,o)}return e}pgn({newline:t=`
`,maxWidth:e=0}={}){const s=[];let i=!1;for(const g in this._header)this._header[g]&&s.push(`[${g} "${this._header[g]}"]`+t),i=!0;i&&this._history.length&&s.push(t);const o=g=>{const m=this._comments[this.fen()];if(typeof m<"u"){const A=g.length>0?" ":"";g=`${g}${A}{${m}}`}return g},h=[];for(;this._history.length>0;)h.push(this._undoMove());const c=[];let u="";for(h.length===0&&c.push(o(""));h.length>0;){u=o(u);const g=h.pop();if(!g)break;if(!this._history.length&&g.color==="b"){const m=`${this._moveNumber}. ...`;u=u?`${u} ${m}`:m}else g.color==="w"&&(u.length&&c.push(u),u=this._moveNumber+".");u=u+" "+this._moveToSan(g,this._moves({legal:!0})),this._makeMove(g)}if(u.length&&c.push(o(u)),c.push(this._header.Result||"*"),e===0)return s.join("")+c.join(" ");const _=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},p=function(g,m){for(const A of m.split(" "))if(A){if(g+A.length>e){for(;_();)g--;s.push(t),g=0}s.push(A),g+=A.length,s.push(" "),g++}return _()&&g--,g};let S=0;for(let g=0;g<c.length;g++){if(S+c[g].length>e&&c[g].includes("{")){S=p(S,c[g]);continue}S+c[g].length>e&&g!==0?(s[s.length-1]===" "&&s.pop(),s.push(t),S=0):g!==0&&(s.push(" "),S++),s.push(c[g]),S+=c[g].length}return s.join("")}header(...t){for(let e=0;e<t.length;e+=2)typeof t[e]=="string"&&typeof t[e+1]=="string"&&(this._header[t[e]]=t[e+1]);return this._header}setHeader(t,e){return this._header[t]=e??Ae[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=Ae[t]||null,!0):!1}getHeaders(){const t={};for(const[e,s]of Object.entries(this._header))s!==null&&(t[e]=s);return t}loadPgn(t,{strict:e=!1,newlineChar:s=`\r?
`}={}){s!==`\r?
`&&(t=t.replace(new RegExp(s,"g"),`
`));const i=ds(t);this.reset();const o=i.headers;let h="";for(const _ in o)_.toLowerCase()==="fen"&&(h=o[_]),this.header(_,o[_]);if(!e)h&&this.load(h,{preserveHeaders:!0});else if(o.SetUp==="1"){if(!("FEN"in o))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(o.FEN,{preserveHeaders:!0})}let c=i.root;for(;c;){if(c.move){const _=this._moveFromSan(c.move,e);if(_==null)throw new Error(`Invalid move in PGN: ${c.move}`);this._makeMove(_),this._incPositionCount()}c.comment!==void 0&&(this._comments[this.fen()]=c.comment),c=c.variations[0]}const u=i.result;u&&Object.keys(this._header).length&&this._header.Result!==u&&this.setHeader("Result",u)}_moveToSan(t,e){let s="";if(t.flags&k.KSIDE_CASTLE)s="O-O";else if(t.flags&k.QSIDE_CASTLE)s="O-O-O";else{if(t.flags&k.NULL_MOVE)return Se;if(t.piece!==T){const i=xs(t,e);s+=t.piece.toUpperCase()+i}t.flags&(k.CAPTURE|k.EP_CAPTURE)&&(t.piece===T&&(s+=N(t.from)[0]),s+="x"),s+=N(t.to),t.promotion&&(s+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(t,e=!1){let s=Ce(t);if(e||(s==="0-0"?s="O-O":s==="0-0-0"&&(s="O-O-O")),s==Se)return{color:this._turn,from:0,to:0,piece:"k",flags:k.NULL_MOVE};let i=st(s),o=this._moves({legal:!0,piece:i});for(let g=0,m=o.length;g<m;g++)if(s===Ce(this._moveToSan(o[g],o)))return o[g];if(e)return null;let h,c,u,_,p,S=!1;if(c=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),c?(h=c[1],u=c[2],_=c[3],p=c[4],u.length==1&&(S=!0)):(c=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),c&&(h=c[1],u=c[2],_=c[3],p=c[4],u.length==1&&(S=!0))),i=st(s),o=this._moves({legal:!0,piece:h||i}),!_)return null;for(let g=0,m=o.length;g<m;g++)if(u){if((!h||h.toLowerCase()==o[g].piece)&&C[u]==o[g].from&&C[_]==o[g].to&&(!p||p.toLowerCase()==o[g].promotion))return o[g];if(S){const A=N(o[g].from);if((!h||h.toLowerCase()==o[g].piece)&&C[_]==o[g].to&&(u==A[0]||u==A[1])&&(!p||p.toLowerCase()==o[g].promotion))return o[g]}}else if(s===Ce(this._moveToSan(o[g],o)).replace("x",""))return o[g];return null}ascii(){let t=`   +------------------------+
`;for(let e=C.a8;e<=C.h1;e++){if(X(e)===0&&(t+=" "+"87654321"[j(e)]+" |"),this._board[e]){const s=this._board[e].type,o=this._board[e].color===M?s.toUpperCase():s.toLowerCase();t+=" "+o+" "}else t+=" . ";e+1&136&&(t+=`|
`,e+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){const e=this._moves({legal:!1});let s=0;const i=this._turn;for(let o=0,h=e.length;o<h;o++)this._makeMove(e[o]),this._isKingAttacked(i)||(t-1>0?s+=this.perft(t-1):s++),this._undoMove();return s}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){const t=[];let e=[];for(let s=C.a8;s<=C.h1;s++)this._board[s]==null?e.push(null):e.push({square:N(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(t.push(e),e=[],s+=8);return t}squareColor(t){if(t in C){const e=C[t];return(j(e)+X(e))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){const e=[],s=[];for(;this._history.length>0;)e.push(this._undoMove());for(;;){const i=e.pop();if(!i)break;t?s.push(new ne(this,i)):s.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return s}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){const e=this._positionCount.get(t)??0;e===1?this._positionCount.delete(t):this._positionCount.set(t,e-1)}_pruneComments(){const t=[],e={},s=i=>{i in this._comments&&(e[i]=this._comments[i])};for(;this._history.length>0;)t.push(this._undoMove());for(s(this.fen());;){const i=t.pop();if(!i)break;this._makeMove(i),s(this.fen())}this._comments=e}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{const e=this._comments[t];return delete this._comments[t],{fen:t,comment:e}})}setCastlingRights(t,e){for(const i of[w,B])e[i]!==void 0&&(e[i]?this._castling[t]|=oe[i]:this._castling[t]&=~oe[i]);this._updateCastlingRights();const s=this.getCastlingRights(t);return(e[w]===void 0||e[w]===s[w])&&(e[B]===void 0||e[B]===s[B])}getCastlingRights(t){return{[w]:(this._castling[t]&oe[w])!==0,[B]:(this._castling[t]&oe[B])!==0}}moveNumber(){return this._moveNumber}}const ot=["a","b","c","d","e","f","g","h"],$e="start",Os=.08,fe={p:100,n:320,b:330,r:500,q:900,k:0},Fs=[0,0,0,0,0,0,0,0,40,40,40,45,45,40,40,40,18,18,25,35,35,25,18,18,8,10,14,24,24,14,10,8,4,8,12,20,20,12,8,4,4,4,8,10,10,8,4,4,5,6,6,-8,-8,6,6,5,0,0,0,0,0,0,0,0],Ks=[-50,-40,-30,-30,-30,-30,-40,-50,-40,-20,0,2,2,0,-20,-40,-30,2,10,15,15,10,2,-30,-30,4,15,20,20,15,4,-30,-30,2,15,20,20,15,2,-30,-30,4,10,15,15,10,4,-30,-40,-20,0,4,4,0,-20,-40,-50,-40,-30,-30,-30,-30,-40,-50],Ls=[-20,-12,-10,-10,-10,-10,-12,-20,-12,4,0,0,0,0,4,-12,-10,0,8,10,10,8,0,-10,-10,2,10,10,10,10,2,-10,-10,2,10,10,10,10,2,-10,-10,0,8,10,10,8,0,-10,-12,4,0,0,0,0,4,-12,-20,-12,-10,-10,-10,-10,-12,-20],Rs=[0,0,4,8,8,4,0,0,-4,0,0,0,0,0,0,-4,-4,0,0,0,0,0,0,-4,-4,0,0,0,0,0,0,-4,-4,0,0,0,0,0,0,-4,-4,0,0,0,0,0,0,-4,4,12,12,12,12,12,12,4,0,0,4,8,8,4,0,0],qs=[-20,-10,-10,-5,-5,-10,-10,-20,-10,0,0,0,0,0,0,-10,-10,0,5,5,5,5,0,-10,-5,0,5,5,5,5,0,-5,-5,0,5,5,5,5,0,-5,-10,5,5,5,5,5,0,-10,-10,0,5,0,0,0,0,-10,-20,-10,-10,-5,-5,-10,-10,-20],Ds=[-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-20,-30,-30,-40,-40,-30,-30,-20,-10,-20,-20,-20,-20,-20,-20,-10,20,20,0,0,0,0,20,20,20,30,10,0,0,10,30,20],Us={p:Fs,n:Ks,b:Ls,r:Rs,q:qs,k:Ds},Bs=r=>{const t=r[0]??"",e=Number.parseInt(r[1]??"",10),s=ot.indexOf(t);return s<0||e<1||e>8?-1:(8-e)*8+s},Qs=r=>{const t=Math.floor(r/8),e=r%8;return(7-t)*8+e},Gs=r=>r.color==="w"?r.type.toUpperCase():r.type,at=r=>r==="w"?"white":"black",he=r=>r==="white"?"w":"b",V=(r=$e)=>r===$e?new H:new H(r),q=r=>({from:r.from,to:r.to,piece:r.color==="w"?r.piece.toUpperCase():r.piece,capture:r.captured?r.color==="w"?r.captured:r.captured.toUpperCase():void 0,promotion:r.promotion,san:r.san}),js=(r,t)=>{const e=r.get(t.from);return!e||e.type!=="p"?!1:t.to.endsWith("1")||t.to.endsWith("8")},lt=(r,t)=>{const e={from:t.from,to:t.to};if(t.promotion)return r.move({...e,promotion:t.promotion});const s=r.move(e);return s||(js(r,t)?r.move({...e,promotion:"q"}):null)},rt=(r,t)=>{let e=0;const s=r.board();for(let i=0;i<s.length;i+=1){const o=s[i];if(o)for(let h=0;h<o.length;h+=1){const c=o[h];if(!c)continue;const u=`${ot[h]??"a"}${8-i}`,_=Bs(u),p=Us[c.type],S=_>=0?p[c.color==="w"?_:Qs(_)]??0:0,m=fe[c.type]+S*Os;e+=c.color===he(t)?m:-m}}return e},Hs=(r,t)=>r.isGameOver()?r.isCheckmate()?r.turn()===he(t)?-1e5:1e5:0:null,ye=(r,t,e,s,i,o)=>{const h=Hs(r,o);if(h!==null)return h;if(t<=0)return rt(r,o);const c=r.moves({verbose:!0});if(!c.length)return rt(r,o);if(i){let _=Number.NEGATIVE_INFINITY;for(const p of c){const S=new H(r.fen());if(S.move(p),_=Math.max(_,ye(S,t-1,e,s,!1,o)),e=Math.max(e,_),e>=s)break}return _}let u=Number.POSITIVE_INFINITY;for(const _ of c){const p=new H(r.fen());if(p.move(_),u=Math.min(u,ye(p,t-1,e,s,!0,o)),s=Math.min(s,u),s<=e)break}return u},Vs=r=>r==="facile"?0:r==="intermediaire"?1:r==="difficile"?2:3,it=r=>r.captured?(fe[r.captured]??0)*.4:0,Ws=(r,t)=>{if(t==="agressif"){const e=r.san.includes("+")||r.san.includes("#")?60:0;return it(r)+e}if(t==="solide"){const e=r.san.includes("+")?-5:0;return it(r)*.25+e}return 0},Ys=()=>$e,zs=r=>V(r).board().map(e=>e.map(s=>s?Gs(s):"")),Zs=r=>{try{return V(r),!0}catch{return!1}},Js=r=>{const t=V(r);return at(t.turn())},Xs=(r,t)=>{const e=V(r);return t&&e.turn()!==he(t)?[]:e.moves({verbose:!0}).map(q)},er=(r,t)=>{const e=V(r),s=lt(e,t);return s?{fen:e.fen(),move:q(s)}:{fen:r,move:null}},tr=r=>r.san??`${r.from}-${r.to}`,sr=r=>{const t=V(r),e=at(t.turn()),s=t.isCheckmate(),i=t.isStalemate(),o=t.isThreefoldRepetition(),h=t.isInsufficientMaterial(),c=t.isDrawByFiftyMoves(),u=t.isDraw()||i||o||h||c;let _=null,p=null;return s?(_=e==="white"?"black":"white",p="checkmate"):i?p="stalemate":o?p="threefold-repetition":h?p="insufficient-material":c?p="fifty-moves":u&&(p="draw"),{turn:e,inCheck:t.inCheck(),isCheckmate:s,isStalemate:i,isDraw:u,isThreefoldRepetition:o,isInsufficientMaterial:h,isFiftyMoves:c,isGameOver:t.isGameOver(),winner:_,reason:p}},rr=r=>{const t=new H;for(const e of r)if(!lt(t,e))break;return t.pgn()},ir=r=>{const t=new H;try{t.loadPgn(r,{strict:!1})}catch(s){return{ok:!1,error:s.message}}const e=t.history({verbose:!0}).map(q);return{ok:!0,fen:t.fen(),moves:e,pgn:t.pgn()}},nr=(r,t,e,s="equilibre")=>{const i=V(r);if(i.turn()!==he(t))return null;const o=i.moves({verbose:!0});if(!o.length)return null;if(s==="fou"){const p=o[Math.floor(Math.random()*o.length)];return p?q(p):null}if(e==="facile"){const p=o[Math.floor(Math.random()*o.length)]??null;return p?q(p):null}if(e==="intermediaire"){const p=o.filter(A=>!!A.captured),g=[...p.length?p:o].sort((A,y)=>{const K=A.captured?fe[A.captured]:0;return(y.captured?fe[y.captured]:0)-K});if(s==="agressif")return g[0]?q(g[0]):null;const m=g[Math.floor(Math.random()*Math.min(g.length,3))]??g[0];return m?q(m):null}const h=Vs(e);let c=Number.NEGATIVE_INFINITY,u=[];for(const p of o){const S=new H(i.fen());S.move(p);const g=ye(S,Math.max(0,h-1),Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,!1,t)+Ws(p,s);g>c?(c=g,u=[p]):g===c&&u.push(p)}if(s==="solide"){const p=u[0]??o[0]??null;return p?q(p):null}const _=u[Math.floor(Math.random()*u.length)]??o[0]??null;return _?q(_):null};export{H as C,Js as a,sr as b,Ys as c,Xs as d,rr as e,zs as f,nr as g,tr as h,Zs as i,er as j,ir as l};
